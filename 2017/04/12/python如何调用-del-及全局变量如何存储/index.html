<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description" content="Vulnerability|Security|Binary"/><title>python如何调用__del__及全局变量如何存储 | WeaponX's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/highlight.css"/><link rel="stylesheet" type="text/css" href="/css/font.css"/><link rel="stylesheet" type="text/css" href="/css/noise.css"/><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/python/">python</a></div><div class="post-time">2017-04-12</div></div></div><div class="container post-header"><h1>python如何调用__del__及全局变量如何存储</h1></div><div class="container post-content"><p>在处理一个bug的时候发现程序一直报错，<code>Exception exceptions.NameError: &quot;global name &#39;TEST&#39; is not defined&quot;</code>。仔细审查了下源码，发现这个<code>TEST</code>变量是个全局变量，已经定义了。只不过在类的析构函数<code>__del__()</code>中解引用了<code>del TEST</code>。</p>
<p>这引出了两个问题：</p>
<ol>
<li>一个类的对象，什么时候调用析构函数？</li>
<li>为什么一个对象把<code>TEST</code>解引用了其他对象也无法访问？</li>
</ol>
<a id="more"></a>
<h2 id="Q1"><a href="#Q1" class="headerlink" title="Q1"></a>Q1</h2><p>在C/C++中，需要程序员自己完成垃圾回收。而在python中，是python自己完成垃圾回收工作的。在python中每个变量都有一个引用计数器来表示这个变量被引用的次数。当这个计数器为0的时候，python就会对这个变量进行垃圾回收（也就是调用类中的析构函数<code>__del__()</code>）。</p>
<p>下面有一个示例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span><span class="params">()</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"This is Init Function"</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"This is Del Function"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></div><div class="line">    t = Test()</div><div class="line">    <span class="keyword">print</span> <span class="string">"Boom shakalaka"</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">"Before run test()"</span></div><div class="line">    test()</div><div class="line">    <span class="keyword">print</span> <span class="string">"After run test()"</span></div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">"Before Create Object"</span></div><div class="line">    t1 = Test()</div><div class="line">    <span class="keyword">print</span> <span class="string">"After Create Object"</span></div></pre></td></tr></table></figure>
<p>我们看看执行后的结果</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Before run <span class="built_in">test</span>()</div><div class="line">This is Init Function</div><div class="line">Boom shakalaka</div><div class="line">This is Del Function</div><div class="line">After run <span class="built_in">test</span>()</div><div class="line">Before Create Object</div><div class="line">This is Init Function</div><div class="line">After Create Object</div><div class="line">This is Del Function</div></pre></td></tr></table></figure>
<p>在执行<code>test()</code>函数的时候执行完成后，Test()的对象t被回收，调用析构函数<code>__del__</code>打印<code>This is Del Function</code>。</p>
<h2 id="Q2"><a href="#Q2" class="headerlink" title="Q2"></a>Q2</h2><p>在python中，全局变量使用共享内存的方式实现的。若一个对象解引用后，其他所有对象均无法访问。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span><span class="params">()</span>:</span></div><div class="line">    name = <span class="string">"test"</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">del</span> Test.name</div><div class="line">        <span class="keyword">print</span> <span class="string">"This is Del Function"</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    t1 = Test()</div><div class="line">    t2 = Test()</div></pre></td></tr></table></figure>
<p>执行后会报错</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">This is Del Function</div><div class="line">Exception AttributeError: <span class="string">"'NoneType' object has no attribute 'name'"</span> <span class="keyword">in</span> &lt;bound method Test.__del__ of &lt;__main__.Test instance at 0x7f4dde73fd40&gt;&gt; ignored</div></pre></td></tr></table></figure>
<p>原因是在清除t1的时候对全局变量name解引用，导致t2调用析构函数时候访问异常。</p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"/><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>