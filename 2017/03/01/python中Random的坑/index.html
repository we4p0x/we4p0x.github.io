<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description" content="Vulnerability|Security|Binary"/><title>python中Random的坑 | WeaponX's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/highlight.css"/><link rel="stylesheet" type="text/css" href="/css/font.css"/><link rel="stylesheet" type="text/css" href="/css/noise.css"/><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/python/">python</a><a class="post-tag-link" href="/tags/安全/">安全</a></div><div class="post-time">2017-03-01</div></div></div><div class="container post-header"><h1>python中Random的坑</h1></div><div class="container post-content"><h2 id="0x00-前景提要"><a href="#0x00-前景提要" class="headerlink" title="0x00 前景提要"></a>0x00 前景提要</h2><p>在搬砖过程中遇到一个巨坑，有一个python模块实现了一个本地监听多个端口的功能，为了防止监听端口冲突端口使用了python中的<code>random</code>模块中的<code>randint</code>函数来实现随机端口的生成。然而两次调用后却发现一直报<code>error: [Errno 98] Address already in use</code>，明显就是端口被占用。这个就比较奇怪了，因为该模块一次监听5个端口。怎么可能5个端口都会有冲突。</p>
<a id="more"></a>
<h2 id="0x01-排查"><a href="#0x01-排查" class="headerlink" title="0x01 排查"></a>0x01 排查</h2><p>首先想到的就是<code>random</code>是否为伪随机，在查阅了以后发现</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Warning The pseudo-random generators of this module should not be used <span class="keyword">for</span> security purposes. Use os.urandom() or SystemRandom <span class="keyword">if</span> you require a cryptographically secure pseudo-random number generator.</div></pre></td></tr></table></figure>
<p>确实是伪随机，但是默认随机数生成种子是从<code>/dev/urandom</code>或者是系统时间戳获取的。两次调用也不会是同时调用的，所以种子肯定不会是一样的。</p>
<p>后来经大神提醒有了点眉目，因为两个进程的父进程是同一个进程。进程在导入random模块的时候种子已经选好了。所以不同子进程生成的随机数序列肯定是一样的。</p>
<p>下面写个python验证下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line"><span class="keyword">if</span> os.fork() == <span class="number">0</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">"[rand 1] %d"</span> % random.randint(<span class="number">1</span>,<span class="number">100</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">"[rand 1] %d"</span> % random.randint(<span class="number">1</span>,<span class="number">100</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">"[rand 1] %d"</span> % random.randint(<span class="number">1</span>,<span class="number">100</span>)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">"[rand 2] %d"</span> % random.randint(<span class="number">1</span>,<span class="number">100</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">"[rand 2] %d"</span> % random.randint(<span class="number">1</span>,<span class="number">100</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">"[rand 2] %d"</span> % random.randint(<span class="number">1</span>,<span class="number">100</span>)</div></pre></td></tr></table></figure>
<p>通过执行结果可以发现，确实证实了猜测</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">~ » python test.py</div><div class="line">[rand 2] 51</div><div class="line">[rand 2] 58</div><div class="line">[rand 2] 31</div><div class="line">[rand 1] 51</div><div class="line">[rand 1] 58</div><div class="line">[rand 1] 31</div></pre></td></tr></table></figure>
<h2 id="0x02-解决"><a href="#0x02-解决" class="headerlink" title="0x02 解决"></a>0x02 解决</h2><p>知道了原因，要解决就很简单了。只要在生成随即数的时候重置种子就可以了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line"><span class="keyword">if</span> os.fork() == <span class="number">0</span>:</div><div class="line">    random.seed()</div><div class="line">    <span class="keyword">print</span> <span class="string">"[rand 1] %d"</span> % random.randint(<span class="number">1</span>,<span class="number">100</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">"[rand 1] %d"</span> % random.randint(<span class="number">1</span>,<span class="number">100</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">"[rand 1] %d"</span> % random.randint(<span class="number">1</span>,<span class="number">100</span>)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    random.seed()</div><div class="line">    <span class="keyword">print</span> <span class="string">"[rand 2] %d"</span> % random.randint(<span class="number">1</span>,<span class="number">100</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">"[rand 2] %d"</span> % random.randint(<span class="number">1</span>,<span class="number">100</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">"[rand 2] %d"</span> % random.randint(<span class="number">1</span>,<span class="number">100</span>)</div></pre></td></tr></table></figure>
<p>结果也证实了这种解决方案可行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">~ » python test.py</div><div class="line">[rand 2] 7</div><div class="line">[rand 2] 52</div><div class="line">[rand 2] 43</div><div class="line">[rand 1] 16</div><div class="line">[rand 1] 70</div><div class="line">[rand 1] 97</div></pre></td></tr></table></figure>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"/><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>