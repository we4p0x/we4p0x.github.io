<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>哈希长度扩展攻击 | WeaponX&#39;s Blog</title>
  <meta name="author" content="WeaponX">
  
  <meta name="description" content="Vulnerability|Security|Binary">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="哈希长度扩展攻击"/>
  <meta property="og:site_name" content="WeaponX&#39;s Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="WeaponX&#39;s Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

  <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?ab50f379bb6434641ee0125ce5d37f23";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
  </script>
  <script>
  (function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
   })();
   </script>
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">WeaponX&#39;s Blog</a></h1>
  <h2><a href="/">Binary</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-01-16T13:07:07.000Z"><a href="/2017/01/16/哈希长度扩展攻击/">2017-01-16</a></time>
      
      
  
    <h1 class="title">哈希长度扩展攻击</h1>
  

    </header>
    <div class="entry">
      
        <h2 id="0x00-简介"><a href="#0x00-简介" class="headerlink" title="0x00 简介"></a>0x00 简介</h2><blockquote>
<p>Hash，一般翻译做“散列”，也有直接音译为“哈希”的，就是把任意长度的输入（又叫做预映射， pre-image），通过散列算法，变换成固定长度的输出，该输出就是散列值。这种转换是一种压缩映射，也就是，散列值的空间通常远小于输入的空间，不同的输入可能会散列成相同的输出，所以不可能从散列值来唯一的确定输入值。简单的说就是一种将任意长度的消息压缩到某一固定长度的消息摘要的函数。</p>
</blockquote>
<p>–摘自百度</p>
<p>哈希长度扩展攻击简单的来讲就是：<br>1.知道一个密文(SECRET)的哈希<br>2.知道密文的长度(SECRET LENGTH)<br>在不知道密文的情况下可以推算出密文+填充+追加消息(SECRET+PADDING+EXTRA)的哈希，也就是说在只知道密文长度和密文哈希的情况下，可以预测出密文和另一消息拼接后的哈希。</p>
<a id="more"></a>
<h2 id="0x01-理解哈希算法流程"><a href="#0x01-理解哈希算法流程" class="headerlink" title="0x01 理解哈希算法流程"></a>0x01 理解哈希算法流程</h2><p>易受哈希长度扩展攻击的哈希算法：SHA系列和MD系列。这两个系列的哈希算法都有一个共同点——基于Merkle–Damgård构造。</p>
<p><img src="http://i.imgur.com/vwapHAd.png" alt=""></p>
<p>上图可以看出，Merkle–Damgård算法的流程如下：</p>
<ol>
<li>把消息划分为n个消息块</li>
<li>对最后一个消息块做长度填充</li>
<li>每个消息块都会和一个输入向量做一个运算，把这个计算结果当成下个消息块的输入向量</li>
</ol>
<h2 id="0x02-理解MD5算法流程"><a href="#0x02-理解MD5算法流程" class="headerlink" title="0x02 理解MD5算法流程"></a>0x02 理解MD5算法流程</h2><p>了解了Merkle–Damgård算法的流程，下面详细了解一下MD5算法的流程，我们可以参考RFC 1321(<a href="http://www.ietf.org/rfc/rfc1321.txt)。" target="_blank" rel="external">http://www.ietf.org/rfc/rfc1321.txt)。</a><br>MD5算法包括四大步骤</p>
<ol>
<li>Append Padding Bits(填充bits)</li>
<li>Append Length(填充长度)</li>
<li>Initialize MD Buffer(初始化向量)</li>
<li>Process Message in 16-Word Blocks(复杂的函数运算)</li>
</ol>
<p>我们主要需要了解前三步，也就是MD5算法中的填充和生成初始化向量。首先，我们看一下MD5中填充bits的算法，该算法的流程如下：</p>
<ol>
<li>根据消息的长度确定填充的字节数，即填充后消息长度 mod 512bit = 448bit。举个例子：一个消息是”message”，则这个消息是56bit，所以需要填充392bit。</li>
<li>最小填充1bit最多填充512bit，即使消息长度 mod 512 = 448bit。也就是说，不管消息长度是多少，都必须进行填充。</li>
<li>填充信息的第一个字节是0x80，剩余数据用0x00填充。</li>
</ol>
<p>然后，我们看一下填充长度的流程：</p>
<ol>
<li>填充长度的大小是64bit</li>
<li>长度是小端存储的，也就是说高字节放在高地址中</li>
<li>如果消息的长度大于2 ^ 64，也就是大于2048PB。那么64bit无法存储消息的长度，则取低64bit。</li>
</ol>
<p>下图是补位的示例，要进行哈希运算的消息是字符串”message”，则：</p>
<p><img src="http://i.imgur.com/uZ6HRrf.png" alt=""></p>
<p>最后，初始化向量为固定值：</p>
<table>
<thead>
<tr>
<th style="text-align:left">ID</th>
<th style="text-align:left">Value</th>
<th style="text-align:left">Vector</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">A</td>
<td style="text-align:left">01  23  45  67</td>
<td style="text-align:left">0x67452301</td>
</tr>
<tr>
<td style="text-align:left">B</td>
<td style="text-align:left">89  AB  CD  EF</td>
<td style="text-align:left">0xEFCDAB89</td>
</tr>
<tr>
<td style="text-align:left">C</td>
<td style="text-align:left">FE  DC  BA  98</td>
<td style="text-align:left">0x98BADCFE</td>
</tr>
<tr>
<td style="text-align:left">D</td>
<td style="text-align:left">76  54  32  10</td>
<td style="text-align:left">0x10325476</td>
</tr>
</tbody>
</table>
<p>然后，用初始化向量和补位后的消息进行复杂的函数运算，最终得到消息”message”的MD5值为78e731027d8fd50ed642340b7c9a63b3。</p>
<h2 id="0x03-理解MD5长度扩展攻击"><a href="#0x03-理解MD5长度扩展攻击" class="headerlink" title="0x03 理解MD5长度扩展攻击"></a>0x03 理解MD5长度扩展攻击</h2><p>如果一个消息长度大于512bit，则会对消息按512bit进行切分，最后一个消息块进行填充操作。</p>
<p>假设我们知道一个7字节也就是56bit的消息的MD5值是78e731027d8fd50ed642340b7c9a63b3。</p>
<p>则MD5算法对其进行运算时，会先补位，由于消息的内容我们不知道，所以补位的结果如下图</p>
<p><img src="http://i.imgur.com/UnMRrvY.png" alt=""></p>
<p>然后会和初始向量进行复杂的函数运算，因为MD5值为78e731027d8fd50ed642340b7c9a63b3，故得到的结果为</p>
<table>
<thead>
<tr>
<th style="text-align:center">Vector</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">A=0x0231e778</td>
</tr>
<tr>
<td style="text-align:center">B=0x0ed58f7d</td>
</tr>
<tr>
<td style="text-align:center">C=0x0b3442d6</td>
</tr>
<tr>
<td style="text-align:center">D=0xb3639a7c</td>
</tr>
</tbody>
</table>
<p>若向补位后的消息再追加一条消息字符串”admin”，则会对这个字符串进行补位，再利用上一个运算算出的值作为初始向量进行函数运算，最终得到的MD5值为e53a681a30ff99e3f6522270ca7db244。</p>
<p>这样就完成了在不知道消息的情况下，计算出消息+填充+追加消息的MD5值。</p>
<p>我们可以验证一下，假设验证用户登录的程序是这样的：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> hashlib</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> unquote</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(password, hash_val)</span>:</span></div><div class="line">    m = hashlib.md5()</div><div class="line">    secret_key = <span class="string">"message"</span></div><div class="line">    m.update(secret_key + password)</div><div class="line">    <span class="keyword">if</span>(m.hexdigest() == hash_val):</div><div class="line">        <span class="keyword">print</span> <span class="string">"Login Successful!"</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">"Login Failed"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    password = unquote(sys.argv[<span class="number">1</span>])</div><div class="line">    hash_val = unquote(sys.argv[<span class="number">2</span>])</div><div class="line">    login(password, hash_val)</div></pre></td></tr></table></figure>
<p>现在只知道一组用户名和hash，root和f3c36e01c874865bc081e4ae7af037ea</p>
<p><img src="http://i.imgur.com/eisLG81.png" alt=""></p>
<p>由分析可知，我们在知道secret_key长度的情况下，可以伪造padding，再通过追加字符串可以算出secret+padding+追加字符串的MD5值。假设我们追加的字符串为admin，则通过哈希扩展攻击计算出md5(secret+padding+追加字符串) = e53a681a30ff99e3f6522270ca7db244。然后我们测试一下，显示登录成功：</p>
<p><img src="http://i.imgur.com/Ppmoqyo.png" alt=""></p>
<p>md5扩展攻击代码如下(网上找的稍作修改，用法：python md5.py 攻击的md5 追加的消息 secret的长度):</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># coding:utf-8    </span></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> struct</div><div class="line"><span class="keyword">import</span> hashlib</div><div class="line"><span class="keyword">import</span> binascii</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">F</span><span class="params">(x, y, z)</span>:</span></div><div class="line">    <span class="keyword">return</span> (x &amp; y) | ((~x) &amp; z)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">G</span><span class="params">(x, y, z)</span>:</span></div><div class="line">    <span class="keyword">return</span> (x &amp; z) | (y &amp; (~z))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">H</span><span class="params">(x, y, z)</span>:</span></div><div class="line">    <span class="keyword">return</span> x ^ y ^ z</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">I</span><span class="params">(x, y, z)</span>:</span></div><div class="line">    <span class="keyword">return</span> y ^ (x | (~z))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_rotateLeft</span><span class="params">( x, n)</span>:</span></div><div class="line">    <span class="keyword">return</span> (x &lt;&lt; n) | (x &gt;&gt; (<span class="number">32</span>-n))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">XX</span><span class="params">(func, a, b, c, d, x, s, ac)</span>:</span></div><div class="line">    res = <span class="number">0L</span></div><div class="line">    res = res + a + func(b, c, d)</div><div class="line">    res = res + x</div><div class="line">    res = res + ac</div><div class="line">    res = res &amp; <span class="number">0xffffffffL</span></div><div class="line">    res = _rotateLeft(res, s)</div><div class="line">    res = res &amp; <span class="number">0xffffffffL</span></div><div class="line">    res = res + b</div><div class="line"></div><div class="line">    <span class="keyword">return</span> res &amp; <span class="number">0xffffffffL</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">md5</span><span class="params">()</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.A, self.B, self.C, self.D = (<span class="number">0x67452301L</span>, <span class="number">0xefcdab89L</span>, <span class="number">0x98badcfeL</span>, <span class="number">0x10325476L</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">md5_compress</span><span class="params">(self, buf)</span>:</span></div><div class="line">        <span class="keyword">if</span> len(buf) != <span class="number">64</span>:</div><div class="line">            <span class="keyword">raise</span> ValueError, <span class="string">"Invalid buffer of length %d: %s"</span> % (len(buf), repr(buf))</div><div class="line">        inp = struct.unpack(<span class="string">"I"</span>*<span class="number">16</span>, buf)</div><div class="line">        a, b, c, d = self.A, self.B, self.C, self.D</div><div class="line"></div><div class="line">        <span class="comment"># Round 1.</span></div><div class="line">        S11, S12, S13, S14 = <span class="number">7</span>, <span class="number">12</span>, <span class="number">17</span>, <span class="number">22</span></div><div class="line"></div><div class="line">        a = XX(F, a, b, c, d, inp[<span class="number">0</span>], S11, <span class="number">0xD76AA478L</span>) <span class="comment"># 1</span></div><div class="line">        d = XX(F, d, a, b, c, inp[<span class="number">1</span>], S12, <span class="number">0xE8C7B756L</span>) <span class="comment"># 2</span></div><div class="line">        c = XX(F, c, d, a, b, inp[<span class="number">2</span>], S13, <span class="number">0x242070DBL</span>) <span class="comment"># 3</span></div><div class="line">        b = XX(F, b, c, d, a, inp[<span class="number">3</span>], S14, <span class="number">0xC1BDCEEEL</span>) <span class="comment"># 4</span></div><div class="line">        a = XX(F, a, b, c, d, inp[<span class="number">4</span>], S11, <span class="number">0xF57C0FAFL</span>) <span class="comment"># 5</span></div><div class="line">        d = XX(F, d, a, b, c, inp[<span class="number">5</span>], S12, <span class="number">0x4787C62AL</span>) <span class="comment"># 6</span></div><div class="line">        c = XX(F, c, d, a, b, inp[<span class="number">6</span>], S13, <span class="number">0xA8304613L</span>) <span class="comment"># 7</span></div><div class="line">        b = XX(F, b, c, d, a, inp[<span class="number">7</span>], S14, <span class="number">0xFD469501L</span>) <span class="comment"># 8</span></div><div class="line">        a = XX(F, a, b, c, d, inp[<span class="number">8</span>], S11, <span class="number">0x698098D8L</span>) <span class="comment"># 9</span></div><div class="line">        d = XX(F, d, a, b, c, inp[<span class="number">9</span>], S12, <span class="number">0x8B44F7AFL</span>) <span class="comment"># 10</span></div><div class="line">        c = XX(F, c, d, a, b, inp[<span class="number">10</span>], S13, <span class="number">0xFFFF5BB1L</span>) <span class="comment"># 11</span></div><div class="line">        b = XX(F, b, c, d, a, inp[<span class="number">11</span>], S14, <span class="number">0x895CD7BEL</span>) <span class="comment"># 12</span></div><div class="line">        a = XX(F, a, b, c, d, inp[<span class="number">12</span>], S11, <span class="number">0x6B901122L</span>) <span class="comment"># 13</span></div><div class="line">        d = XX(F, d, a, b, c, inp[<span class="number">13</span>], S12, <span class="number">0xFD987193L</span>) <span class="comment"># 14</span></div><div class="line">        c = XX(F, c, d, a, b, inp[<span class="number">14</span>], S13, <span class="number">0xA679438EL</span>) <span class="comment"># 15</span></div><div class="line">        b = XX(F, b, c, d, a, inp[<span class="number">15</span>], S14, <span class="number">0x49B40821L</span>) <span class="comment"># 16</span></div><div class="line"></div><div class="line">        <span class="comment"># Round 2.</span></div><div class="line">        S21, S22, S23, S24 = <span class="number">5</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">20</span></div><div class="line"></div><div class="line">        a = XX(G, a, b, c, d, inp[<span class="number">1</span>], S21, <span class="number">0xF61E2562L</span>) <span class="comment"># 17</span></div><div class="line">        d = XX(G, d, a, b, c, inp[<span class="number">6</span>], S22, <span class="number">0xC040B340L</span>) <span class="comment"># 18</span></div><div class="line">        c = XX(G, c, d, a, b, inp[<span class="number">11</span>], S23, <span class="number">0x265E5A51L</span>) <span class="comment"># 19</span></div><div class="line">        b = XX(G, b, c, d, a, inp[<span class="number">0</span>], S24, <span class="number">0xE9B6C7AAL</span>) <span class="comment"># 20</span></div><div class="line">        a = XX(G, a, b, c, d, inp[<span class="number">5</span>], S21, <span class="number">0xD62F105DL</span>) <span class="comment"># 21</span></div><div class="line">        d = XX(G, d, a, b, c, inp[<span class="number">10</span>], S22, <span class="number">0x02441453L</span>) <span class="comment"># 22</span></div><div class="line">        c = XX(G, c, d, a, b, inp[<span class="number">15</span>], S23, <span class="number">0xD8A1E681L</span>) <span class="comment"># 23</span></div><div class="line">        b = XX(G, b, c, d, a, inp[<span class="number">4</span>], S24, <span class="number">0xE7D3FBC8L</span>) <span class="comment"># 24</span></div><div class="line">        a = XX(G, a, b, c, d, inp[<span class="number">9</span>], S21, <span class="number">0x21E1CDE6L</span>) <span class="comment"># 25</span></div><div class="line">        d = XX(G, d, a, b, c, inp[<span class="number">14</span>], S22, <span class="number">0xC33707D6L</span>) <span class="comment"># 26</span></div><div class="line">        c = XX(G, c, d, a, b, inp[<span class="number">3</span>], S23, <span class="number">0xF4D50D87L</span>) <span class="comment"># 27</span></div><div class="line">        b = XX(G, b, c, d, a, inp[<span class="number">8</span>], S24, <span class="number">0x455A14EDL</span>) <span class="comment"># 28</span></div><div class="line">        a = XX(G, a, b, c, d, inp[<span class="number">13</span>], S21, <span class="number">0xA9E3E905L</span>) <span class="comment"># 29</span></div><div class="line">        d = XX(G, d, a, b, c, inp[<span class="number">2</span>], S22, <span class="number">0xFCEFA3F8L</span>) <span class="comment"># 30</span></div><div class="line">        c = XX(G, c, d, a, b, inp[<span class="number">7</span>], S23, <span class="number">0x676F02D9L</span>) <span class="comment"># 31</span></div><div class="line">        b = XX(G, b, c, d, a, inp[<span class="number">12</span>], S24, <span class="number">0x8D2A4C8AL</span>) <span class="comment"># 32</span></div><div class="line"></div><div class="line">        <span class="comment"># Round 3.</span></div><div class="line">        S31, S32, S33, S34 = <span class="number">4</span>, <span class="number">11</span>, <span class="number">16</span>, <span class="number">23</span></div><div class="line"></div><div class="line">        a = XX(H, a, b, c, d, inp[<span class="number">5</span>], S31, <span class="number">0xFFFA3942L</span>) <span class="comment"># 33</span></div><div class="line">        d = XX(H, d, a, b, c, inp[<span class="number">8</span>], S32, <span class="number">0x8771F681L</span>) <span class="comment"># 34</span></div><div class="line">        c = XX(H, c, d, a, b, inp[<span class="number">11</span>], S33, <span class="number">0x6D9D6122L</span>) <span class="comment"># 35</span></div><div class="line">        b = XX(H, b, c, d, a, inp[<span class="number">14</span>], S34, <span class="number">0xFDE5380CL</span>) <span class="comment"># 36</span></div><div class="line">        a = XX(H, a, b, c, d, inp[<span class="number">1</span>], S31, <span class="number">0xA4BEEA44L</span>) <span class="comment"># 37</span></div><div class="line">        d = XX(H, d, a, b, c, inp[<span class="number">4</span>], S32, <span class="number">0x4BDECFA9L</span>) <span class="comment"># 38</span></div><div class="line">        c = XX(H, c, d, a, b, inp[<span class="number">7</span>], S33, <span class="number">0xF6BB4B60L</span>) <span class="comment"># 39</span></div><div class="line">        b = XX(H, b, c, d, a, inp[<span class="number">10</span>], S34, <span class="number">0xBEBFBC70L</span>) <span class="comment"># 40</span></div><div class="line">        a = XX(H, a, b, c, d, inp[<span class="number">13</span>], S31, <span class="number">0x289B7EC6L</span>) <span class="comment"># 41</span></div><div class="line">        d = XX(H, d, a, b, c, inp[<span class="number">0</span>], S32, <span class="number">0xEAA127FAL</span>) <span class="comment"># 42</span></div><div class="line">        c = XX(H, c, d, a, b, inp[<span class="number">3</span>], S33, <span class="number">0xD4EF3085L</span>) <span class="comment"># 43</span></div><div class="line">        b = XX(H, b, c, d, a, inp[<span class="number">6</span>], S34, <span class="number">0x04881D05L</span>) <span class="comment"># 44</span></div><div class="line">        a = XX(H, a, b, c, d, inp[<span class="number">9</span>], S31, <span class="number">0xD9D4D039L</span>) <span class="comment"># 45</span></div><div class="line">        d = XX(H, d, a, b, c, inp[<span class="number">12</span>], S32, <span class="number">0xE6DB99E5L</span>) <span class="comment"># 46</span></div><div class="line">        c = XX(H, c, d, a, b, inp[<span class="number">15</span>], S33, <span class="number">0x1FA27CF8L</span>) <span class="comment"># 47</span></div><div class="line">        b = XX(H, b, c, d, a, inp[<span class="number">2</span>], S34, <span class="number">0xC4AC5665L</span>) <span class="comment"># 48</span></div><div class="line"></div><div class="line">        <span class="comment"># Round 4.</span></div><div class="line">        S41, S42, S43, S44 = <span class="number">6</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">21</span></div><div class="line"></div><div class="line">        a = XX(I, a, b, c, d, inp[<span class="number">0</span>], S41, <span class="number">0xF4292244L</span>) <span class="comment"># 49</span></div><div class="line">        d = XX(I, d, a, b, c, inp[<span class="number">7</span>], S42, <span class="number">0x432AFF97L</span>) <span class="comment"># 50</span></div><div class="line">        c = XX(I, c, d, a, b, inp[<span class="number">14</span>], S43, <span class="number">0xAB9423A7L</span>) <span class="comment"># 51</span></div><div class="line">        b = XX(I, b, c, d, a, inp[<span class="number">5</span>], S44, <span class="number">0xFC93A039L</span>) <span class="comment"># 52</span></div><div class="line">        a = XX(I, a, b, c, d, inp[<span class="number">12</span>], S41, <span class="number">0x655B59C3L</span>) <span class="comment"># 53</span></div><div class="line">        d = XX(I, d, a, b, c, inp[<span class="number">3</span>], S42, <span class="number">0x8F0CCC92L</span>) <span class="comment"># 54</span></div><div class="line">        c = XX(I, c, d, a, b, inp[<span class="number">10</span>], S43, <span class="number">0xFFEFF47DL</span>) <span class="comment"># 55</span></div><div class="line">        b = XX(I, b, c, d, a, inp[<span class="number">1</span>], S44, <span class="number">0x85845DD1L</span>) <span class="comment"># 56</span></div><div class="line">        a = XX(I, a, b, c, d, inp[<span class="number">8</span>], S41, <span class="number">0x6FA87E4FL</span>) <span class="comment"># 57</span></div><div class="line">        d = XX(I, d, a, b, c, inp[<span class="number">15</span>], S42, <span class="number">0xFE2CE6E0L</span>) <span class="comment"># 58</span></div><div class="line">        c = XX(I, c, d, a, b, inp[<span class="number">6</span>], S43, <span class="number">0xA3014314L</span>) <span class="comment"># 59</span></div><div class="line">        b = XX(I, b, c, d, a, inp[<span class="number">13</span>], S44, <span class="number">0x4E0811A1L</span>) <span class="comment"># 60</span></div><div class="line">        a = XX(I, a, b, c, d, inp[<span class="number">4</span>], S41, <span class="number">0xF7537E82L</span>) <span class="comment"># 61</span></div><div class="line">        d = XX(I, d, a, b, c, inp[<span class="number">11</span>], S42, <span class="number">0xBD3AF235L</span>) <span class="comment"># 62</span></div><div class="line">        c = XX(I, c, d, a, b, inp[<span class="number">2</span>], S43, <span class="number">0x2AD7D2BBL</span>) <span class="comment"># 63</span></div><div class="line">        b = XX(I, b, c, d, a, inp[<span class="number">9</span>], S44, <span class="number">0xEB86D391L</span>) <span class="comment"># 64</span></div><div class="line"></div><div class="line">        self.A = (self.A + a) &amp; <span class="number">0xffffffffL</span></div><div class="line">        self.B = (self.B + b) &amp; <span class="number">0xffffffffL</span></div><div class="line">        self.C = (self.C + c) &amp; <span class="number">0xffffffffL</span></div><div class="line">        self.D = (self.D + d) &amp; <span class="number">0xffffffffL</span></div><div class="line">        <span class="comment"># print 'A=%s\nB=%s\nC=%s\nD=%s\n' % (hex(self.A), hex(self.B), hex(self.C), hex(self.D))</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">padding</span><span class="params">(self, n, sz=None)</span>:</span></div><div class="line">        <span class="keyword">if</span> sz <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            sz = n</div><div class="line">        pre = <span class="number">64</span><span class="number">-8</span></div><div class="line">        sz = struct.pack(<span class="string">"Q"</span>,sz*<span class="number">8</span>)</div><div class="line">        pad = <span class="string">'\x80'</span></div><div class="line">        n += <span class="number">1</span></div><div class="line">        <span class="keyword">if</span> n % <span class="number">64</span> &lt;= pre:</div><div class="line">            pad += <span class="string">'\x00'</span> * (pre - n % <span class="number">64</span>)</div><div class="line">            pad += sz</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            pad += <span class="string">'\x00'</span> * (pre + <span class="number">64</span> - n % <span class="number">64</span>)</div><div class="line">            pad += sz</div><div class="line">        <span class="keyword">return</span> pad</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pad</span><span class="params">(self, msg)</span>:</span></div><div class="line">        <span class="keyword">return</span> msg + self.padding(len(msg))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">md5_iter</span><span class="params">(self, padding_msg)</span>:</span></div><div class="line">        <span class="keyword">assert</span> len(padding_msg) % <span class="number">64</span> == <span class="number">0</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(padding_msg), <span class="number">64</span>):</div><div class="line">            block = padding_msg[i:i+<span class="number">64</span>]</div><div class="line">            self.md5_compress(padding_msg[i:i+<span class="number">64</span>])</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">digest</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> struct.pack(<span class="string">'&lt;IIII'</span>, self.A, self.B, self.C, self.D)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hexdigest</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> binascii.hexlify(self.digest()).decode()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_md5</span><span class="params">(self, msg)</span>:</span></div><div class="line">        padding_msg = self.pad(msg)</div><div class="line">        self.md5_iter(padding_msg)</div><div class="line">        <span class="keyword">return</span> self.hexdigest()</div><div class="line"></div><div class="line">    <span class="comment"># 通过md5值，逆向算出最后一轮的magic number</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">compute_magic_number</span><span class="params">(self, md5str)</span>:</span></div><div class="line">        self.A = struct.unpack(<span class="string">"I"</span>, md5str[<span class="number">0</span>:<span class="number">8</span>].decode(<span class="string">'hex'</span>))[<span class="number">0</span>]</div><div class="line">        self.B = struct.unpack(<span class="string">"I"</span>, md5str[<span class="number">8</span>:<span class="number">16</span>].decode(<span class="string">'hex'</span>))[<span class="number">0</span>]</div><div class="line">        self.C = struct.unpack(<span class="string">"I"</span>, md5str[<span class="number">16</span>:<span class="number">24</span>].decode(<span class="string">'hex'</span>))[<span class="number">0</span>]</div><div class="line">        self.D = struct.unpack(<span class="string">"I"</span>, md5str[<span class="number">24</span>:<span class="number">32</span>].decode(<span class="string">'hex'</span>))[<span class="number">0</span>]</div><div class="line">        <span class="comment">#print 'A=%s\nB=%s\nC=%s\nD=%s\n' % (hex(self.A), hex(self.B), hex(self.C), hex(self.D))</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">extension_attack</span><span class="params">(self, md5str, str_append, lenth)</span>:</span></div><div class="line">        self.compute_magic_number(md5str)</div><div class="line">        p = self.padding(lenth)</div><div class="line">        padding_msg = self.padding( len(str_append), lenth + len(p) + len(str_append) )</div><div class="line">        self.md5_iter(str_append + padding_msg)</div><div class="line">        <span class="keyword">return</span> self.hexdigest()</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    m = md5()</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">4</span>:</div><div class="line">    <span class="comment">#print m.my_md5("123456")</span></div><div class="line">        src = m.pad(sys.argv[<span class="number">1</span>]) + sys.argv[<span class="number">2</span>]</div><div class="line">        <span class="keyword">print</span> <span class="string">'md5 padding          -&gt;'</span>,m.my_md5(src)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'md5 extension_attack -&gt;'</span>,m.extension_attack(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>], int(sys.argv[<span class="number">3</span>]))</div></pre></td></tr></table></figure>
<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>这个攻击方式的原理是，知道一个密文的md5和密文的长度，可以推算出密文与扩展消息拼接后的md5。防范方法也很简单：<br>方法1：用HMAC算法 HMAC(secret||padding)=H(secret||H(secret||padding))<br>方法2：交换secret和padding的位置，即MAC(padding||secret)</p>
<p>通常md5可以作为签名来用，曾经有两个漏洞，亚马逊AWS和Flicker的签名漏洞，均可以通过md5哈希长度扩展攻击。最近也有一个phpwind的洞可用哈希长度扩展攻击。</p>
<p>不过现在这个攻击方式的发展趋势应该是活在CTF中了233333</p>
<h2 id="0x05-引用"><a href="#0x05-引用" class="headerlink" title="0x05 引用"></a>0x05 引用</h2><p><a href="http://www.ietf.org/rfc/rfc1321.txt" target="_blank" rel="external">http://www.ietf.org/rfc/rfc1321.txt</a><br><a href="http://blog.chinaunix.net/uid-27070210-id-3255947.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-27070210-id-3255947.html</a></p>

      
    </div>
    <footer>
      
        
          <p style="border-top: #e0e0e0 1px dashed; border-right: #e0e0e0 1px dashed; border-bottom: #e0e0e0 1px dashed; border-left: #e0e0e0 1px dashed; padding-top: 10px;padding-right: 10px;padding-bottom: 10px;padding-left: 110px; background: url(http://i.creativecommons.org/l/by-nc-sa/2.5/cn/88x31.png) #e5f1f4 no-repeat 1% 50%; font-family: 微软雅黑; font-size:11px;" id="PSignature">  
作者：<a href="http://weaponx.site">WeaponX</a>
<br>出处：<a href="http://weaponx.site/2017/01/16/哈希长度扩展攻击/">http://weaponx.site/2017/01/16/哈希长度扩展攻击/</a>           
<br>本文采用<a href="http://creativecommons.org/licenses/by-nc-sa/2.5/cn/" rel="license">知识共享署名-非商业性使用-相同方式共享 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接。
</p>

        
        
  
  <div class="categories">
    <a href="/categories/tech/">技术</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/安全/">安全</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:weaponx.site">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/安全/">安全</a><small>1</small></li>
  
    <li><a href="/categories/tech/">技术</a><small>16</small></li>
  
    <li><a href="/categories/life/">生活</a><small>2</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/ASLR/">ASLR</a><small>1</small></li>
  
    <li><a href="/tags/Django/">Django</a><small>1</small></li>
  
    <li><a href="/tags/Hexo/">Hexo</a><small>4</small></li>
  
    <li><a href="/tags/UAF/">UAF</a><small>2</small></li>
  
    <li><a href="/tags/pwn/">pwn</a><small>8</small></li>
  
    <li><a href="/tags/python/">python</a><small>1</small></li>
  
    <li><a href="/tags/博客/">博客</a><small>3</small></li>
  
    <li><a href="/tags/安全/">安全</a><small>12</small></li>
  
    <li><a href="/tags/影评/">影评</a><small>1</small></li>
  
    <li><a href="/tags/整形溢出/">整形溢出</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">友情链接</h3>
  <ul class="entry">
  
    <li><a href="http://www.cnblogs.com/goabout2/" title="goabout2">goabout2</a></li>
  
    <li><a href="http://rootkiter.com/" title="RootKiter">RootKiter</a></li>
  
  </ul>
</div>



  <div class="widget tag">
  <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=270 height=86 src="//music.163.com/outchain/player?type=2&id=427542287&auto=0&height=66"></iframe>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 WeaponX
  
</div>
<div class="clearfix"></div></footer>
  <script src="http://apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'weaponx';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
</html>
