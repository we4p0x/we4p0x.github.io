<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description" content="Vulnerability|Security|Binary"/><title>一种绕过TACACS+的思路 | WeaponX's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/highlight.css"/><link rel="stylesheet" type="text/css" href="/css/font.css"/><link rel="stylesheet" type="text/css" href="/css/noise.css"/><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/安全/">安全</a></div><div class="post-time">2017-02-08</div></div></div><div class="container post-header"><h1>一种绕过TACACS+的思路</h1></div><div class="container post-content"><p>最近对一些交换机做口令猜测检查的时候遇到一个奇怪的现象：配置AAA认证的交换机总能扫出一些弱口令，而且每次都不一样还都不能登录，更神奇的是返回的session确实能执行命令。</p>
<a id="more"></a>
<h2 id="0x00-什么是AAA认证"><a href="#0x00-什么是AAA认证" class="headerlink" title="0x00 什么是AAA认证"></a>0x00 什么是AAA认证</h2><p>AAA是指用使用<em>Authentication</em>、<em>Authorization</em>、<em>Accounting</em>三种功能对要管理交换机的用户做控制。<br>Authentication(认证)：对用户的身份进行认证，决定是否允许此用户访问网络设备。Authorization（授权）:针对用户的不同身份，分配不同的权限，限制每个用户的操作Accounting（计费）：对每个用户的操作进行审计和计费</p>
<h2 id="0x01-什么是TACACS"><a href="#0x01-什么是TACACS" class="headerlink" title="0x01 什么是TACACS+"></a>0x01 什么是TACACS+</h2><p>TACACS+（Terminal Access Controller Access Control System，终端访问控制器控制系统协议）是在TACACS协议的基础上进行了功能增强的安全协议。该协议与RADIUS协议的功能类似，采用客户端/服务器模式实现NAS与TACACS+服务器之间的通信。</p>
<h2 id="0x02-TACACS-的用途"><a href="#0x02-TACACS-的用途" class="headerlink" title="0x02 TACACS+的用途"></a>0x02 TACACS+的用途</h2><p>TACACS+协议主要用于PPP和VPDN（Virtual Private Dial-up Network，虚拟私有拨号网络）接入用户及终端用户的AAA。</p>
<h2 id="0x03-排查过程"><a href="#0x03-排查过程" class="headerlink" title="0x03 排查过程"></a>0x03 排查过程</h2><p>说白了，AAA认证是一种集中认证的模式。所有的认证都是在AAA服务器上完成的，交换机只能得到认证结果。猜测可能是AAA认证服务器出问题了，不过不太了解AAA认证服务器。看了同事发的一篇文章(<a href="http://www.vuln.cn/7043" title="绕过 Cisco TACACS+ 的三种攻击方式" target="_blank" rel="external">http://www.vuln.cn/7043</a>)。</p>
<p>然后看了下交换机的配置文件，找AAA认证相关的配置。发现了以下配置。</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><div class="line">aaa authentication login default <span class="keyword">group</span> <span class="title">tacacs</span>+ local line none</div></pre></td></tr></table></figure>
<p>网上搜了一下，这个配置的意思就是AAA认证使用TACACS+完成。当AAA认证<strong>无法认证</strong>时使用local认证，当前面都<strong>无法认证</strong>则不需要认证（注意，不是认证失败，是无法认证。因为认证失败的话会直接返回）即可登录。</p>
<p>现在原因已经比较清晰了，多线程口令猜测导致AAA认证服务器压力过大拒绝服务，然而本机交换机也因处理认证线程过多拒绝服务。导致最终无需认证登录交换机。</p>
<h2 id="0x04-攻击方式"><a href="#0x04-攻击方式" class="headerlink" title="0x04 攻击方式"></a>0x04 攻击方式</h2><p>这种攻击方式也很简单，只需要向服务器发起大量请求认证的线程即可使AAA服务器拒绝服务，导致无需认证登录交换机。</p>
<h2 id="0x05-缓解方法"><a href="#0x05-缓解方法" class="headerlink" title="0x05 缓解方法"></a>0x05 缓解方法</h2><p>要防止这种情况发生只需要改成如下语句即可。</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><div class="line">aaa authentication login default <span class="keyword">group</span> <span class="title">tacacs</span>+ local</div></pre></td></tr></table></figure>
<p>意思就是，在AAA认证无法完成的情况下，使用交换机本地认证，而不是不认证直接返回命令行。</p>
<h2 id="0x06-题外话"><a href="#0x06-题外话" class="headerlink" title="0x06 题外话"></a>0x06 题外话</h2><p>在搜索这个问题的时候在一个cisco工程实施人员的论坛中看到这样一段话，“老司机”在给新手传授“经验”</p>
<blockquote>
<p><code>aaa authentication login default group tacacs+ line none</code><br>这句话的意思是先使用 tacacs+认证；如果失败，则使用line认证，如果还失败，就不需要认证，这就相当于是AAA的一个后门，怕在AAA配置中把自己锁在里面出不来了，一般配AAA前先做后门，然后在配AAA。这个是实际工程中常见的一个后门，记住，做AAA一定要有后门，不然把自己锁里面就麻烦了！</p>
</blockquote>
<h2 id="0x07-Refer"><a href="#0x07-Refer" class="headerlink" title="0x07 Refer"></a>0x07 Refer</h2><p><a href="http://www.vuln.cn/7043" target="_blank" rel="external">http://www.vuln.cn/7043</a><br><a href="http://edwinzw.blog.sohu.com/67531824.html" target="_blank" rel="external">http://edwinzw.blog.sohu.com/67531824.html</a><br><a href="http://www.h3c.com.cn/MiniSite/Technology_Circle/Net_Reptile/The_Seven/Home/Catalog/201309/797633_97665_0.htm" target="_blank" rel="external">http://www.h3c.com.cn/MiniSite/Technology_Circle/Net_Reptile/The_Seven/Home/Catalog/201309/797633_97665_0.htm</a></p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"/><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>